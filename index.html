<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gift Upgrade</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --app-accent-blue: #5288c1;
            
            --app-modal-backdrop-color: rgba(0,0,0,0.8);
            --app-rarity-chip-bg: rgba(0,0,0,0.2);
            --app-profile-gradient-fallback: var(--tg-theme-secondary-bg-color);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            font-size: 16px;
            overflow-x: hidden;
            user-select: none;
        }

        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; }
        .page { display: none; flex-direction: column; flex-grow: 1; background-color: var(--tg-theme-bg-color); }
        .page.active { display: flex; }

        .page-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 15px; background-color: var(--tg-theme-secondary-bg-color);
            min-height: 56px; position: sticky; top: 0; z-index: 10;
        }
        .page-header h2 { font-size: 1.15em; font-weight: 500; margin: 0; }
        
        .profile-top-section {
            padding-top: 30px; padding-bottom: 20px;
            background: var(--app-profile-gradient-fallback);
            display: flex; justify-content: center; position: relative;
            transition: background 0.5s ease;
        }
        
        #profile-pattern-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden; pointer-events: none; opacity: 0.15;
        }
        
        .profile-pattern-item {
            position: absolute; width: 30px; height: 30px;
            left: 50%; top: 50%; /* Center anchor */
            background-color: currentColor; 
            -webkit-mask-size: contain; mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
        }

        .profile-main-info { display: flex; flex-direction: column; align-items: center; z-index: 2; position: relative; }
        .profile-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            background-color: var(--tg-theme-hint-color); margin-bottom: 12px;
            object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .profile-name-status h1 { font-size: 1.4em; font-weight: 700; text-align: center; margin: 0 0 4px 0; text-transform: uppercase; letter-spacing: 0.5px; }
        .profile-name-status p { font-size: 0.9em; opacity: 0.7; text-align: center; margin: 0; color: var(--tg-theme-text-color); }

        /* Telegram-style Info Block */
        .profile-info-block { padding: 20px 20px; background-color: var(--tg-theme-bg-color); }
        .profile-info-header { color: var(--tg-theme-link-color); font-weight: 500; font-size: 0.95em; margin-bottom: 15px; }
        .info-item { margin-bottom: 18px; cursor: default; }
        .info-item .value { color: var(--tg-theme-text-color); font-size: 1.1em; display: block; margin-bottom: 2px; line-height: 1.2;}
        .info-item .label { color: var(--tg-theme-hint-color); font-size: 0.85em; }
        .info-item .clickable { cursor: pointer; }

        .profile-tabs { display: flex; justify-content: space-around; background-color: var(--tg-theme-bg-color); border-bottom: 1px solid #000; }
        .profile-tabs button {
            background: none; border: none; color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 0.95em; cursor: pointer; flex-grow: 1;
            font-weight: 500; border-bottom: 2px solid transparent; text-transform: uppercase;
        }
        .profile-tabs button.active { color: var(--tg-theme-link-color); border-bottom-color: var(--tg-theme-link-color); }

        .gifts-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 12px;
            flex-grow: 1; overflow-y: auto; align-content: start; background: #000;
        }
        
        .gift-card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 12px; padding: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            aspect-ratio: 1 / 1; 
            cursor: pointer; position: relative; overflow: hidden;
            transition: transform 0.1s ease-out; border: none; 
        }
        /* Selection Highlight */
        .gift-card.selected { box-shadow: inset 0 0 0 3px var(--tg-theme-link-color); background-color: rgba(98, 188, 249, 0.15); }

        /* Taller shop card for text visibility */
        .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 12px; padding: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            aspect-ratio: 1 / 1.35; 
            cursor: pointer; position: relative; overflow: hidden;
            transition: transform 0.1s ease-out;
        }

        .gift-card:active, .buy-gift-item:active { transform: scale(0.97); }
        
        .status-icon {
            position: absolute; top: 6px; left: 6px; z-index: 5;
            width: 14px; height: 14px; display: flex; align-items: center; justify-content: center;
        }
        .status-icon svg { fill: #fff; width: 100%; height: 100%; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.8)); }

        .gift-card.is-hidden { opacity: 0.4; filter: grayscale(1); }

        .image-container {
            width: 75%; height: 75%; display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 2; margin-bottom: 0px; 
        }
        .buy-gift-item .image-container { height: 55%; margin-bottom: 4px; margin-top: 8px; }

        .image-container img, .image-container .lottie-wrapper { max-width: 100%; max-height: 100%; object-fit: contain; }
        .lottie-wrapper { width: 100%; height: 100%; }
        
        .gift-name { font-size: 0.85em; font-weight: 500; text-align: center; margin-top: 4px; z-index: 2; width: 100%; line-height: 1.2; padding: 0 2px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .gift-price { font-size: 0.8em; color: var(--tg-theme-hint-color); margin: 4px 0 8px; font-weight: bold; z-index: 2;}

        .gift-card-bg-pattern { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }
        .dynamic-pattern-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1; overflow: hidden; pointer-events: none; }
        .card-pattern-symbol { 
            position: absolute; width: 30px; height: 30px;
            left: 50%; top: 50%;
            background-color: currentColor; 
            -webkit-mask-size: contain; mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
            opacity: 0.15;
        }
        .top-right-label {
            position: absolute; top: 12px; right: -32px; transform: rotate(45deg);
            background: rgba(0,0,0,0.6); color: white; font-size: 0.6em;
            padding: 2px 35px; z-index: 4; font-weight: 600; letter-spacing: 0.5px;
        }

        .action-button {
            background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
            border: none; padding: 6px 14px; border-radius: 16px; font-size: 0.9em; cursor: pointer; font-weight: 500;
        }
        #action-toolbar {
            padding: 10px 15px; display: flex; justify-content: flex-end; gap: 10px;
            background-color: var(--tg-theme-bg-color);
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: 0.2s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            border-top-left-radius: 14px; border-top-right-radius: 14px;
            width: 100%; max-width: 600px; display: flex; flex-direction: column; overflow: hidden;
            max-height: 90vh;
        }
        #customize-modal .modal-content { height: 90vh; }

        .modal-header-bar { padding: 16px; text-align: center; font-weight: 600; font-size: 1.1em; background: var(--tg-theme-secondary-bg-color); position: relative; z-index: 10; }
        .modal-scrollable-content { overflow-y: auto; padding: 0; flex-grow: 1; }
        .modal-buttons-footer { padding: 15px; display: flex; gap: 10px; background: var(--tg-theme-secondary-bg-color); }
        .modal-button {
            flex: 1; padding: 12px; border-radius: 10px; border: none; font-size: 1em; font-weight: 600; cursor: pointer;
            background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
        }
        .modal-button.secondary { background-color: var(--tg-theme-bg-color); color: var(--tg-theme-link-color); }
        
        .info-row { display: flex; justify-content: space-between; padding: 14px 20px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .info-label { color: var(--tg-theme-hint-color); }
        .rarity-chip { background: var(--app-rarity-chip-bg); padding: 3px 8px; border-radius: 6px; font-size: 0.8em; margin-left: 6px; }

        .collectible-display-area {
            position: relative; padding: 50px 0; text-align: center; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .collectible-display-area h3 { margin-top: 15px; position: relative; z-index: 2; font-size: 1.6em; margin-bottom: 4px; }
        .collectible-display-area p { color: rgba(255,255,255,0.7); position: relative; z-index: 2; margin-top: 0; font-size: 0.95em; }

        /* Menu */
        #long-press-menu {
            position: fixed; background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 2000; min-width: 200px; padding: 6px 0; overflow: hidden;
        }
        #long-press-menu li { padding: 14px 20px; list-style: none; cursor: pointer; color: var(--tg-theme-text-color); font-size: 1em; font-weight: 500; display:flex; align-items:center; gap: 10px; }
        #long-press-menu li:hover { background: rgba(255,255,255,0.05); }
        #long-press-menu li.danger { color: #ff595a; }

        /* Queue Bar */
        .queue-bar { display: flex; overflow-x: auto; padding: 12px 15px; gap: 8px; background: var(--tg-theme-bg-color); white-space: nowrap; scrollbar-width: none; }
        .queue-bar::-webkit-scrollbar { display: none; }
        .queue-chip { 
            padding: 8px 14px; background: var(--tg-theme-secondary-bg-color); border-radius: 20px; font-size: 0.9em; cursor: pointer; border: 1px solid transparent; 
            display: flex; align-items: center; gap: 8px; font-weight: 500;
        }
        .queue-chip.active { border-color: var(--tg-theme-link-color); background: rgba(98, 188, 249, 0.1); color: var(--tg-theme-link-color); }
        .queue-chip .close-x { opacity: 0.6; font-size: 1.2em; font-weight: 300; }
        .add-gift-chip { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }

        .filter-section { padding: 0 15px; margin-bottom: 20px; }
        .filter-section h4 { margin: 15px 0 8px; color: var(--tg-theme-hint-color); font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; padding-left: 4px; }
        
        .filter-options-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; 
            overflow-y: auto; padding: 4px; max-height: 220px; border-radius: 8px;
        }
        .filter-option {
            background: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 10px;
            cursor: pointer; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100px;
        }
        .filter-option.selected { border-color: var(--tg-theme-link-color); background: rgba(98, 188, 249, 0.05); }
        .filter-option img { width: 55px; height: 55px; object-fit: contain; margin-bottom: 5px; }
        .filter-option .label { font-size: 0.75em; text-align: center; overflow: hidden; white-space: nowrap; width: 100%; text-overflow: ellipsis;}
        .gradient-square { width: 55px; height: 55px; border-radius: 50%; margin-bottom: 5px; }

        .switch-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.1); font-weight: 500; }
        .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--tg-theme-hint-color); transition: .4s; border-radius: 34px; opacity: 0.3; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--tg-theme-button-color); opacity: 1; }
        input:checked + .slider:before { transform: translateX(20px); }

        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--tg-theme-link-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .reordering .gift-card { opacity: 0.5; }
        .reordering .gift-card[data-pinned="true"] { opacity: 1; cursor: grab; box-shadow: 0 0 0 2px var(--tg-theme-link-color); }
        
        #qty-modal input { background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); border: none; padding: 12px; border-radius: 12px; width: 100%; font-size: 1.4em; text-align: center; margin-bottom: 15px; outline: none; font-weight: bold; }

        /* Loading */
        .glass-panel { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; animation: glassFloat 4s ease-in-out infinite; }
        .liquid-blob { position: absolute; border-radius: 50%; filter: blur(50px); opacity: 0.5; z-index: 1; animation: blobFloat 10s infinite alternate; }
        .blob-1 { width: 200px; height: 200px; background: #007AFF; top: 20%; left: 15%; }
        .blob-2 { width: 250px; height: 250px; background: #5ac8fa; bottom: 20%; right: 10%; animation-delay: -2s; }
        @keyframes blobFloat { 0% { transform: translate(0, 0) scale(1); } 50% { transform: translate(20px, -20px) scale(1.1); } 100% { transform: translate(-20px, 20px) scale(0.9); } }
        @keyframes glassFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body>

<div id="loading-overlay" class="modal-overlay active" style="align-items: center; justify-content: center; background: var(--tg-theme-bg-color); z-index: 9999;">
    <div class="liquid-blob blob-1"></div>
    <div class="liquid-blob blob-2"></div>
    <div class="glass-panel">
        <div id="loading-anim" style="width: 100px; height: 100px;"></div>
        <h2 style="font-weight:700; margin-top:15px; color:var(--tg-theme-text-color);">Gift Simulator</h2>
    </div>
</div>

<div class="app-container">
    <div id="profile-page" class="page">
        <div class="page-header">
            <h2>Profile</h2>
            <div><button class="action-button" onclick="openSettingsModal()">Settings</button></div>
        </div>
        <div class="profile-top-section" id="profile-bg">
            <div id="profile-pattern-overlay"></div>
            <div class="profile-main-info">
                <img src="" class="profile-avatar" id="user-avatar">
                <div class="profile-name-status">
                    <h1 id="user-name">Loading...</h1>
                    <p id="gift-count-display">0 gifts</p>
                </div>
            </div>
        </div>
        
        <div class="profile-info-block">
            <div class="profile-info-header">Info</div>
            <div class="info-item">
                <span class="value" id="profile-phone">+888 0000 0000</span>
                <span class="label">Mobile</span>
            </div>
            <div class="info-item clickable" onclick="editBio()">
                <span class="value" id="profile-bio">Hello world</span>
                <span class="label">Bio</span>
            </div>
            <div class="info-item">
                <span class="value" id="profile-username">@username</span>
                <span class="label">Username</span>
            </div>
        </div>

        <div class="profile-tabs">
            <button class="active" onclick="switchTab('inventory')">Inventory</button>
            <button onclick="switchTab('shop')">Gift Shop</button>
        </div>
        
        <div id="action-toolbar" class="hidden"></div>
        <div class="gifts-grid" id="inventory-grid"></div>
    </div>

    <div id="shop-page" class="page">
        <div class="page-header">
            <h2>Gift Shop</h2>
            <button class="action-button" onclick="openCustomizeModal()">Customize</button>
        </div>
        <div class="gifts-grid" id="shop-grid">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar">Settings</div>
        <div class="modal-scrollable-content">
            <div class="switch-row">
                <span>Animations (Lottie)</span>
                <label class="switch">
                    <input type="checkbox" id="setting-animations" onchange="toggleSetting('animations', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-row">
                <span>Show Hidden Gifts</span>
                <label class="switch">
                    <input type="checkbox" id="setting-hidden" onchange="toggleSetting('showHidden', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div style="padding: 20px; display: flex; flex-direction: column; gap: 10px;">
                <button class="modal-button" style="width:100%; background: var(--app-accent-blue);" onclick="startSelectionMode('hide')">Select & Hide Multiple</button>
                <button class="modal-button secondary" style="width:100%; color: #ff595a;" onclick="resetAppData()">Reset All Data</button>
            </div>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" onclick="closeModal('settings-modal')">Close</button>
        </div>
    </div>
</div>

<div id="qty-modal" class="modal-overlay">
    <div class="modal-content" style="max-height: auto;">
        <div class="modal-header-bar">Buy Multiple</div>
        <div class="modal-scrollable-content" style="padding: 20px;">
            <p style="margin-bottom: 10px; color: var(--tg-theme-hint-color);">Enter quantity:</p>
            <input type="number" id="qty-input" value="1" min="1" max="1000">
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" onclick="handleBuyMultiple()">Buy</button>
            <button class="modal-button secondary" onclick="closeModal('qty-modal')">Cancel</button>
        </div>
    </div>
</div>

<div id="detail-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar"><span id="detail-title">Gift</span></div>
        <div class="modal-scrollable-content" style="padding: 20px; text-align: center;">
            <div class="image-container" style="width: 160px; height: 160px; margin: 0 auto;">
                <img id="detail-image" src="" style="display:none;">
                <div id="detail-lottie" class="lottie-wrapper"></div>
            </div>
            <p style="color: var(--tg-theme-hint-color); margin-top: 15px; line-height: 1.5;" id="detail-desc">
                This is a regular gift. Upgrade it to make it a unique collectible!
            </p>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" id="btn-upgrade" onclick="handleUpgrade()">✨ Upgrade (Free)</button>
            <button class="modal-button secondary" onclick="closeModal('detail-modal')">Close</button>
        </div>
    </div>
</div>

<div id="collectible-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-scrollable-content" style="padding: 0;">
            <div id="collectible-display-area" class="collectible-display-area">
                <div id="collectible-pattern-container" class="dynamic-pattern-container"></div>
                <div style="position: relative; z-index: 2; width: 100%; display: flex; flex-direction: column; align-items: center;">
                    <div style="width: 180px; height: 180px; display:flex; align-items:center; justify-content:center;">
                        <img id="collectible-image" src="" style="max-width: 100%; max-height: 100%; object-fit: contain; display:none;">
                        <div id="collectible-lottie" class="lottie-wrapper"></div>
                    </div>
                    <h3 id="collectible-name">Name</h3>
                    <p>Collectible #<span id="collectible-number"></span></p>
                </div>
            </div>
            <div style="background: var(--tg-theme-secondary-bg-color);">
                <div class="info-row"><span class="info-label">Model</span><span class="info-value" id="info-model"></span></div>
                <div class="info-row"><span class="info-label">Backdrop</span><span class="info-value" id="info-backdrop"></span></div>
                <div class="info-row"><span class="info-label">Symbol</span><span class="info-value" id="info-pattern"></span></div>
            </div>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button secondary" onclick="closeModal('collectible-modal')">Close</button>
        </div>
    </div>
</div>

<div id="customize-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar">Customize</div>
        <!-- Scrollable list of gifts being configured -->
        <div class="queue-bar" id="cust-queue-bar"></div>

        <div class="modal-scrollable-content" style="padding: 0; background: var(--tg-theme-secondary-bg-color);">
            <div class="filter-section">
                <h4>Select Base Gift</h4>
                <div class="filter-options-grid" id="cust-base-grid"></div>
            </div>
            
            <div id="cust-parts-container" class="hidden">
                <div class="filter-section">
                    <h4>Select Model</h4>
                    <div class="filter-options-grid" id="cust-model-grid"></div>
                </div>
                <div class="filter-section">
                    <h4>Select Backdrop</h4>
                    <div class="filter-options-grid" id="cust-backdrop-grid"></div>
                </div>
                <div class="filter-section">
                    <h4>Select Symbol (Optional)</h4>
                    <div class="filter-options-grid" id="cust-pattern-grid"></div>
                </div>
            </div>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" id="btn-create-custom" disabled onclick="handleCreateQueue()">Create All</button>
            <button class="modal-button secondary" onclick="closeModal('customize-modal')">Cancel</button>
        </div>
    </div>
</div>

<div id="long-press-menu" class="hidden">
    <ul>
        <li id="menu-pin" onclick="togglePin()">Pin to Profile</li>
        <li id="menu-wear" onclick="toggleWear()">Wear Gift</li>
        <li id="menu-reorder" class="hidden" onclick="startReorderMode()">Reorder Pins</li>
        <li id="menu-hide" onclick="toggleHide()">Hide Gift</li>
        <li class="danger" onclick="deleteGift()">Delete</li>
    </ul>
</div>

<div id="reorder-controls" class="page-header hidden" style="position:fixed; top:0; left:0; right:0; background:var(--tg-theme-bg-color); z-index:100; justify-content:center;">
    <button class="action-button" onclick="stopReorderMode()">Done Reordering</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();

    const CDN_BASE = "https://cdn.changes.tg/gifts/";
    // Keeping key stable to try preservation of data, though file updates might reset if URL changes in test environment.
    const LS_KEY = "telegram_gift_simulator_data_v2"; 
    
    // SVGs
    const PIN_ICON = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" /></svg>`;
    const WEAR_ICON = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>`;

    let state = {
        inventory: [], 
        giftDefinitions: {}, 
        lastCollectibleNumber: 100,
        userBio: "Hello world",
        userPhone: "",
        settings: { animations: true, showHidden: false }
    };

    let customizationQueue = [];
    let editingIndex = 0;
    let cachedParts = {};

    let appRuntime = {
        longPressTimer: null,
        activeGiftId: null, 
        shopGiftData: null, 
        reordering: false,
        sortable: null,
        selectionMode: null, 
        selectedIds: new Set()
    };

    window.addEventListener('DOMContentLoaded', async () => {
        // Init Loading Screen (Fake delay)
        const loadingScreen = document.getElementById('loading-overlay');
        lottie.loadAnimation({ container: document.getElementById('loading-anim'), renderer: 'svg', loop: true, autoplay: true, path: 'https://cdn.changes.tg/gifts/models/Artisan%20Brick/lottie/Ice%20Mammoth.json' });
        
        setTimeout(() => {
            loadingScreen.style.opacity = '0';
            document.getElementById('profile-page').classList.add('active');
            setTimeout(() => { loadingScreen.classList.remove('active'); }, 200);
        }, Math.random() * 3000 + 2000);

        applyTelegramTheme();
        tg.onEvent('themeChanged', applyTelegramTheme);

        loadState();
        if (!state.userPhone) state.userPhone = `+888 ${Math.floor(Math.random()*9000+1000)} ${Math.floor(Math.random()*9000+1000)}`;
        
        updateUserProfile();
        applyWornGiftVisuals();
        
        await fetchGiftDefinitions();
        renderShop();
        renderInventory();
        
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('long-press-menu');
            if (!menu.classList.contains('hidden') && !menu.contains(e.target)) menu.classList.add('hidden');
        });
    });

    function updateUserProfile() {
        const user = tg.initDataUnsafe.user;
        const nameEl = document.getElementById('user-name');
        const avatarEl = document.getElementById('user-avatar');
        const usernameEl = document.getElementById('profile-username');
        
        if (user) {
            nameEl.innerText = [user.first_name, user.last_name].filter(Boolean).join(' ');
            if (user.photo_url) avatarEl.src = user.photo_url;
            else avatarEl.src = `https://i.pravatar.cc/150?u=${user.id}`;
            usernameEl.innerText = user.username ? `@${user.username}` : '@unknown';
        } else {
            nameEl.innerText = "Web User";
            avatarEl.src = "https://i.pravatar.cc/150?u=test";
            usernameEl.innerText = "@webuser";
        }
        
        document.getElementById('profile-phone').innerText = state.userPhone;
        document.getElementById('profile-bio').innerText = state.userBio;
    }

    function editBio() {
        const newBio = prompt("Edit Bio:", state.userBio);
        if (newBio !== null) {
            state.userBio = newBio;
            document.getElementById('profile-bio').innerText = newBio;
            saveState();
        }
    }

    function applyTelegramTheme() {
        const p = tg.themeParams;
        const r = document.documentElement.style;
        if (p.bg_color) r.setProperty('--tg-theme-bg-color', p.bg_color);
        if (p.text_color) r.setProperty('--tg-theme-text-color', p.text_color);
        if (p.hint_color) r.setProperty('--tg-theme-hint-color', p.hint_color);
        if (p.link_color) r.setProperty('--tg-theme-link-color', p.link_color);
        if (p.button_color) r.setProperty('--tg-theme-button-color', p.button_color);
        if (p.button_text_color) r.setProperty('--tg-theme-button-text-color', p.button_text_color);
        if (p.secondary_bg_color) r.setProperty('--tg-theme-secondary-bg-color', p.secondary_bg_color);
    }

    function haptic(style) { if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred(style || 'light'); }
    function hapticNotify(type) { if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred(type); }

    async function fetchGiftDefinitions() {
        try {
            const res = await fetch(`${CDN_BASE}id-to-name.json`);
            if (!res.ok) throw new Error("Failed");
            state.giftDefinitions = await res.json();
        } catch (e) { console.error(e); }
    }

    async function fetchGiftParts(giftName) {
        const encName = encodeURIComponent(giftName);
        try {
            const [mRes, bRes, pRes] = await Promise.all([
                fetch(`${CDN_BASE}models/${encName}/models.json`),
                fetch(`${CDN_BASE}backdrops/${encName}/backdrops.json`),
                fetch(`${CDN_BASE}patterns/${encName}/patterns.json`)
            ]);
            let models = mRes.ok ? await mRes.json() : [];
            let backdrops = bRes.ok ? await bRes.json() : [];
            let patterns = pRes.ok ? await pRes.json() : [];

            models.sort((a, b) => (a.rarityPermille || 0) - (b.rarityPermille || 0));
            const pinned = ["Black", "Onyx Black", "Gunmetal", "Midnight Blue", "Electric Purple"];
            backdrops.sort((a, b) => {
                let idxA = pinned.indexOf(a.name), idxB = pinned.indexOf(b.name);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                if (idxA !== -1) return -1;
                if (idxB !== -1) return 1;
                return a.name.localeCompare(b.name);
            });

            return { models, backdrops, patterns };
        } catch (e) { return { models: [], backdrops: [], patterns: [] }; }
    }

    function renderShop() {
        const grid = document.getElementById('shop-grid');
        grid.innerHTML = '';
        Object.entries(state.giftDefinitions).forEach(([id, name]) => {
            if (['custom_skebob', 'custom_baggin_cat'].includes(id)) return;
            const el = document.createElement('div');
            el.className = 'buy-gift-item';
            const imgUrl = `${CDN_BASE}originals/${id}/Original.png`;
            el.innerHTML = `
                <div class="image-container"><img src="${imgUrl}" loading="lazy" onerror="this.style.display='none'"></div>
                <div class="gift-name">${name}</div>
                <div class="gift-price">Free</div>`;
            el.onclick = () => buyGift(id, name);
            el.addEventListener('touchstart', (e) => startShopLongPress(e, id, name), {passive:false});
            el.addEventListener('touchend', cancelLongPress);
            el.addEventListener('contextmenu', (e) => { e.preventDefault(); openQtyModal(id, name); });
            grid.appendChild(el);
        });
    }

    function renderInventory() {
        const grid = document.getElementById('inventory-grid');
        if (appRuntime.reordering) return;
        grid.innerHTML = '';
        
        let displayList = state.settings.showHidden ? state.inventory : state.inventory.filter(g => !g.hidden);
        document.getElementById('gift-count-display').innerText = `${state.inventory.length} gifts`;

        updateActionToolbar();

        if (displayList.length === 0) {
            grid.innerHTML = `<div style="grid-column:span 3; text-align:center; padding:40px 20px; color:var(--tg-theme-hint-color);">${state.inventory.length > 0 ? "All hidden." : "Empty."}</div>`;
            return;
        }

        displayList.sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            if (a.pinned && b.pinned) return (a.pinOrder || 0) - (b.pinOrder || 0);
            return b.timestamp - a.timestamp;
        });

        displayList.forEach(gift => {
            const el = document.createElement('div');
            el.className = 'gift-card';
            el.dataset.id = gift.uniqueId;
            if (gift.pinned) el.dataset.pinned = "true";
            if (gift.hidden) el.classList.add('is-hidden');
            if (appRuntime.selectionMode === 'hide' && appRuntime.selectedIds.has(gift.uniqueId)) el.classList.add('selected');
            
            if (appRuntime.selectionMode) {
                el.onclick = () => toggleSelection(gift.uniqueId);
            } else {
                el.addEventListener('touchstart', (e) => startInventoryLongPress(e, gift), {passive:false});
                el.addEventListener('touchend', cancelLongPress);
                el.addEventListener('touchmove', cancelLongPress);
                el.addEventListener('contextmenu', (e) => { e.preventDefault(); openMenu(e, gift); });
            }

            let visualHtml = '', topIcon = '';
            if(gift.pinned && !appRuntime.selectionMode) topIcon = `<div class="status-icon">${PIN_ICON}</div>`;
            if(gift.worn && !appRuntime.selectionMode) topIcon = `<div class="status-icon">${WEAR_ICON}</div>`;

            if (gift.isCollectible) {
                const cd = gift.collectibleData;
                const bgStyle = `radial-gradient(circle, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
                const imgUrl = `${CDN_BASE}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
                const lottieUrl = `${CDN_BASE}models/${encodeURIComponent(gift.name)}/lottie/${encodeURIComponent(cd.model.name)}.json`;
                
                if (state.settings.animations) {
                    visualHtml = `<div class="lottie-wrapper" id="lot-${gift.uniqueId}"></div>`;
                    setTimeout(() => playLottie(`lot-${gift.uniqueId}`, lottieUrl), 0);
                } else visualHtml = `<img src="${imgUrl}" loading="lazy">`;

                el.innerHTML = `
                    ${topIcon}
                    <div class="top-right-label">#${gift.collectibleNumber}</div>
                    <div class="gift-card-bg-pattern" style="background: ${bgStyle}"></div>
                    <div class="dynamic-pattern-container" id="pat-${gift.uniqueId}"></div>
                    <div class="image-container">${visualHtml}</div>`; 
                setTimeout(() => generatePattern(`pat-${gift.uniqueId}`, cd.pattern, gift.name, true, cd.backdrop.hex.patternColor), 0);
                if (!appRuntime.selectionMode) el.onclick = () => openCollectibleModal(gift);
            } else {
                const imgUrl = `${CDN_BASE}originals/${gift.originalId}/Original.png`;
                if (state.settings.animations) {
                    visualHtml = `<div class="lottie-wrapper" id="lot-${gift.uniqueId}"></div>`;
                    setTimeout(() => playLottie(`lot-${gift.uniqueId}`, `${CDN_BASE}originals/${gift.originalId}/Original.json`), 0);
                } else visualHtml = `<img src="${imgUrl}" loading="lazy">`;

                el.innerHTML = `<div class="image-container">${visualHtml}</div>`;
                if (!appRuntime.selectionMode) el.onclick = () => openDetailModal(gift);
            }
            grid.appendChild(el);
        });
    }

    function updateActionToolbar() {
        const toolbar = document.getElementById('action-toolbar');
        toolbar.innerHTML = '';
        toolbar.className = 'hidden';

        if (appRuntime.selectionMode === 'hide') {
            toolbar.className = '';
            toolbar.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
            toolbar.innerHTML = `
                <button class="action-button" onclick="cancelSelectionMode()" style="background:var(--tg-theme-button-color);">Cancel</button>
                <button class="action-button" onclick="confirmHideSelected()" style="background:var(--app-accent-blue);">Hide (${appRuntime.selectedIds.size})</button>
            `;
            return;
        }

        if (state.inventory.some(g => !g.isCollectible)) {
            toolbar.className = '';
            toolbar.style.borderBottom = 'none'; 
            toolbar.innerHTML = `<button class="action-button" onclick="handleUpgradeAll()" style="background:var(--app-accent-blue);">✨ Upgrade All</button>`;
        }
    }

    // --- Actions ---
    function buyGift(id, name, qty = 1) {
        for(let i=0; i<qty; i++) {
            state.inventory.unshift({
                uniqueId: Date.now() + Math.random() + i, originalId: id, name: name,
                isCollectible: false, timestamp: Date.now() + i, pinned: false, hidden: false, worn: false
            });
        }
        saveState(); renderInventory();
        if(qty === 1) switchTab('inventory'); 
        hapticNotify('success');
    }

    function startShopLongPress(e, id, name) { appRuntime.longPressTimer = setTimeout(() => { haptic('medium'); openQtyModal(id, name); }, 500); }
    function startInventoryLongPress(e, gift) { appRuntime.longPressTimer = setTimeout(() => { haptic('medium'); openMenu(e.touches[0], gift); }, 500); }
    function cancelLongPress() { clearTimeout(appRuntime.longPressTimer); }

    function openQtyModal(id, name) {
        appRuntime.shopGiftData = { id, name };
        document.getElementById('qty-modal').classList.add('active');
        document.getElementById('qty-input').value = 1;
        tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('qty-modal'));
    }
    function handleBuyMultiple() {
        const qty = parseInt(document.getElementById('qty-input').value);
        if(!qty || qty < 1) return;
        buyGift(appRuntime.shopGiftData.id, appRuntime.shopGiftData.name, qty);
        closeModal('qty-modal');
    }

    // --- Upgrade ---
    async function performUpgrade(gift, notify=true) {
        const parts = await fetchGiftParts(gift.name);
        if (!parts.models.length) return false;
        
        gift.isCollectible = true;
        state.lastCollectibleNumber++;
        gift.collectibleNumber = state.lastCollectibleNumber;
        gift.collectibleData = {
            model: parts.models[Math.floor(Math.random()*parts.models.length)],
            backdrop: parts.backdrops[Math.floor(Math.random()*parts.backdrops.length)],
            pattern: parts.patterns[Math.floor(Math.random()*parts.patterns.length)]
        };
        return true;
    }

    async function handleUpgrade() {
        document.getElementById('btn-upgrade').innerText = "Upgrading...";
        const gift = state.inventory.find(g => g.uniqueId === appRuntime.activeGiftId);
        const success = await performUpgrade(gift);
        if (success) {
            hapticNotify('success');
            saveState(); renderInventory(); closeModal('detail-modal');
            openCollectibleModal(gift);
        } else {
            alert("No parts!");
        }
        document.getElementById('btn-upgrade').innerText = "Upgrade";
    }

    async function handleUpgradeAll() {
        const toUpgrade = state.inventory.filter(g => !g.isCollectible);
        if(!toUpgrade.length) return;
        const btn = document.querySelector('#action-toolbar button');
        btn.innerText = `Upgrading ${toUpgrade.length}...`;
        btn.disabled = true;
        let changed = false;
        for (let g of toUpgrade) { if (await performUpgrade(g, false)) changed = true; }
        if(changed) { hapticNotify('success'); saveState(); renderInventory(); }
    }

    // --- Selection ---
    function startSelectionMode(mode) {
        appRuntime.selectionMode = mode;
        appRuntime.selectedIds = new Set();
        closeModal('settings-modal');
        renderInventory();
    }
    function cancelSelectionMode() {
        appRuntime.selectionMode = null; appRuntime.selectedIds = new Set(); renderInventory();
    }
    function toggleSelection(id) {
        if(appRuntime.selectedIds.has(id)) appRuntime.selectedIds.delete(id); else appRuntime.selectedIds.add(id);
        haptic('light'); renderInventory();
    }
    function confirmHideSelected() {
        const ids = Array.from(appRuntime.selectedIds);
        if(ids.length > 0) {
            state.inventory.forEach(g => { if(ids.includes(g.uniqueId)) { g.hidden = true; g.pinned = false; g.worn = false; } });
            hapticNotify('success'); saveState();
        }
        cancelSelectionMode(); applyWornGiftVisuals();
    }

    // --- Menu ---
    function openMenu(e, gift) {
        appRuntime.activeGiftId = gift.uniqueId;
        const menu = document.getElementById('long-press-menu');
        const pinBtn = document.getElementById('menu-pin');
        const wearBtn = document.getElementById('menu-wear');
        const reorderBtn = document.getElementById('menu-reorder');
        const hideBtn = document.getElementById('menu-hide');

        pinBtn.style.display = 'none'; wearBtn.style.display = 'none'; reorderBtn.style.display = 'none';

        if (gift.isCollectible) {
            pinBtn.style.display = 'block';
            pinBtn.innerText = gift.pinned ? "Unpin" : "Pin";
            wearBtn.style.display = 'block';
            wearBtn.innerText = gift.worn ? "Take Off" : "Wear";
            if (gift.pinned && state.inventory.filter(g => g.pinned).length > 1) reorderBtn.style.display = 'block';
        }
        hideBtn.innerText = gift.hidden ? "Unhide" : "Hide";

        let x = e.clientX, y = e.clientY;
        if (x + 180 > window.innerWidth) x = window.innerWidth - 190;
        if (y + 160 > window.innerHeight) y = window.innerHeight - 170;
        menu.style.left = x + 'px'; menu.style.top = y + 'px';
        menu.classList.remove('hidden');
    }

    function togglePin() {
        const gift = state.inventory.find(g => g.uniqueId === appRuntime.activeGiftId);
        if(!gift) return;
        if(gift.pinned) { gift.pinned = false; gift.pinOrder = null; }
        else {
            if(state.inventory.filter(g => g.pinned).length >= 6) { alert("Max 6 pins."); return; }
            gift.pinned = true; gift.pinOrder = 999;
        }
        document.getElementById('long-press-menu').classList.add('hidden');
        haptic('light'); saveState(); renderInventory();
    }

    function toggleWear() {
        const gift = state.inventory.find(g => g.uniqueId === appRuntime.activeGiftId);
        if(!gift) return;
        
        if(gift.worn) { 
            gift.worn = false; 
        } else { 
            // Unwear all others first
            state.inventory.forEach(g => g.worn = false); 
            gift.worn = true; 
        }
        
        document.getElementById('long-press-menu').classList.add('hidden');
        hapticNotify('success');
        saveState(); renderInventory(); applyWornGiftVisuals();
    }

    function applyWornGiftVisuals() {
        const worn = state.inventory.find(g => g.worn);
        const overlay = document.getElementById('profile-pattern-overlay');
        const bg = document.getElementById('profile-bg');
        overlay.innerHTML = '';
        
        if (worn) {
            const cd = worn.collectibleData;
            bg.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
            generatePattern('profile-pattern-overlay', cd.pattern, worn.name, false, cd.backdrop.hex.patternColor, true);
        } else { bg.style.background = 'var(--app-profile-gradient-fallback)'; }
    }

    function toggleHide() {
        const gift = state.inventory.find(g => g.uniqueId === appRuntime.activeGiftId);
        gift.hidden = !gift.hidden;
        if(gift.hidden) { gift.pinned = false; gift.worn = false; }
        document.getElementById('long-press-menu').classList.add('hidden');
        haptic('light'); saveState(); renderInventory(); applyWornGiftVisuals();
    }

    function deleteGift() {
        tg.showConfirm("Delete?", (yes) => {
            if(yes) {
                state.inventory = state.inventory.filter(g => g.uniqueId !== appRuntime.activeGiftId);
                haptic('heavy'); saveState(); renderInventory(); applyWornGiftVisuals();
            }
        });
        document.getElementById('long-press-menu').classList.add('hidden');
    }

    function startReorderMode() {
        document.getElementById('long-press-menu').classList.add('hidden');
        appRuntime.reordering = true;
        document.getElementById('reorder-controls').classList.remove('hidden');
        document.getElementById('inventory-grid').classList.add('reordering');
        haptic('medium');
        appRuntime.sortable = new Sortable(document.getElementById('inventory-grid'), {
            animation: 150, filter: ':not([data-pinned="true"])', draggable: '[data-pinned="true"]',
            onMove: (evt) => evt.related.hasAttribute('data-pinned')
        });
    }
    function stopReorderMode() {
        appRuntime.reordering = false;
        document.getElementById('reorder-controls').classList.add('hidden');
        document.getElementById('inventory-grid').classList.remove('reordering');
        if (appRuntime.sortable) {
            appRuntime.sortable.toArray().forEach((id, index) => {
                const g = state.inventory.find(x => x.uniqueId == id);
                if(g && g.pinned) g.pinOrder = index;
            });
            appRuntime.sortable.destroy(); haptic('light'); saveState(); renderInventory();
        }
    }

    // --- Customization Queue ---
    function initCustomizationQueue() {
        customizationQueue = []; editingIndex = -1;
        addGiftToQueue();
    }
    function addGiftToQueue() {
        // Reset selections visual before adding new logic
        document.querySelectorAll('.filter-option.selected').forEach(el => el.classList.remove('selected'));
        
        customizationQueue.push({ id:null, name:null, parts: { model:null, backdrop:null, pattern:null } });
        // Auto select last
        selectQueueItem(customizationQueue.length - 1);
        
        // Render base again for new item
        document.getElementById('cust-base-grid').classList.remove('hidden');
        document.getElementById('cust-parts-container').classList.add('hidden');
    }
    function selectQueueItem(index) {
        editingIndex = index;
        renderQueueBar();
        
        const curr = customizationQueue[editingIndex];
        
        if(curr.id) {
            // Restore visual state for this gift
            loadBaseConfig(curr.id, curr.name, false);
        } else {
            // New empty item
            const baseGrid = document.getElementById('cust-base-grid');
            Array.from(baseGrid.children).forEach(c => c.classList.remove('selected'));
            document.getElementById('cust-parts-container').classList.add('hidden');
            updateCreateButton();
        }
    }
    function renderQueueBar() {
        const bar = document.getElementById('cust-queue-bar');
        bar.innerHTML = '';
        customizationQueue.forEach((q, idx) => {
            const el = document.createElement('div');
            el.className = `queue-chip ${idx === editingIndex ? 'active' : ''}`;
            el.innerHTML = `<span>${q.name || `Gift ${idx+1}`}</span> ${customizationQueue.length > 1 ? `<span class="close-x">×</span>` : ''}`;
            el.onclick = (e) => { 
                if (e.target.classList.contains('close-x')) {
                    e.stopPropagation(); customizationQueue.splice(idx, 1);
                    if(editingIndex >= customizationQueue.length) editingIndex = customizationQueue.length - 1;
                    if(customizationQueue.length === 0) addGiftToQueue();
                    else selectQueueItem(editingIndex);
                } else selectQueueItem(idx);
            };
            bar.appendChild(el);
        });
        const addBtn = document.createElement('div'); addBtn.className = 'queue-chip add-gift-chip';
        addBtn.innerHTML = '<span>+ Add Gift</span>';
        addBtn.onclick = addGiftToQueue;
        bar.appendChild(addBtn);
    }

    async function openCustomizeModal() {
        document.getElementById('customize-modal').classList.add('active');
        tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('customize-modal'));
        initCustomizationQueue();
        
        // Init Base Grid
        const grid = document.getElementById('cust-base-grid');
        grid.innerHTML = '';
        Object.entries(state.giftDefinitions).forEach(([id, name]) => {
            if (['custom_skebob', 'custom_baggin_cat'].includes(id)) return;
            const el = document.createElement('div'); el.className = 'filter-option';
            el.innerHTML = `<img src="${CDN_BASE}originals/${id}/Original.png"><div class="label">${name}</div>`;
            el.onclick = () => loadBaseConfig(id, name, true);
            grid.appendChild(el);
        });
    }

    async function loadBaseConfig(id, name, resetParts) {
        haptic('light');
        const curr = customizationQueue[editingIndex];
        
        // Logic update: only update if changed
        if(curr.id !== id || resetParts) {
            curr.id = id; curr.name = name;
            curr.parts = { model:null, backdrop:null, pattern:null };
        }
        
        renderQueueBar();
        
        // Highlight Base
        const baseGrid = document.getElementById('cust-base-grid');
        Array.from(baseGrid.children).forEach(c => {
            c.classList.remove('selected');
            if(c.innerText === name) c.classList.add('selected'); // rough check by name
        });
        
        if(!cachedParts[id]) cachedParts[id] = await fetchGiftParts(name);
        const parts = cachedParts[id];
        
        renderPartGrid('cust-model-grid', parts.models, 'model', name);
        renderPartGrid('cust-backdrop-grid', parts.backdrops, 'backdrop', name);
        renderPartGrid('cust-pattern-grid', parts.patterns, 'pattern', name);
        
        document.getElementById('cust-parts-container').classList.remove('hidden');
        updateCreateButton();
    }

    function renderPartGrid(elemId, items, type, giftName) {
        const grid = document.getElementById(elemId);
        grid.innerHTML = '';
        const curr = customizationQueue[editingIndex];
        items.forEach(item => {
            const el = document.createElement('div'); el.className = 'filter-option';
            let content = '';
            if (type === 'model') content = `<img src="${CDN_BASE}models/${encodeURIComponent(giftName)}/png/${encodeURIComponent(item.name)}.png">`;
            else if (type === 'backdrop') content = `<div class="gradient-square" style="background: radial-gradient(circle, ${item.hex.centerColor}, ${item.hex.edgeColor})"></div>`;
            else content = `<img src="${CDN_BASE}patterns/${encodeURIComponent(giftName)}/png/${encodeURIComponent(item.name)}.png">`;
            
            el.innerHTML = `${content}<div class="label">${item.name}</div>`;
            
            // Highlight
            if (curr.parts[type] && curr.parts[type].name === item.name) el.classList.add('selected');
            
            el.onclick = () => {
                haptic('light');
                Array.from(grid.children).forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
                curr.parts[type] = item;
                updateCreateButton();
            };
            grid.appendChild(el);
        });
    }

    function updateCreateButton() {
        const btn = document.getElementById('btn-create-custom');
        // Require Model & Backdrop. Pattern optional.
        const allReady = customizationQueue.every(q => q.id && q.parts.model && q.parts.backdrop);
        btn.disabled = !allReady;
        btn.innerText = customizationQueue.length > 1 ? `Create All (${customizationQueue.length})` : 'Create';
    }

    function handleCreateQueue() {
        customizationQueue.forEach(q => {
            if(!q.id) return;
            // Fallback for pattern
            if(!q.parts.pattern) {
                const parts = cachedParts[q.id];
                if(parts && parts.patterns.length) {
                    q.parts.pattern = parts.patterns[Math.floor(Math.random() * parts.patterns.length)];
                }
            }
            if(!q.parts.model || !q.parts.backdrop || !q.parts.pattern) return; // Should allow null pattern if random failed? Just in case.

            state.lastCollectibleNumber++;
            state.inventory.unshift({
                uniqueId: Date.now() + Math.random(), originalId: q.id, name: q.name, isCollectible: true, timestamp: Date.now(),
                pinned: false, collectibleNumber: state.lastCollectibleNumber,
                collectibleData: { model: q.parts.model, backdrop: q.parts.backdrop, pattern: q.parts.pattern }
            });
        });
        hapticNotify('success'); saveState(); renderInventory(); closeModal('customize-modal'); switchTab('inventory');
    }

    // --- Modal Logic ---
    function openDetailModal(gift) {
        appRuntime.activeGiftId = gift.uniqueId;
        document.getElementById('detail-title').innerText = gift.name;
        document.getElementById('detail-image').style.display = 'none';
        document.getElementById('detail-lottie').style.display = 'block';
        playLottie('detail-lottie', `${CDN_BASE}originals/${gift.originalId}/Original.json`);
        document.getElementById('detail-modal').classList.add('active');
        tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('detail-modal'));
    }

    function openCollectibleModal(gift) {
        haptic('light');
        const cd = gift.collectibleData;
        document.getElementById('collectible-name').innerText = cd.model.name;
        document.getElementById('collectible-number').innerText = gift.collectibleNumber.toLocaleString();
        
        document.getElementById('collectible-display-area').style.background = `radial-gradient(circle at 50% 0%, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
        document.getElementById('collectible-image').style.display = 'none';
        document.getElementById('collectible-lottie').style.display = 'block';
        playLottie('collectible-lottie', `${CDN_BASE}models/${encodeURIComponent(gift.name)}/lottie/${encodeURIComponent(cd.model.name)}.json`);
        const rarity = (val) => `<span class="rarity-chip">${(val/10).toFixed(1)}%</span>`;
        document.getElementById('info-model').innerHTML = `${cd.model.name} ${rarity(cd.model.rarityPermille)}`;
        document.getElementById('info-backdrop').innerHTML = `${cd.backdrop.name} ${rarity(cd.backdrop.rarityPermille)}`;
        document.getElementById('info-pattern').innerHTML = `${cd.pattern.name} ${rarity(cd.pattern.rarityPermille)}`;
        document.getElementById('collectible-pattern-container').innerHTML = '';
        generatePattern('collectible-pattern-container', cd.pattern, gift.name, false, cd.backdrop.hex.patternColor);
        document.getElementById('collectible-modal').classList.add('active');
        tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('collectible-modal'));
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
        tg.BackButton.hide();
        if(id === 'detail-modal') document.getElementById('detail-lottie').innerHTML = '';
        if(id === 'collectible-modal') document.getElementById('collectible-lottie').innerHTML = '';
        
        if (document.getElementById('shop-page').classList.contains('active')) {
            tg.BackButton.show(); tg.BackButton.onClick(() => switchTab('inventory'));
        }
    }

    function switchTab(tab) {
        haptic('light');
        document.getElementById('profile-page').classList.remove('active');
        document.getElementById('shop-page').classList.remove('active');
        document.querySelectorAll('.profile-tabs button').forEach(b => b.classList.remove('active'));
        if (tab === 'inventory') {
            document.getElementById('profile-page').classList.add('active');
            document.querySelectorAll('.profile-tabs button')[0].classList.add('active');
            tg.BackButton.hide();
        } else {
            document.getElementById('shop-page').classList.add('active');
            document.querySelectorAll('.profile-tabs button')[1].classList.add('active');
            tg.BackButton.show(); tg.BackButton.onClick(() => switchTab('inventory'));
        }
    }

    function playLottie(id, path) {
        const container = document.getElementById(id); container.innerHTML = '';
        lottie.loadAnimation({ container, renderer:'svg', loop:true, autoplay:true, path });
    }

    function generatePattern(containerId, patternObj, giftName, isSmall, colorHex, isHeader=false) {
        const container = document.getElementById(containerId);
        if (!container) return;
        const url = `${CDN_BASE}patterns/${encodeURIComponent(giftName)}/png/${encodeURIComponent(patternObj.name)}.png`;
        // Centered coordinates relative to container size is handled via CSS centering + transform
        // We simulate "spread" by moving items away from the center (0,0) with translate
        
        let configs = isHeader ? [{ count: 12, radius: 100, size: 40 }, { count: 16, radius: 150, size: 36 }] : [{ count: 10, radius: isSmall ? 38 : 100, size: isSmall ? 12 : 36 }, { count: 12, radius: isSmall ? 62 : 150, size: isSmall ? 10 : 30 }];
        configs.forEach(conf => {
            for(let i=0; i<conf.count; i++) {
                const angle = (i / conf.count) * 2 * Math.PI;
                // Calculate OFFSET from center
                const x = conf.radius * Math.cos(angle); 
                const y = conf.radius * Math.sin(angle);
                
                const el = document.createElement('div');
                if(isHeader) el.className = 'profile-pattern-item'; else el.className = 'card-pattern-symbol';
                el.style.webkitMaskImage = `url('${url}')`; el.style.maskImage = `url('${url}')`;
                if (colorHex) el.style.backgroundColor = colorHex;
                el.style.width = `${conf.size}px`; el.style.height = `${conf.size}px`;
                // Centered by CSS, then moved by translate
                el.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
                container.appendChild(el);
            }
        });
    }

    function openSettingsModal() {
        document.getElementById('settings-modal').classList.add('active');
        document.getElementById('setting-animations').checked = state.settings.animations;
        document.getElementById('setting-hidden').checked = state.settings.showHidden;
        tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('settings-modal'));
    }
    function initSettingsUI() { }
    function toggleSetting(key, value) { state.settings[key] = value; haptic('light'); saveState(); renderInventory(); }
    function saveState() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function loadState() {
        const saved = localStorage.getItem(LS_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            state.inventory = parsed.inventory || [];
            state.lastCollectibleNumber = parsed.lastCollectibleNumber || 100;
            state.userBio = parsed.userBio || "Hello world";
            state.userPhone = parsed.userPhone || "";
            if(parsed.settings) state.settings = parsed.settings;
        }
    }
    function resetAppData() {
        tg.showConfirm("Reset App?", (confirmed) => { if(confirmed) { localStorage.removeItem(LS_KEY); location.reload(); }});
    }
</script>
</body>
</html>
