<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gift Upgrade</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --app-accent-blue: #5288c1;
            
            --app-modal-backdrop-color: rgba(0,0,0,0.8);
            --app-rarity-chip-bg: rgba(62, 188, 249, 0.15);
            --app-rarity-text: #62bcf9;
            --app-profile-gradient-fallback: var(--tg-theme-secondary-bg-color);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            font-size: 16px;
            overflow-x: hidden;
            user-select: none;
        }

        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; }
        .page { display: none; flex-direction: column; flex-grow: 1; background-color: var(--tg-theme-bg-color); }
        .page.active { display: flex; }

        .page-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 15px; background-color: var(--tg-theme-secondary-bg-color);
            min-height: 56px; position: sticky; top: 0; z-index: 10;
        }
        .page-header h2 { font-size: 1.15em; font-weight: 500; margin: 0; }
        
        .profile-top-section {
            padding-top: 30px; padding-bottom: 20px;
            background: var(--app-profile-gradient-fallback);
            display: flex; justify-content: center; position: relative;
            transition: background 0.5s ease;
        }

        .profile-top-section.has-worn-gift .profile-name-status h1,
        .profile-top-section.has-worn-gift .profile-name-status p {
            color: #ffffff !important;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        #profile-pattern-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden; pointer-events: none; opacity: 0.15;
        }
        
        .profile-pattern-item {
            position: absolute; width: 30px; height: 30px;
            left: 50%; top: 50%;
            background-color: currentColor; 
            -webkit-mask-size: contain; mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
        }

        .profile-main-info { display: flex; flex-direction: column; align-items: center; z-index: 2; position: relative; }
        .profile-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            background-color: var(--tg-theme-hint-color); margin-bottom: 12px;
            object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .profile-name-status h1 { font-size: 1.4em; font-weight: 700; text-align: center; margin: 0 0 4px 0; text-transform: uppercase; letter-spacing: 0.5px; }
        .profile-name-status p { font-size: 0.9em; opacity: 0.7; text-align: center; margin: 0; color: var(--tg-theme-text-color); }

        .profile-info-block { padding: 20px 20px; background-color: var(--tg-theme-bg-color); }
        .profile-info-header { color: var(--tg-theme-link-color); font-weight: 500; font-size: 0.95em; margin-bottom: 15px; }
        .info-item { margin-bottom: 18px; cursor: default; }
        .info-item .value { color: var(--tg-theme-text-color); font-size: 1.1em; display: block; margin-bottom: 2px; line-height: 1.2;}
        .info-item .label { color: var(--tg-theme-hint-color); font-size: 0.85em; }
        .info-item .clickable { cursor: pointer; }

        .profile-tabs { display: flex; justify-content: space-around; background-color: var(--tg-theme-bg-color); border-bottom: 1px solid #000; }
        .profile-tabs button {
            background: none; border: none; color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 0.95em; cursor: pointer; flex-grow: 1;
            font-weight: 500; border-bottom: 2px solid transparent; text-transform: uppercase;
        }
        .profile-tabs button.active { color: var(--tg-theme-link-color); border-bottom-color: var(--tg-theme-link-color); }

        .gifts-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 12px;
            flex-grow: 1; overflow-y: auto; align-content: start; 
            background: var(--tg-theme-bg-color);
        }
        
        .gift-card, .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 12px; padding: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; overflow: hidden;
            transition: transform 0.1s ease-out; border: none; 
        }
        .gift-card { aspect-ratio: 1 / 1; }
        .buy-gift-item { aspect-ratio: 1 / 1.35; padding: 8px; }
        
        .gift-card.selected { box-shadow: inset 0 0 0 3px var(--tg-theme-link-color); background-color: rgba(98, 188, 249, 0.15); }
        .gift-card:active, .buy-gift-item:active { transform: scale(0.97); }
        
        .status-icon {
            position: absolute; top: 6px; left: 6px; z-index: 5;
            width: 14px; height: 14px; display: flex; align-items: center; justify-content: center;
        }
        .status-icon svg { fill: #fff; width: 100%; height: 100%; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.8)); }

        .gift-card.is-hidden { opacity: 0.4; filter: grayscale(1); }

        .image-container {
            width: 75%; height: 75%; display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 2; margin-bottom: 0px; 
        }
        .buy-gift-item .image-container { height: 55%; margin-bottom: 4px; margin-top: 8px; }
        .image-container img, .image-container .lottie-wrapper { max-width: 100%; max-height: 100%; object-fit: contain; }
        .lottie-wrapper { width: 100%; height: 100%; }
        
        .gift-name { font-size: 0.85em; font-weight: 500; text-align: center; margin-top: 4px; z-index: 2; width: 100%; line-height: 1.2; padding: 0 2px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .gift-price { font-size: 0.8em; color: var(--tg-theme-hint-color); margin: 4px 0 8px; font-weight: bold; z-index: 2;}
        .gift-card-bg-pattern { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }
        .dynamic-pattern-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1; overflow: hidden; pointer-events: none; }
        .card-pattern-symbol { 
            position: absolute; width: 30px; height: 30px; left: 50%; top: 50%;
            background-color: currentColor; 
            -webkit-mask-size: contain; mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat; opacity: 0.15;
        }
        .top-right-label {
            position: absolute; top: 12px; right: -32px; transform: rotate(45deg);
            background: rgba(0,0,0,0.6); color: white; font-size: 0.6em; padding: 2px 35px; z-index: 4; font-weight: 600; letter-spacing: 0.5px;
        }

        .action-button {
            background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
            border: none; padding: 6px 14px; border-radius: 16px; font-size: 0.9em; cursor: pointer; font-weight: 500;
        }
        #action-toolbar {
            padding: 10px 15px; display: flex; justify-content: flex-end; gap: 10px; background-color: var(--tg-theme-bg-color);
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: 0.2s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            border-top-left-radius: 14px; border-top-right-radius: 14px;
            width: 100%; max-width: 600px; display: flex; flex-direction: column; overflow: hidden;
            max-height: 90vh;
            /* To make click outside work better */
            pointer-events: auto; 
        }
        #customize-modal .modal-content { height: 90vh; }

        .modal-header-bar { padding: 16px; text-align: center; font-weight: 600; font-size: 1.1em; background: var(--tg-theme-secondary-bg-color); position: relative; z-index: 10; }
        .modal-scrollable-content { overflow-y: auto; padding: 0; flex-grow: 1; }
        
        .modal-buttons-footer { padding: 15px; display: flex; gap: 10px; background: var(--tg-theme-secondary-bg-color); }
        .modal-button {
            flex: 1; padding: 12px; border-radius: 30px; border: none; font-size: 1em; font-weight: 600; cursor: pointer;
            background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
        }
        .modal-button.secondary { background-color: var(--tg-theme-bg-color); color: var(--tg-theme-link-color); }
        
        /* New Collectible Modal Styles */
        .collectible-header {
            position: relative; padding: 40px 0 30px; text-align: center; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #ffffff;
        }
        .collectible-header h3 { margin-top: 15px; position: relative; z-index: 2; font-size: 1.5em; margin-bottom: 6px; font-weight: 700; }
        .collectible-header .sub-header { position: relative; z-index: 2; font-size: 1em; opacity: 0.9; }

        .stats-table {
            background-color: var(--tg-theme-secondary-bg-color); border-radius: 12px; overflow: hidden; margin-top: 0; margin-bottom: 24px;
        }
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-weight: 500; color: var(--tg-theme-text-color); font-size: 0.95em; }
        .stat-value { display: flex; align-items: center; gap: 8px; font-size: 0.95em; color: var(--tg-theme-text-color); }
        
        .owner-chip { display: flex; align-items: center; gap: 6px; }
        .owner-chip img { width: 20px; height: 20px; border-radius: 50%; }
        .owner-chip span { color: var(--tg-theme-link-color); }
        
        .percentage-pill { background-color: var(--app-rarity-chip-bg); color: var(--app-rarity-text); padding: 2px 6px; border-radius: 6px; font-size: 0.8em; font-weight: 600; }
        .learn-more { font-size: 0.8em; color: var(--tg-theme-link-color); margin-left: 4px; opacity: 0.8; }
        
        .big-rounded-btn {
            width: 100%; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
            border: none; padding: 14px; border-radius: 30px; font-size: 1.1em; font-weight: 600; cursor: pointer;
        }

        /* Roulette Animations */
        /* Updated: Full Width */
        .roulette-image-wrapper {
            width: 100%; height: 160px; position: relative; overflow: hidden; display: flex;
            align-items: center; justify-content: center;
        }
        .roulette-strip {
            display: flex; height: 100%; position: absolute; left: 0; top: 0;
            /* Will be animated via JS/Keyframes */
        }
        .roulette-strip img {
            width: 160px; height: 160px; object-fit: contain; flex-shrink: 0;
        }
        
        /* Vertical Text Slot */
        .slot-mask {
            height: 1.2em; overflow: hidden; position: relative; display: inline-block; vertical-align: bottom;
            width: 120px; text-align: right;
        }
        .slot-scroll {
            display: flex; flex-direction: column; position: absolute; top: 0; right: 0; width: 100%;
            transition: transform 0.1s linear;
        }
        .slot-item {
            height: 1.2em; display: flex; align-items: center; justify-content: flex-end; width: 100%;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* Menu */
        #long-press-menu {
            position: fixed; background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 2000; min-width: 200px; padding: 6px 0; overflow: hidden;
        }
        #long-press-menu li { padding: 14px 20px; list-style: none; cursor: pointer; color: var(--tg-theme-text-color); font-size: 1em; font-weight: 500; display:flex; align-items:center; gap: 10px; }
        #long-press-menu li:hover { background: rgba(255,255,255,0.05); }
        #long-press-menu li.danger { color: #ff595a; }

        /* Queue Bar */
        .queue-bar { display: flex; overflow-x: auto; padding: 12px 15px; gap: 8px; background: var(--tg-theme-bg-color); white-space: nowrap; scrollbar-width: none; }
        .queue-bar::-webkit-scrollbar { display: none; }
        .queue-chip { 
            padding: 8px 14px; background: var(--tg-theme-secondary-bg-color); border-radius: 20px; font-size: 0.9em; cursor: pointer; border: 1px solid transparent; 
            display: flex; align-items: center; gap: 8px; font-weight: 500;
        }
        .queue-chip.active { border-color: var(--tg-theme-link-color); background: rgba(98, 188, 249, 0.1); color: var(--tg-theme-link-color); }
        .queue-chip .close-x { opacity: 0.6; font-size: 1.2em; font-weight: 300; }
        .add-gift-chip { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }

        .filter-section { padding: 0 15px; margin-bottom: 20px; }
        .filter-section h4 { margin: 15px 0 8px; color: var(--tg-theme-hint-color); font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; padding-left: 4px; }
        
        .filter-options-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; 
            overflow-y: auto; padding: 4px; max-height: 220px; border-radius: 8px;
        }
        .filter-option {
            background: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 10px;
            cursor: pointer; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100px;
        }
        .filter-option.selected { border-color: var(--tg-theme-link-color); background: rgba(98, 188, 249, 0.05); }
        .filter-option img { width: 55px; height: 55px; object-fit: contain; margin-bottom: 5px; }
        .filter-option .label { font-size: 0.75em; text-align: center; overflow: hidden; white-space: nowrap; width: 100%; text-overflow: ellipsis;}
        .gradient-square { width: 55px; height: 55px; border-radius: 50%; margin-bottom: 5px; }

        .switch-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.1); font-weight: 500; }
        .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--tg-theme-hint-color); transition: .4s; border-radius: 34px; opacity: 0.3; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--tg-theme-button-color); opacity: 1; }
        input:checked + .slider:before { transform: translateX(20px); }

        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--tg-theme-link-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .reordering .gift-card { opacity: 0.5; }
        .reordering .gift-card[data-pinned="true"] { opacity: 1; cursor: grab; box-shadow: 0 0 0 2px var(--tg-theme-link-color); }
        
        #qty-modal input { background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); border: none; padding: 12px; border-radius: 12px; width: 100%; font-size: 1.4em; text-align: center; margin-bottom: 15px; outline: none; font-weight: bold; }

        /* Loading */
        .glass-panel { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; animation: glassFloat 4s ease-in-out infinite; }
        .liquid-blob { position: absolute; border-radius: 50%; filter: blur(50px); opacity: 0.5; z-index: 1; animation: blobFloat 10s infinite alternate; }
        .blob-1 { width: 200px; height: 200px; background: #007AFF; top: 20%; left: 15%; }
        .blob-2 { width: 250px; height: 250px; background: #5ac8fa; bottom: 20%; right: 10%; animation-delay: -2s; }
        @keyframes blobFloat { 0% { transform: translate(0, 0) scale(1); } 50% { transform: translate(20px, -20px) scale(1.1); } 100% { transform: translate(-20px, 20px) scale(0.9); } }
        @keyframes glassFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* --- CRAFTING MODAL STYLES --- */
        .craft-header-btn {
            position: absolute; top: 16px; right: 16px; width: 32px; height: 32px;
            background-color: rgba(0,0,0,0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10; backdrop-filter: blur(4px);
        }
        .craft-icon {
            width: 20px; height: 20px;
            -webkit-mask-image: url('https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/8e8c2524c119384132502547e562a1d128661cd9/telelakel_tgb_AgADOZMAAsCtWEs.svg');
            mask-image: url('https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/8e8c2524c119384132502547e562a1d128661cd9/telelakel_tgb_AgADOZMAAsCtWEs.svg');
            -webkit-mask-size: contain; mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
            background-color: #ffffff;
        }

        /* Updated Craft Container Background */
        .craft-container {
            background: transparent; 
            padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; height: 100%;
            position: relative;
        }

        /* Green Gradient Button */
        #btn-craft-action {
            width: 90%; 
            height: auto;
            min-height: 56px;
            margin: 0 auto 10px auto;
            
            /* Exact Gradient: Bright Green to Teal/Cyan */
            background: linear-gradient(90deg, #4cd964 0%, #29b6f6 100%);
            
            /* Fully Rounded Pill Shape */
            border-radius: 30px; 
            border: none;
            
            /* Text Styling */
            color: #ffffff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(46, 204, 113, 0.4);
            
            /* Font adjustments */
            font-size: 1.1em; 
            font-weight: 700;
            line-height: 1.2;
            padding: 12px 20px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        #btn-craft-action:disabled {
            background: #2c3e50;
            color: #7f8c8d;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* Ensure the success text inside button is styled */
        .craft-btn-subtext {
            font-size: 0.75em; 
            font-weight: 500; 
            opacity: 0.9; 
            margin-top: 2px;
        }

        /* Animation Modal Sizing - Match other modals */
        #craft-modal .modal-content {
            background: #094d4f;
            background: radial-gradient(circle,rgba(9, 77, 79, 1) 0%, rgba(0, 20, 16, 1) 100%);
            height: 90vh;
        }

        /* Rest of Craft Styles (Slots, etc) */
        .craft-slots-area { position: relative; width: 300px; height: 300px; margin-top: 20px; }
        .craft-center-progress {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 120px; height: 120px; display: flex; align-items: center; justify-content: center;
            flex-direction: column;
        }
        .craft-svg-circle { transform: rotate(-90deg); width: 100%; height: 100%; }
        .craft-svg-circle circle { fill: none; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }
        .craft-bg-circle { stroke: rgba(255,255,255,0.1); }
        .craft-fg-circle { stroke: #ffffff; }

        .craft-anvil-icon {
            position: absolute; width: 50px; height: 50px;
            -webkit-mask-image: url('https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/8e8c2524c119384132502547e562a1d128661cd9/telelakel_tgb_AgADOZMAAsCtWEs.svg');
            mask-image: url('https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/8e8c2524c119384132502547e562a1d128661cd9/telelakel_tgb_AgADOZMAAsCtWEs.svg');
            -webkit-mask-size: contain; mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
            background-color: #ffffff;
        }
        .craft-pct-text { position: absolute; bottom: 25px; color: #fff; font-size: 0.9em; font-weight: 700; }

        .craft-slot {
            position: absolute; width: 70px; height: 70px;
            background: rgba(255,255,255,0.1); border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; border: 2px solid transparent;
            transition: transform 0.1s;
        }
        .craft-slot.top-left { top: 0; left: 0; }
        .craft-slot.top-right { top: 0; right: 0; }
        .craft-slot.bottom-left { bottom: 0; left: 0; }
        .craft-slot.bottom-right { bottom: 0; right: 0; }
        .craft-slot img { width: 100%; height: 100%; object-fit: contain; }
        .craft-slot .add-icon { font-size: 24px; color: rgba(255,255,255,0.5); }
        .craft-slot .remove-btn {
            position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: rgba(0,0,0,0.6);
            border-radius: 50%; color: #fff; font-size: 10px; display: flex; align-items: center; justify-content: center;
        }

        .craft-probability-row { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; justify-content: center; }
        .prob-pill { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 20px; color: #fff; font-size: 0.85em; }
        .prob-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); }

        /* Selection Grid */
        .craft-select-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .craft-select-item { position: relative; border-radius: 12px; overflow: hidden; aspect-ratio: 1/1; background: var(--tg-theme-secondary-bg-color); border: 2px solid transparent; }
        .craft-select-item.selected { border-color: #3e97f0; background: rgba(62, 151, 240, 0.2); }
        .craft-select-item img { width: 100%; height: 100%; object-fit: contain; }
        .rarity-badge { position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.6); color: #fff; font-size: 0.7em; padding: 2px 6px; border-radius: 4px; }

        /* CUBE & BURNING ANIMATION */
        .cube-wrapper { width: 150px; height: 150px; perspective: 600px; margin: 0 auto; position: relative; }
        .cube { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transform: translateZ(-75px); }
        .cube.spinning { animation: spinCube 3s cubic-bezier(0.1, 0.7, 0.1, 1) forwards; }
        .cube.burning { animation: burnToAsh 1.5s ease-in forwards; }

        #craft-anim-modal .modal-content {
            background: linear-gradient(180deg, #18222d 0%, #0e1621 100%) !important;
            height: 90vh !important;
            max-height: 90vh !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            box-shadow: none !important;
            border-top-left-radius: 14px;
            border-top-right-radius: 14px;
        }

        #craft-anim-modal .cube-wrapper {
            margin-bottom: 30px; /* Space between cube and text */
            flex-shrink: 0;
        }

        .cube-face {
            position: absolute; width: 150px; height: 150px;
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px); border-radius: 12px; overflow: hidden;
        }
        .cube-face img { width: 80%; height: 80%; object-fit: contain; }
        .cube-face.front  { transform: rotateY(  0deg) translateZ(75px); }
        .cube-face.right  { transform: rotateY( 90deg) translateZ(75px); }
        .cube-face.back   { transform: rotateY(180deg) translateZ(75px); }
        .cube-face.left   { transform: rotateY(-90deg) translateZ(75px); }
        .cube-face.top    { transform: rotateX( 90deg) translateZ(75px); }
        .cube-face.bottom { transform: rotateX(-90deg) translateZ(75px); }

        @keyframes spinCube {
            0% { transform: translateZ(-75px) rotateX(0deg) rotateY(0deg); }
            20% { transform: translateZ(-75px) rotateX(-180deg) rotateY(-90deg); }
            60% { transform: translateZ(-75px) rotateX(360deg) rotateY(720deg); }
            100% { transform: translateZ(-75px) rotateX(1440deg) rotateY(1800deg); }
        }

        @keyframes burnToAsh {
            0% { filter: brightness(1); opacity: 1; transform: scale(1) translateZ(-75px); }
            50% { filter: brightness(3) sepia(1) hue-rotate(-30deg) blur(2px); opacity: 0.8; }
            100% { filter: grayscale(1) brightness(0.2) blur(10px); opacity: 0; transform: scale(0.5) translateZ(-75px) translateY(50px); }
        }
</style>
    </style>
</head>
<body>

<div id="loading-overlay" class="modal-overlay active" style="align-items: center; justify-content: center; background: var(--tg-theme-bg-color); z-index: 9999;">
    <div class="liquid-blob blob-1"></div>
    <div class="liquid-blob blob-2"></div>
    <div class="glass-panel">
        <div id="loading-anim" style="width: 100px; height: 100px;"></div>
        <h2 style="font-weight:700; margin-top:15px; color:var(--tg-theme-text-color);">Gift Simulator</h2>
    </div>
</div>

<div class="app-container">
    <!-- Profile Page -->
    <div id="profile-page" class="page">
        <div class="page-header">
            <h2>Profile</h2>
            <div><button class="action-button" onclick="openSettingsModal()">Settings</button></div>
        </div>
        <div class="profile-top-section" id="profile-bg">
            <div id="profile-pattern-overlay"></div>
            <div class="profile-main-info">
                <img src="" class="profile-avatar" id="user-avatar">
                <div class="profile-name-status">
                    <h1 id="user-name">Loading...</h1>
                    <p id="gift-count-display">0 gifts</p>
                </div>
            </div>
        </div>
        
        <div class="profile-info-block">
            <div class="profile-info-header">Info</div>
            <div class="info-item">
                <span class="value" id="profile-phone">+888 0000 0000</span>
                <span class="label">Mobile</span>
            </div>
            <div class="info-item clickable" onclick="editBio()">
                <span class="value" id="profile-bio">Hello world</span>
                <span class="label">Bio</span>
            </div>
            <div class="info-item">
                <span class="value" id="profile-username">@username</span>
                <span class="label">Username</span>
            </div>
        </div>

        <div class="profile-tabs">
            <button class="active" onclick="switchTab('inventory')">Inventory</button>
            <button onclick="switchTab('shop')">Gift Shop</button>
        </div>
        
        <div id="action-toolbar" class="hidden"></div>
        <div class="gifts-grid" id="inventory-grid"></div>
    </div>

    <!-- Shop Page -->
    <div id="shop-page" class="page">
        <div class="page-header">
            <h2>Gift Shop</h2>
            <button class="action-button" onclick="openCustomizeModal()">Customize</button>
        </div>
        <div class="gifts-grid" id="shop-grid">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<!-- Modals -->

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar">Settings</div>
        <div class="modal-scrollable-content">
            <div class="switch-row">
                <span>Animations (Lottie)</span>
                <label class="switch">
                    <input type="checkbox" id="setting-animations" onchange="toggleSetting('animations', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-row">
                <span>Show Hidden Gifts</span>
                <label class="switch">
                    <input type="checkbox" id="setting-hidden" onchange="toggleSetting('showHidden', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div style="padding: 20px; display: flex; flex-direction: column; gap: 10px;">
                <button class="modal-button" style="width:100%; background: var(--app-accent-blue);" onclick="startSelectionMode('hide')">Select & Hide Multiple</button>
                <button class="modal-button secondary" style="width:100%; color: #ff595a;" onclick="resetAppData()">Reset All Data</button>
            </div>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" onclick="closeModal('settings-modal')">Close</button>
        </div>
    </div>
</div>

<div id="qty-modal" class="modal-overlay">
    <div class="modal-content" style="max-height: auto;">
        <div class="modal-header-bar">Buy Multiple</div>
        <div class="modal-scrollable-content" style="padding: 20px;">
            <p style="margin-bottom: 10px; color: var(--tg-theme-hint-color);">Enter quantity:</p>
            <input type="number" id="qty-input" value="1" min="1" max="1000">
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" onclick="handleBuyMultiple()">Buy</button>
            <!-- Removed Cancel Button -->
        </div>
    </div>
</div>

<div id="detail-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar"><span id="detail-title">Gift</span></div>
        <div class="modal-scrollable-content" style="padding: 20px; text-align: center;">
            <div class="image-container" style="width: 160px; height: 160px; margin: 0 auto;">
                <img id="detail-image" src="" style="display:none; width: 100%; height: 100%; object-fit: contain;">
                <div id="detail-lottie" class="lottie-wrapper"></div>
            </div>
            <p style="color: var(--tg-theme-hint-color); margin-top: 15px; line-height: 1.5;" id="detail-desc">
                This is a regular gift. Upgrade it to make it a unique collectible!
            </p>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" id="btn-upgrade" onclick="handleUpgrade()">Upgrade</button>
            <!-- Removed Close Button -->
        </div>
    </div>
</div>

<!-- COLLECTIBLE / ROULETTE MODAL -->
<div id="collectible-modal" class="modal-overlay">
    <div class="modal-content" style="background-color: var(--tg-theme-bg-color);">
        <!-- Top Gradient Section -->
        <div id="collectible-header" class="collectible-header">
            <div id="collectible-pattern-container" class="dynamic-pattern-container"></div>
            <div style="position: relative; z-index: 2; width: 100%; display: flex; flex-direction: column; align-items: center;">
                <div class="roulette-image-wrapper">
                    <div id="roulette-strip" class="roulette-strip" style="display:none;"></div>
                    <img id="collectible-image" src="" style="width:160px; height:160px; object-fit:contain; display:none;">
                    <div id="collectible-lottie" class="lottie-wrapper" style="width:160px; height:160px; display:none;"></div>
                </div>
                <h3 id="collectible-title">Gift Name #000</h3>
                <div class="sub-header" id="collectible-model-name">Model Name</div>
            </div>
        </div>

        <!-- Scrollable Content with Table -->
        <div class="modal-scrollable-content" style="padding: 16px;">
            <div class="stats-table">
                <!-- Owner -->
                <div class="stat-row">
                    <div class="stat-label">Owner</div>
                    <div class="stat-value owner-chip">
                        <img id="col-owner-img" src="">
                        <span id="col-owner-name">User</span>
                    </div>
                </div>
                <!-- Model -->
                <div class="stat-row">
                    <div class="stat-label">Model</div>
                    <div class="stat-value">
                        <div class="slot-mask" id="slot-model"><div class="slot-scroll"></div></div>
                        <span class="percentage-pill" id="col-model-pct">0%</span>
                    </div>
                </div>
                <!-- Symbol -->
                <div class="stat-row">
                    <div class="stat-label">Symbol</div>
                    <div class="stat-value">
                        <div class="slot-mask" id="slot-symbol"><div class="slot-scroll"></div></div>
                        <span class="percentage-pill" id="col-symbol-pct">0%</span>
                    </div>
                </div>
                <!-- Backdrop -->
                <div class="stat-row">
                    <div class="stat-label">Backdrop</div>
                    <div class="stat-value">
                        <div class="slot-mask" id="slot-backdrop"><div class="slot-scroll"></div></div>
                        <span class="percentage-pill" id="col-backdrop-pct">0%</span>
                    </div>
                </div>
                <!-- Quantity -->
                <div class="stat-row">
                    <div class="stat-label">Quantity</div>
                    <div class="stat-value" id="col-quantity">100/1000 issued</div>
                </div>
                <!-- Value -->
                <div class="stat-row">
                    <div class="stat-label">Value</div>
                    <div class="stat-value" style="color: var(--tg-theme-link-color);">
                        <span id="col-value">~10 TON</span> 
                        <span class="learn-more">learn more</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="modal-buttons-footer" style="padding-top: 0; background: var(--tg-theme-bg-color);">
            <button id="btn-collectible-action" class="big-rounded-btn" onclick="closeModal('collectible-modal')">OK</button>
        </div>
    </div>
</div>

<div id="customize-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar">Customize</div>
        
        <!-- Queue Bar -->
        <div class="queue-bar" id="cust-queue-bar"></div>
        
        <div class="modal-scrollable-content" style="padding: 0; background: var(--tg-theme-secondary-bg-color);">
            
            <!-- Base Gift Selection -->
            <div class="filter-section">
                <h4>Select Base Gift</h4>
                <div class="filter-options-grid" id="cust-base-grid"></div>
            </div>

            <!-- Parts Selection Container -->
            <div id="cust-parts-container" class="hidden">
                
                <!-- Model Grid -->
                <div class="filter-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-right: 4px;">
                        <h4>Select Model</h4>
                        <span id="lbl-rnd-model" class="hidden" style="font-size:0.75em; color:var(--tg-theme-link-color); font-weight:600; letter-spacing:0.5px; text-transform:uppercase;">Randomized</span>
                    </div>
                    <div class="filter-options-grid" id="cust-model-grid"></div>
                </div>

                <!-- Backdrop Grid -->
                <div class="filter-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-right: 4px;">
                        <h4>Select Backdrop</h4>
                        <span id="lbl-rnd-backdrop" class="hidden" style="font-size:0.75em; color:var(--tg-theme-link-color); font-weight:600; letter-spacing:0.5px; text-transform:uppercase;">Randomized</span>
                    </div>
                    <div class="filter-options-grid" id="cust-backdrop-grid"></div>
                </div>

                <!-- Pattern Grid -->
                <div class="filter-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-right: 4px;">
                        <h4>Select Symbol (Optional)</h4>
                        <span id="lbl-rnd-pattern" class="hidden" style="font-size:0.75em; color:var(--tg-theme-link-color); font-weight:600; letter-spacing:0.5px; text-transform:uppercase;">Randomized</span>
                    </div>
                    <div class="filter-options-grid" id="cust-pattern-grid"></div>
                </div>

                <!-- NEW: Bulk / Random Controls -->
                <div id="cust-bulk-controls" style="margin: 20px 15px 30px 15px; background: var(--tg-theme-bg-color); border-radius: 12px; overflow: hidden;">
                    
                    <!-- Quantity Row -->
                    <div style="display:flex; justify-content:space-between; align-items:center; padding: 12px 16px; border-bottom:1px solid rgba(0,0,0,0.05);">
                        <span style="font-weight:500; font-size: 0.95em;">Quantity</span>
                        <input type="number" id="cust-qty" value="1" min="1" max="1000" oninput="updateCreateButton()" style="width:80px; padding:8px; border-radius:8px; border:none; background:var(--tg-theme-secondary-bg-color); color:var(--tg-theme-text-color); text-align:center; font-weight:bold; font-size:1.1em; outline:none;">
                    </div>
                    
                    <!-- Random Model Switch -->
                    <div class="switch-row" style="border-bottom:1px solid rgba(0,0,0,0.05); padding: 12px 16px;">
                        <span style="font-size: 0.95em;">Random Model</span>
                        <label class="switch">
                            <input type="checkbox" id="cb-rnd-model" onchange="toggleRandomPart('model'); updateCreateButton()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <!-- Random Backdrop Switch -->
                    <div class="switch-row" style="border-bottom:1px solid rgba(0,0,0,0.05); padding: 12px 16px;">
                        <span style="font-size: 0.95em;">Random Backdrop</span>
                        <label class="switch">
                            <input type="checkbox" id="cb-rnd-backdrop" onchange="toggleRandomPart('backdrop'); updateCreateButton()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <!-- Random Pattern Switch (Default Checked) -->
                    <div class="switch-row" style="border:none; padding: 12px 16px;">
                        <span style="font-size: 0.95em;">Random Symbol</span>
                        <label class="switch">
                            <input type="checkbox" id="cb-rnd-pattern" checked onchange="toggleRandomPart('pattern'); updateCreateButton()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

            </div>
        </div>
        
        <div class="modal-buttons-footer">
            <button class="modal-button" id="btn-create-custom" disabled onclick="handleCreateQueue()">Create</button>
        </div>
    </div>
</div>

<!-- CRAFTING MAIN MODAL -->
<div id="craft-modal" class="modal-overlay">
    <div class="modal-content" style="height: 90vh; color: white;">
        <div class="modal-header-bar" style="background:transparent; border:none; color:white;">
            <span style="opacity:0.8">Craft Gift</span>
            <div style="position:absolute; right:15px; top:15px; cursor:pointer;" onclick="closeModal('craft-modal')">✕</div>
        </div>
        
        <div class="craft-container">
            <!-- Central Crafting Area -->
            <div class="craft-slots-area">
                <!-- Center Progress -->
                <div class="craft-center-progress">
                    <svg class="craft-svg-circle" viewBox="0 0 100 100">
                        <circle class="craft-bg-circle" cx="50" cy="50" r="45"></circle>
                        <circle id="craft-progress-ring" class="craft-fg-circle" cx="50" cy="50" r="45" stroke-dasharray="283" stroke-dashoffset="283"></circle>
                    </svg>
                    <div class="craft-anvil-icon"></div>
                    <div class="craft-pct-text" id="craft-chance-text">0%</div>
                </div>

                <!-- 4 Slots -->
                <div class="craft-slot top-left" id="slot-0" onclick="openCraftSelect()">
                    <span class="add-icon">+</span>
                </div>
                <div class="craft-slot top-right" id="slot-1" onclick="openCraftSelect()">
                    <span class="add-icon">+</span>
                </div>
                <div class="craft-slot bottom-left" id="slot-2" onclick="openCraftSelect()">
                    <span class="add-icon">+</span>
                </div>
                <div class="craft-slot bottom-right" id="slot-3" onclick="openCraftSelect()">
                    <span class="add-icon">+</span>
                </div>
            </div>

            <div style="text-align:center; margin-top: -20px;">
                <p style="font-size:0.9em; opacity:0.7; max-width: 80%; margin: 0 auto;">
                    Add up to 4 gifts to craft new <br>
                    <b id="craft-target-name">Cake #000</b>.
                </p>
                <p style="font-size:0.8em; color: #ff595a; margin-top:8px;">
                    If crafting fails, all selected gifts will be consumed.
                </p>
                
                <!-- Backdrop Probabilities -->
                <div class="craft-probability-row" id="craft-probs"></div>
            </div>
            <!-- Add this before the "Craft Gift" button -->
            <div id="craft-mix-container" class="switch-row" style="background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 15px; width: 90%; opacity: 0.5; pointer-events: none; padding: 12px 16px; border: none;">
                <span style="font-size: 0.95em;">Backdrop Mixing</span>
                <label class="switch">
                    <input type="checkbox" id="cb-mix-backdrop">
                    <span class="slider"></span>
                </label>
            </div>
            <button id="btn-craft-action" class="big-rounded-btn" onclick="startCrafting()">
                Craft Gift
            </button>
        </div>
    </div>
</div>

<!-- CRAFT SELECTION MODAL -->
<div id="craft-select-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar">Select Gifts</div>
        <div class="modal-scrollable-content">
            <div class="craft-select-grid" id="craft-select-grid"></div>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" onclick="closeModal('craft-select-modal')">Done</button>
        </div>
    </div>
</div>

<!-- ANIMATION MODAL -->
<div id="craft-anim-modal" class="modal-overlay" style="z-index: 2000; background: rgba(14, 22, 33, 0.95);">
    <div class="modal-content" style="background: transparent; align-items: center; justify-content: center; box-shadow:none;">
        <div class="cube-wrapper">
            <div class="cube" id="craft-cube">
                <div class="cube-face front"><img src=""></div>
                <div class="cube-face back"><img src=""></div>
                <div class="cube-face right"><img src=""></div>
                <div class="cube-face left"><img src=""></div>
                <div class="cube-face top"><div class="craft-anvil-icon" style="background:white"></div></div>
                <div class="cube-face bottom"><div class="craft-anvil-icon" style="background:white"></div></div>
            </div>
        </div>
        <h2 style="margin-top:40px; color:white; font-weight:700;">Crafting...</h2>
        <p id="craft-anim-status" style="color:rgba(255,255,255,0.7); margin-top:10px;">Heating up the anvil</p>
    </div>
</div>

<!-- FAILURE MODAL -->
<div id="failure-modal" class="modal-overlay">
    <div class="modal-content" style="background-color: #1c1c1e; color: white; height: auto; min-height: 60vh; border-radius: 16px;">
        
        <!-- Header -->
        <div class="modal-header-bar" style="background: transparent; border: none; display: flex; justify-content: space-between; align-items: center; padding: 16px;">
            <div onclick="closeModal('failure-modal')" style="cursor: pointer; background: rgba(255,255,255,0.1); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">✕</div>
            <span style="font-weight: 600; font-size: 1.1em;">Crafting Gift</span>
            <div style="width: 32px;"></div> <!-- Spacer -->
        </div>

        <div class="modal-scrollable-content" style="display: flex; flex-direction: column; align-items: center; padding: 20px 20px 40px;">
            
            <!-- Central Icon -->
            <div style="width: 100px; height: 100px; background: #3a2525; border-radius: 24px; display: flex; align-items: center; justify-content: center; margin-bottom: 24px; position: relative;">
                <div class="craft-anvil-icon" style="background-color: #ff595a; transform: scale(1.5);"></div>
                <div style="position: absolute; bottom: -10px; background: #3a2525; padding: 2px 8px; border-radius: 10px; font-weight: bold; font-size: 0.9em; border: 2px solid #1c1c1e;">
                    4
                </div>
            </div>

            <!-- Text -->
            <h2 style="color: #ff595a; margin: 0 0 10px 0; font-weight: 700; font-size: 1.5em;">Unsuccessful attempt</h2>
            <p style="text-align: center; color: #8e8e93; font-size: 0.95em; line-height: 1.4; margin: 0 0 30px 0;">
                The crafting attempt failed.<br>
                <span id="fail-count-text">4</span> gifts were lost.
            </p>

            <!-- Lost Items Grid -->
            <div id="failed-items-grid" style="display: flex; justify-content: center; gap: 12px; margin-bottom: 40px; width: 100%;">
                <!-- Items injected here -->
            </div>

            <!-- Button -->
            <button onclick="retryCrafting()" style="width: 100%; background: #ffffff; color: #000000; font-weight: 600; font-size: 1.1em; padding: 16px; border-radius: 12px; border: none; cursor: pointer;">
                Craft Again
            </button>

        </div>
    </div>
</div>

<!-- Menus -->
<div id="long-press-menu" class="hidden">
    <ul>
        <li id="menu-pin" onclick="togglePin()">Pin to Profile</li>
        <li id="menu-wear" onclick="toggleWear()">Wear Gift</li>
        <li id="menu-reorder" class="hidden" onclick="startReorderMode()">Reorder Pins</li>
        <li id="menu-hide" onclick="toggleHide()">Hide Gift</li>
        <li class="danger" onclick="deleteGift()">Delete</li>
    </ul>
</div>
<div id="reorder-controls" class="page-header hidden" style="position:fixed; top:0; left:0; right:0; background:var(--tg-theme-bg-color); z-index:100; justify-content:center;">
    <button class="action-button" onclick="stopReorderMode()">Done Reordering</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand(); tg.enableClosingConfirmation();

    const CDN_BASE = "https://cdn.changes.tg/gifts/";
    const LS_KEY = "telegram_gift_simulator_data_v2"; 
    
    // CUSTOM CONFIGS (Shortened for brevity)
    const MY_CUSTOM_ADDITIONS = {
        "Heart Locket": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADoJIAAkOhuEs.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADoJIAAkOhuEs.json"}],
        "Jolly Chimp": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADNpwAArR-oUs.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADNpwAArR-oUs.json"}],
        "Khabib's Papakha": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgAD1IoAAlWf8Us.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgAD1IoAAlWf8Us.json"}],
        "Desk Calendar": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADM6AAAm0yIUs.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADM6AAAm0yIUs.json"}],
        "Winter Wreath": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADdpQAAvk6GEk.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADdpQAAvk6GEk.json"}],
        "Loot Bag": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADdpYAAohNiEs.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADdpYAAohNiEs.json"}, {name: "MID Club", rarityPermille: 15, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADX58AAp0RiUs.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADX58AAp0RiUs.json"}],
        "Victory Medal": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADg5UAAtjYyEs.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADg5UAAtjYyEs.json"}]
    };
    
    const PIN_ICON = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" /></svg>`;
    const WEAR_ICON = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>`;

    let state = { inventory: [], giftDefinitions: {}, lastCollectibleNumber: 100, userBio: "Hello world", userPhone: "", settings: { animations: true, showHidden: false } };
    let customizationQueue = []; let editingIndex = 0; let cachedParts = {};
    let appRuntime = { longPressTimer: null, activeGiftId: null, shopGiftData: null, reordering: false, sortable: null, selectionMode: null, selectedIds: new Set(), animationState: null, detailInterval: null };

    // --- Init ---
    window.addEventListener('DOMContentLoaded', async () => {
        const loadingScreen = document.getElementById('loading-overlay');
        lottie.loadAnimation({ container: document.getElementById('loading-anim'), renderer: 'svg', loop: true, autoplay: true, path: 'https://cdn.changes.tg/gifts/models/Artisan%20Brick/lottie/Ice%20Mammoth.json' });
        setTimeout(() => { loadingScreen.style.opacity = '0'; document.getElementById('profile-page').classList.add('active'); setTimeout(() => { loadingScreen.classList.remove('active'); }, 200); }, Math.random() * 3000 + 2000);

        applyTelegramTheme(); tg.onEvent('themeChanged', applyTelegramTheme);
        loadState();
        if (!state.userPhone) state.userPhone = `+888 ${Math.floor(Math.random()*9000+1000)} ${Math.floor(Math.random()*9000+1000)}`;
        updateUserProfile(); applyWornGiftVisuals(); await fetchGiftDefinitions(); renderShop(); renderInventory();
        document.addEventListener('click', (e) => {
            // If the user clicks exactly on the modal-overlay (the dark background)
            if (e.target.classList.contains('modal-overlay')) {
                closeModal(e.target.id);
            }
        });
        document.addEventListener('click', (e) => { 
            const menu = document.getElementById('long-press-menu'); 
            if (!menu.classList.contains('hidden') && !menu.contains(e.target)) menu.classList.add('hidden');
            
            // Close modals on outside click
            const modals = document.querySelectorAll('.modal-overlay.active');
            modals.forEach(m => {
                if(e.target === m) closeModal(m.id);
            });
        });
    });

    // --- Core Functions ---
    function updateUserProfile() {
        const user = tg.initDataUnsafe.user;
        const nameEl = document.getElementById('user-name'); const avatarEl = document.getElementById('user-avatar'); const usernameEl = document.getElementById('profile-username');
        if (user) { nameEl.innerText = [user.first_name, user.last_name].filter(Boolean).join(' '); avatarEl.src = user.photo_url || `https://i.pravatar.cc/150?u=${user.id}`; usernameEl.innerText = user.username ? `@${user.username}` : '@unknown'; } 
        else { nameEl.innerText = "Web User"; avatarEl.src = "https://i.pravatar.cc/150?u=test"; usernameEl.innerText = "@webuser"; }
        document.getElementById('profile-phone').innerText = state.userPhone; document.getElementById('profile-bio').innerText = state.userBio;
    }
    function applyTelegramTheme() {
        const p = tg.themeParams; const r = document.documentElement.style;
        if (p.bg_color) r.setProperty('--tg-theme-bg-color', p.bg_color); if (p.text_color) r.setProperty('--tg-theme-text-color', p.text_color); if (p.hint_color) r.setProperty('--tg-theme-hint-color', p.hint_color); if (p.link_color) r.setProperty('--tg-theme-link-color', p.link_color); if (p.button_color) r.setProperty('--tg-theme-button-color', p.button_color); if (p.button_text_color) r.setProperty('--tg-theme-button-text-color', p.button_text_color); if (p.secondary_bg_color) r.setProperty('--tg-theme-secondary-bg-color', p.secondary_bg_color);
    }
    function haptic(style) { if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred(style || 'light'); }
    function hapticNotify(type) { if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred(type); }

    async function fetchGiftDefinitions() { try { const res = await fetch(`${CDN_BASE}id-to-name.json`); if (!res.ok) throw new Error(); state.giftDefinitions = await res.json(); } catch (e) {} }
    async function fetchGiftParts(giftName) {
            if(cachedParts[giftName]) return cachedParts[giftName];
            try {
                const enc = encodeURIComponent(giftName);
                const [mRes, bRes, pRes] = await Promise.all([ fetch(`${CDN_BASE}models/${enc}/models.json`), fetch(`${CDN_BASE}backdrops/${enc}/backdrops.json`), fetch(`${CDN_BASE}patterns/${enc}/patterns.json`) ]);
                let models = mRes.ok ? await mRes.json() : []; let backdrops = bRes.ok ? await bRes.json() : []; let patterns = pRes.ok ? await pRes.json() : [];
                if (MY_CUSTOM_ADDITIONS[giftName]) models.push(...MY_CUSTOM_ADDITIONS[giftName]);
                
                // --- UPDATED SORTING LOGIC ---
                
                // 1. Models: Rarest (lowest rarityPermille) to Default (highest)
                models.sort((a, b) => (a.rarityPermille || 0) - (b.rarityPermille || 0));

                // 2. Backdrops: Pinned specific colors, then Alphabetical
                const pinnedBackdrops = ["Black", "Midnight Blue", "Electric Purple"];
                backdrops.sort((a, b) => {
                    const idxA = pinnedBackdrops.indexOf(a.name);
                    const idxB = pinnedBackdrops.indexOf(b.name);
                    
                    // If both are pinned, sort by priority in list
                    if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                    // If A is pinned, it comes first
                    if (idxA !== -1) return -1;
                    // If B is pinned, it comes first
                    if (idxB !== -1) return 1;
                    
                    // Otherwise alphabetical
                    return a.name.localeCompare(b.name);
                });

                cachedParts[giftName] = { models, backdrops, patterns };
                return cachedParts[giftName];
            } catch { return { models: [], backdrops: [], patterns: [] }; }
        }

    // --- Renderers ---
    function renderShop() {
        const grid = document.getElementById('shop-grid'); grid.innerHTML = '';
        Object.entries(state.giftDefinitions).forEach(([id, name]) => {
            if (['custom_skebob', 'custom_baggin_cat'].includes(id)) return;
            const el = document.createElement('div'); el.className = 'buy-gift-item';
            el.innerHTML = `<div class="image-container"><img src="${CDN_BASE}originals/${id}/Original.png" loading="lazy" onerror="this.style.display='none'"></div><div class="gift-name">${name}</div><div class="gift-price">Free</div>`;
            el.onclick = () => buyGift(id, name);
            el.addEventListener('touchstart', (e) => startShopLongPress(e, id, name), {passive:false}); el.addEventListener('touchend', cancelLongPress);
            el.addEventListener('contextmenu', (e) => { e.preventDefault(); openQtyModal(id, name); });
            grid.appendChild(el);
        });
    }
    function renderInventory() {
        const grid = document.getElementById('inventory-grid');
        if (appRuntime.reordering) return;
        grid.innerHTML = '';
        let displayList = state.settings.showHidden ? state.inventory : state.inventory.filter(g => !g.hidden);
        document.getElementById('gift-count-display').innerText = `${state.inventory.length} gifts`;
        updateActionToolbar();
        if (displayList.length === 0) { grid.innerHTML = `<div style="grid-column:span 3; text-align:center; padding:40px 20px; color:var(--tg-theme-hint-color);">${state.inventory.length>0?"All hidden.":"Empty."}</div>`; return; }
        
        displayList.sort((a, b) => {
            if (a.pinned && !b.pinned) return -1; if (!a.pinned && b.pinned) return 1;
            if (a.pinned) return (a.pinOrder||0) - (b.pinOrder||0); return b.timestamp - a.timestamp;
        });

        displayList.forEach(gift => {
            const el = document.createElement('div'); el.className = 'gift-card'; el.dataset.id = gift.uniqueId;
            if (gift.pinned) el.dataset.pinned = "true"; if (gift.hidden) el.classList.add('is-hidden');
            if (appRuntime.selectionMode === 'hide' && appRuntime.selectedIds.has(gift.uniqueId)) el.classList.add('selected');
            
            if (appRuntime.selectionMode) el.onclick = () => toggleSelection(gift.uniqueId);
            else {
                el.addEventListener('touchstart', (e) => startInventoryLongPress(e, gift), {passive:false}); el.addEventListener('touchend', cancelLongPress); el.addEventListener('touchmove', cancelLongPress);
                el.addEventListener('contextmenu', (e) => { e.preventDefault(); openMenu(e, gift); });
            }

            let visualHtml = '', topIcon = '';
            if(gift.pinned && !appRuntime.selectionMode) topIcon = `<div class="status-icon">${PIN_ICON}</div>`;
            if(gift.worn && !appRuntime.selectionMode) topIcon = `<div class="status-icon">${WEAR_ICON}</div>`;

            if (gift.isCollectible) {
                const cd = gift.collectibleData;
                const bgStyle = `radial-gradient(circle, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
                const imgUrl = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
                if (state.settings.animations) { visualHtml = `<div class="lottie-wrapper" id="lot-${gift.uniqueId}"></div>`; setTimeout(() => playLottie(`lot-${gift.uniqueId}`, cd.model.isCustom ? cd.model.lottieUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/lottie/${encodeURIComponent(cd.model.name)}.json`), 0); } 
                else visualHtml = `<img src="${imgUrl}" loading="lazy">`;
                el.innerHTML = `${topIcon}<div class="top-right-label">#${gift.collectibleNumber}</div><div class="gift-card-bg-pattern" style="background:${bgStyle}"></div><div class="dynamic-pattern-container" id="pat-${gift.uniqueId}"></div><div class="image-container">${visualHtml}</div>`; 
                setTimeout(() => generatePattern(`pat-${gift.uniqueId}`, cd.pattern, gift.name, true, cd.backdrop.hex.patternColor), 0);
                if (!appRuntime.selectionMode) el.onclick = () => openCollectibleModal(gift, false);
            } else {
                const imgUrl = `${CDN_BASE}originals/${gift.originalId}/Original.png`;
                if (state.settings.animations) { visualHtml = `<div class="lottie-wrapper" id="lot-${gift.uniqueId}"></div>`; setTimeout(() => playLottie(`lot-${gift.uniqueId}`, `${CDN_BASE}originals/${gift.originalId}/Original.json`), 0); } 
                else visualHtml = `<img src="${imgUrl}" loading="lazy">`;
                el.innerHTML = `<div class="image-container">${visualHtml}</div>`;
                if (!appRuntime.selectionMode) el.onclick = () => openDetailModal(gift);
            }
            grid.appendChild(el);
        });
    }
    function updateActionToolbar() {
        const toolbar = document.getElementById('action-toolbar'); toolbar.innerHTML = ''; toolbar.className = 'hidden';
        if (appRuntime.selectionMode === 'hide') { toolbar.className = ''; toolbar.style.borderBottom = '1px solid rgba(255,255,255,0.05)'; toolbar.innerHTML = `<button class="action-button" onclick="cancelSelectionMode()" style="background:var(--tg-theme-button-color);">Cancel</button><button class="action-button" onclick="confirmHideSelected()" style="background:var(--app-accent-blue);">Hide (${appRuntime.selectedIds.size})</button>`; return; }
        if (state.inventory.some(g => !g.isCollectible)) { toolbar.className = ''; toolbar.style.borderBottom = 'none'; toolbar.innerHTML = `<button class="action-button" onclick="handleUpgradeAll()" style="background:var(--app-accent-blue);">✨ Upgrade All</button>`; }
    }

    // --- Actions ---
    function buyGift(id, name, qty = 1) { for(let i=0; i<qty; i++) state.inventory.unshift({ uniqueId: Date.now()+Math.random()+i, originalId: id, name: name, isCollectible: false, timestamp: Date.now()+i }); saveState(); renderInventory(); if(qty===1) switchTab('inventory'); hapticNotify('success'); }
    function startShopLongPress(e, id, name) { appRuntime.longPressTimer = setTimeout(() => { haptic('medium'); openQtyModal(id, name); }, 500); }
    function startInventoryLongPress(e, gift) { appRuntime.longPressTimer = setTimeout(() => { haptic('medium'); openMenu(e.touches[0], gift); }, 500); }
    function cancelLongPress() { clearTimeout(appRuntime.longPressTimer); }
    function openQtyModal(id, name) { appRuntime.shopGiftData = { id, name }; document.getElementById('qty-modal').classList.add('active'); document.getElementById('qty-input').value = 1; tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('qty-modal')); }
    function handleBuyMultiple() { const qty = parseInt(document.getElementById('qty-input').value); if(qty>0) buyGift(appRuntime.shopGiftData.id, appRuntime.shopGiftData.name, qty); closeModal('qty-modal'); }

    // --- UPGRADE SYSTEM ---
    async function handleUpgrade() {
        const btn = document.getElementById('btn-upgrade'); 
        btn.innerText = "Preparing...";
        const gift = state.inventory.find(g => g.uniqueId === appRuntime.activeGiftId);
        
        // 1. Fetch parts
        const parts = await fetchGiftParts(gift.name);
        
        // FILTER: Exclude crafted models for standard upgrades
        const validModels = parts.models.filter(m => !m.crafted);
        // Fallback to all models if for some reason validModels is empty
        const modelPool = validModels.length > 0 ? validModels : parts.models;

        if (!modelPool.length) { alert("No parts!"); return; }

        // 2. Generate Result
        gift.isCollectible = true;
        state.lastCollectibleNumber++;
        gift.collectibleNumber = state.lastCollectibleNumber;
        
        gift.collectibleData = {
            model: modelPool[Math.floor(Math.random() * modelPool.length)],
            backdrop: parts.backdrops[Math.floor(Math.random() * parts.backdrops.length)],
            pattern: parts.patterns[Math.floor(Math.random() * parts.patterns.length)]
        };

        // 3. Save State
        saveState(); 
        renderInventory(); 
        closeModal('detail-modal');

        // 4. Start Roulette Animation
        // Pass the filtered pool to the roulette so it doesn't show crafted items in the strip
        openCollectibleModal(gift, true, { ...parts, models: modelPool });
        btn.innerText = "Upgrade";
    }

    async function handleUpgradeAll() {
        const toUpgrade = state.inventory.filter(g => !g.isCollectible);
        if(!toUpgrade.length) return;
        
        const btn = document.querySelector('#action-toolbar button'); 
        btn.innerText = `Upgrading ${toUpgrade.length}...`; 
        btn.disabled = true;
        
        for (let g of toUpgrade) {
            const parts = await fetchGiftParts(g.name);
            
            // FILTER: Exclude crafted models
            const validModels = parts.models.filter(m => !m.crafted);
            const modelPool = validModels.length > 0 ? validModels : parts.models;

            if(modelPool.length) {
                g.isCollectible = true; 
                state.lastCollectibleNumber++; 
                g.collectibleNumber = state.lastCollectibleNumber;
                g.collectibleData = { 
                    model: modelPool[Math.floor(Math.random() * modelPool.length)], 
                    backdrop: parts.backdrops[Math.floor(Math.random() * parts.backdrops.length)], 
                    pattern: parts.patterns[Math.floor(Math.random() * parts.patterns.length)] 
                };
            }
        }
        hapticNotify('success'); 
        saveState(); 
        renderInventory();
    }

    // --- ROULETTE / COLLECTIBLE MODAL LOGIC ---
    function openCollectibleModal(gift, isUpgrading = false, partsPool = null) {
        // FIX: Update the global active ID so the button finds the correct gift
        appRuntime.activeGiftId = gift.uniqueId;

        // Note: The rest of the original function logic follows here
        
        haptic('light');
        const cd = gift.collectibleData;
        
        const modal = document.getElementById('collectible-modal');
        const header = document.getElementById('collectible-header');
        const imgEl = document.getElementById('collectible-image');
        const lottieEl = document.getElementById('collectible-lottie');
        const rouletteStrip = document.getElementById('roulette-strip');
        const btn = document.getElementById('btn-collectible-action');

        // Reset Visuals
        header.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
        document.getElementById('collectible-pattern-container').innerHTML = '';
        generatePattern('collectible-pattern-container', cd.pattern, gift.name, false, cd.backdrop.hex.patternColor);

        // Titles
        document.getElementById('collectible-title').innerText = `${gift.name} #${gift.collectibleNumber.toLocaleString()}`;
        document.getElementById('collectible-model-name').innerText = cd.model.name;

        // Owner Chip
        const user = tg.initDataUnsafe.user;
        const ownerImg = document.getElementById('col-owner-img');
        ownerImg.src = user?.photo_url || "https://i.pravatar.cc/150?u=user";
        document.getElementById('col-owner-name').innerText = user?.first_name || 'You';

        // Stats (Final Values)
        const setTextAndPct = (idSlot, idPct, val, permille) => {
            const slotEl = document.getElementById(idSlot);
            // Only manually set innerHTML if we are NOT in roulette/upgrading mode
            if(!isUpgrading && slotEl) {
                slotEl.innerHTML = `<div class="slot-item">${val}</div>`;
            }
            const pctEl = document.getElementById(idPct);
            if(pctEl) {
                // LOGIC CHANGE: "Epic" for 0 permille
                if (permille === 0) {
                    pctEl.innerText = "Epic";
                    // Optional: Style adjustments for Epic
                    pctEl.style.backgroundColor = "rgba(255, 215, 0, 0.15)";
                    pctEl.style.color = "#ffd700";
                } else {
                    pctEl.innerText = `${(permille/10).toFixed(1)}%`;
                    pctEl.style.backgroundColor = ""; // Reset style
                    pctEl.style.color = ""; // Reset style
                }
            }
        };

        setTextAndPct('slot-model', 'col-model-pct', cd.model.name, cd.model.rarityPermille);
        setTextAndPct('slot-symbol', 'col-symbol-pct', cd.pattern.name, cd.pattern.rarityPermille);
        setTextAndPct('slot-backdrop', 'col-backdrop-pct', cd.backdrop.name, cd.backdrop.rarityPermille);

        // Random Secondary Stats
        const issued = Math.floor(Math.random() * 500000) + 10000;
        document.getElementById('col-quantity').innerText = `${Math.floor(Math.random()*issued).toLocaleString()} / ${issued.toLocaleString()} issued`;
        document.getElementById('col-value').innerText = `~${Math.floor(Math.random()*100)+5} TON`;

        if (isUpgrading && partsPool) {
            // === ANIMATION MODE ===
            btn.innerText = "Skip";
            btn.onclick = skipAnimation;

            const subHeader = document.getElementById('collectible-model-name');
            subHeader.style.filter = 'blur(5px)';
            subHeader.style.transition = 'filter 0.5s ease';
            
            // 1. Prepare Horizontal Roulette
            rouletteStrip.style.display = 'flex';
            imgEl.style.display = 'none'; lottieEl.style.display = 'none';
            rouletteStrip.innerHTML = '';
            
            // Fill strip with random models + FINAL model at end
            const stripLen = 30; 
            for(let i=0; i<stripLen; i++) {
                const rndModel = partsPool.models[Math.floor(Math.random() * partsPool.models.length)];
                const img = document.createElement('img');
                const src = rndModel.isCustom ? rndModel.imageUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(rndModel.name)}.png`;
                img.src = src;
                rouletteStrip.appendChild(img);
            }
            // Add Final Item
            const finalImg = document.createElement('img');
            const finalSrc = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
            finalImg.src = finalSrc;
            rouletteStrip.appendChild(finalImg);
            
            // 2. Prepare Slot Machines for Text
            initSlotMachine('slot-model', partsPool.models.map(x=>x.name), cd.model.name);
            initSlotMachine('slot-symbol', partsPool.patterns.map(x=>x.name), cd.pattern.name);
            initSlotMachine('slot-backdrop', partsPool.backdrops.map(x=>x.name), cd.backdrop.name);

            // 3. Start Animations
            appRuntime.animationState = {
                giftName: gift.name,
                finalData: cd,
                intervals: [],
                timeouts: []
            };

            // Horizontal Scroll Calculation
            const screenCenter = window.innerWidth / 2;
            const finalImageCenter = (stripLen * 160) + 80;
            const translateX = -(finalImageCenter - screenCenter);

            rouletteStrip.animate([
                { transform: 'translateX(0)' },
                { transform: `translateX(${translateX}px)` }
            ], { duration: 6000, easing: 'cubic-bezier(0.25, 0.1, 0.25, 1)', fill: 'forwards' });

            // Backdrop Strobe
            const bgInterval = setInterval(() => {
                const rndBg = partsPool.backdrops[Math.floor(Math.random()*partsPool.backdrops.length)];
                header.style.background = `radial-gradient(circle at 50% 0%, ${rndBg.hex.centerColor}, ${rndBg.hex.edgeColor})`;
            }, 100);
            appRuntime.animationState.intervals.push(bgInterval);

            // Symbol Strobe
            const patInterval = setInterval(() => {
                const rndPat = partsPool.patterns[Math.floor(Math.random()*partsPool.patterns.length)];
                document.getElementById('collectible-pattern-container').innerHTML = '';
                generatePattern('collectible-pattern-container', rndPat, gift.name, false, '#ffffff55');
            }, 100);
            appRuntime.animationState.intervals.push(patInterval);

            // SCHEDULED STOPS
            // Stop Backdrop (~2s)
            appRuntime.animationState.timeouts.push(setTimeout(() => {
                clearInterval(bgInterval);
                header.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
                stopSlotMachine('slot-backdrop', cd.backdrop.name);
                haptic('medium');
            }, 4000));

            // Stop Symbol (~4s)
            appRuntime.animationState.timeouts.push(setTimeout(() => {
                clearInterval(patInterval);
                document.getElementById('collectible-pattern-container').innerHTML = '';
                generatePattern('collectible-pattern-container', cd.pattern, gift.name, false, cd.backdrop.hex.patternColor);
                stopSlotMachine('slot-symbol', cd.pattern.name);
                haptic('medium');
            }, 6000));

            // Stop Model & Finish (~6s)
            appRuntime.animationState.timeouts.push(setTimeout(() => {
                finishAnimation();
            }, 7500));

        } else {
            // === STATIC MODE ===
            btn.innerText = "OK";
            btn.onclick = () => closeModal('collectible-modal');
            rouletteStrip.style.display = 'none';
            
            // Show Final Image/Lottie directly
            const lottiePath = cd.model.isCustom ? cd.model.lottieUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/lottie/${encodeURIComponent(cd.model.name)}.json`;
            const imgPath = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
            
            if (state.settings.animations) {
                lottieEl.style.display = 'block'; imgEl.style.display = 'none';
                playLottie('collectible-lottie', lottiePath);
            } else {
                lottieEl.style.display = 'none'; imgEl.style.display = 'block';
                imgEl.src = imgPath;
            }

            // Static Text
            document.getElementById('slot-model').innerHTML = `<div class="slot-item">${cd.model.name}</div>`;
            document.getElementById('slot-symbol').innerHTML = `<div class="slot-item">${cd.pattern.name}</div>`;
            document.getElementById('slot-backdrop').innerHTML = `<div class="slot-item">${cd.backdrop.name}</div>`;
        }

        modal.classList.add('active');
        tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('collectible-modal'));
        
        // Show craft button for owned collectibles (only for Jingle Bells/Desk Calendar as per initCraftingButton check)
        if(gift.isCollectible && !isUpgrading) {
            setTimeout(initCraftingButton, 50);
        }
    }

// Call this when opening the modal or loading a gift to reset UI state
    function resetBulkControls() {
        document.getElementById('cust-qty').value = 1;
        document.getElementById('cb-rnd-model').checked = false;
        document.getElementById('cb-rnd-backdrop').checked = false;
        document.getElementById('cb-rnd-pattern').checked = true; // Default true per request
        
        toggleRandomPart('model');
        toggleRandomPart('backdrop');
        toggleRandomPart('pattern');
    }

    function toggleRandomPart(type) {
        const isChecked = document.getElementById(`cb-rnd-${type}`).checked;
        const grid = document.getElementById(`cust-${type}-grid`);
        const label = document.getElementById(`lbl-rnd-${type}`);
        
        if (isChecked) {
            grid.style.opacity = '0.3';
            grid.style.pointerEvents = 'none';
            if(label) label.classList.remove('hidden');
        } else {
            grid.style.opacity = '1';
            grid.style.pointerEvents = 'auto';
            if(label) label.classList.add('hidden');
        }
        updateCreateButton();
    }

    // UPDATE: Modify loadBaseConfig to show/hide bulk controls and reset state
    // We replace the existing loadBaseConfig with this updated version
    async function loadBaseConfig(id, name, resetParts) { 
        haptic('light'); 
        const curr = customizationQueue[editingIndex]; 
        
        if(curr.id !== id || resetParts) { 
            curr.id = id; 
            curr.name = name; 
            curr.parts = { model:null, backdrop:null, pattern:null }; 
        } 
        
        renderQueueBar(); 
        
        const baseGrid = document.getElementById('cust-base-grid'); 
        Array.from(baseGrid.children).forEach(c => { 
            c.classList.remove('selected'); 
            if(c.innerText === name) c.classList.add('selected'); 
        }); 
        
        if(!cachedParts[id]) cachedParts[id] = await fetchGiftParts(name); 
        const parts = cachedParts[id]; 
        
        renderPartGrid('cust-model-grid', parts.models, 'model', name); 
        renderPartGrid('cust-backdrop-grid', parts.backdrops, 'backdrop', name); 
        renderPartGrid('cust-pattern-grid', parts.patterns, 'pattern', name); 
        
        document.getElementById('cust-parts-container').classList.remove('hidden'); 
        
        // --- NEW LOGIC: Bulk Controls Visibility ---
        const bulkDiv = document.getElementById('cust-bulk-controls');
        // Only show bulk controls if we are editing a single item queue
        if (customizationQueue.length === 1) {
            bulkDiv.classList.remove('hidden');
            if(resetParts) resetBulkControls(); // Reset checkboxes only on fresh load
            else {
                // Ensure UI matches current checkbox state if reopening
                toggleRandomPart('model');
                toggleRandomPart('backdrop');
                toggleRandomPart('pattern');
            }
        } else {
            bulkDiv.classList.add('hidden');
        }

        updateCreateButton(); 
    }

    /* --- CRAFTING LOGIC --- */
    let craftingState = {
        active: false,
        baseName: "",
        targetNumber: 0,
        selectedIds: [],
        maxSlots: 4
    };

    function initCraftingButton() {
        const container = document.getElementById('collectible-header');
        // Remove existing button if any to prevent stale state or duplicates
        const existingBtn = document.getElementById('craft-btn-overlay');
        if (existingBtn) existingBtn.remove();

        // 1. Get the current gift
        const gift = state.inventory.find(g => g.uniqueId === appRuntime.activeGiftId);
        if (!gift) return;

        // 2. Whitelist Check: Only allow specific gifts
        const ALLOWED_CRAFT_GIFTS = ["Jingle Bells", "Desk Calendar"];
        if (!ALLOWED_CRAFT_GIFTS.includes(gift.name)) return;

        // 3. Crafted Check: If this gift is already a result of crafting, it cannot be used again.
        if (gift.collectibleData && gift.collectibleData.model.crafted) return;

        const btn = document.createElement('div');
        btn.id = 'craft-btn-overlay';
        btn.className = 'craft-header-btn';
        btn.innerHTML = `<div class="craft-icon"></div>`;
        btn.onclick = (e) => {
            e.stopPropagation();
            if(gift) openCraftModal(gift);
        };
        container.appendChild(btn);
    }

    // Hook into openCollectibleModal
    const originalOpenCol = openCollectibleModal;
    openCollectibleModal = function(gift, isUpgrading, parts) {
        // FIX: Update the global active ID so the button finds the correct gift
        appRuntime.activeGiftId = gift.uniqueId; 
        
        originalOpenCol(gift, isUpgrading, parts);
        
        // Only show craft button for owned collectibles (not during upgrade animation)
        if(gift.isCollectible && !isUpgrading) {
            setTimeout(initCraftingButton, 50);
        }
    };

    function openCraftModal(initialGift) {
        if(!initialGift) return; // Safety check
        // Add this inside openCraftModal()
        const mixCheckbox = document.getElementById('cb-mix-backdrop');
        if (mixCheckbox) mixCheckbox.checked = false;
        craftingState.baseName = initialGift.name;
        craftingState.selectedIds = [initialGift.uniqueId];
        craftingState.active = true;
        
        // Target Number is based on the first gift added
        craftingState.targetNumber = initialGift.collectibleNumber;
        
        updateCraftUI();
        document.getElementById('craft-modal').classList.add('active');
        // We do NOT close the underlying collectible modal, just cover it, 
        // or close it if you prefer. Closing it is cleaner:
        closeModal('collectible-modal'); 
    }

    function updateCraftUI() {
        const slots = [0, 1, 2, 3];
        const gifts = craftingState.selectedIds.map(id => state.inventory.find(g => g.uniqueId === id));
        
        // Update Target Text
        const targetGift = state.inventory.find(g => g.uniqueId === craftingState.selectedIds[0]);
        if(targetGift) {
            document.getElementById('craft-target-name').innerText = `${craftingState.baseName} #${targetGift.collectibleNumber}`;
        }

        
        // Render Slots
        slots.forEach(i => {
            const el = document.getElementById(`slot-${i}`);
            el.innerHTML = '';
            if (gifts[i]) {
                const cd = gifts[i].collectibleData;
                const bgStyle = `radial-gradient(circle, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
                
                const img = document.createElement('img');
                img.src = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(gifts[i].name)}/png/${encodeURIComponent(cd.model.name)}.png`;
                
                const rm = document.createElement('div');
                rm.className = 'remove-btn';
                rm.innerText = '✕';
                rm.onclick = (e) => { e.stopPropagation(); removeCraftItem(gifts[i].uniqueId); };
                
                el.style.background = bgStyle;
                el.appendChild(img);
                el.appendChild(rm);
            } else {
                el.style.background = 'rgba(255,255,255,0.1)';
                el.innerHTML = `<span class="add-icon">+</span>`;
            }
        });

        // --- NEW PROBABILITY MATH ---
        let chance = 0;
        gifts.forEach(g => {
            if(!g) return;
            // 1. Base Volume: 20% per gift
            let itemVal = 20; 
            
            // 2. Rarity Bonus
            const p = g.collectibleData.model.rarityPermille || 1000;
            if(p < 10) itemVal += 2;      // Rare (<1%): +2%
            else if(p < 100) itemVal += 1; // Uncommon (<10%): +1%
            // Common (>10%): +0%

            chance += itemVal;
        });

        // --- ADDED: Backdrop Mixing Checkbox Logic ---
        const mixContainer = document.getElementById('craft-mix-container');
        const mixCheckbox = document.getElementById('cb-mix-backdrop');
        if(mixContainer && mixCheckbox) {
            // Check how many unique backdrops are currently in the slots
            const uniqueBackdrops =[...new Set(gifts.filter(g => g).map(g => g.collectibleData.backdrop.name))];
            
            if(uniqueBackdrops.length >= 2) {
                mixContainer.style.opacity = '1';
                mixContainer.style.pointerEvents = 'auto';
            } else {
                mixContainer.style.opacity = '0.5';
                mixContainer.style.pointerEvents = 'none';
                mixCheckbox.checked = false;
            }
        }
        
        // Cap at 0 if empty
        if(gifts.length === 0) chance = 0;
        
        // Update Ring
        const radius = 45;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (chance / 100) * circumference;
        const ring = document.getElementById('craft-progress-ring');
        if(ring) {
            ring.style.strokeDasharray = `${circumference} ${circumference}`;
            ring.style.strokeDashoffset = offset;
            ring.style.stroke = chance < 50 ? '#ff595a' : '#ffffff'; 
        }
        
        document.getElementById('craft-chance-text').innerText = `${chance}%`;
        
        const btn = document.getElementById('btn-craft-action');
        if(btn) {
            btn.innerHTML = `Craft Gift <br><span class="craft-btn-subtext">${chance}% Success Chance</span>`;
            btn.disabled = gifts.length === 0;
        }

        // Render Backdrop Probs (Simple visualization of inputs)
        const probContainer = document.getElementById('craft-probs');
        if(probContainer) {
            probContainer.innerHTML = '';
            let backdropsMap = {};
            // Count filled slots
            gifts.forEach(g => {
                if(!g) return;
                const bgName = g.collectibleData.backdrop.name;
                const bgHex = g.collectibleData.backdrop.hex.centerColor;
                if(!backdropsMap[bgName]) backdropsMap[bgName] = { count: 0, hex: bgHex };
                backdropsMap[bgName].count++;
            });
            
            // Add "Random" for empty slots logic visualization?
            // User asked for logic logic, but visual can remain simple or show "Random"
            // Let's stick to showing input percentages for now to avoid UI clutter
            const totalInputs = gifts.length || 1;
            Object.keys(backdropsMap).forEach(key => {
                const data = backdropsMap[key];
                const pct = Math.round((data.count / totalInputs) * 100);
                const pill = document.createElement('div');
                pill.className = 'prob-pill';
                pill.innerHTML = `<div class="prob-dot" style="background:${data.hex}"></div> ${pct}%`;
                probContainer.appendChild(pill);
            });
        }
    }

    function removeCraftItem(id) {
        if(craftingState.selectedIds.length <= 1) return;
        craftingState.selectedIds = craftingState.selectedIds.filter(x => x !== id);
        updateCraftUI();
    }

    function openCraftSelect() {
        if(craftingState.selectedIds.length >= 4) return;
        
        const grid = document.getElementById('craft-select-grid');
        grid.innerHTML = '';
        
        // FILTER UPDATED: Exclude gifts that are already 'crafted'
        const candidates = state.inventory.filter(g => 
            g.name === craftingState.baseName && 
            g.isCollectible && 
            !g.hidden &&
            !craftingState.selectedIds.includes(g.uniqueId) &&
            !g.collectibleData.model.crafted // <--- New Check: Cannot be a crafted item
        );

        if(candidates.length === 0) {
            grid.innerHTML = '<div style="grid-column:span 3; text-align:center; padding:20px; color:gray;">No other matching gifts available.</div>';
        }

        candidates.forEach(g => {
            const el = document.createElement('div');
            el.className = 'craft-select-item';
            const cd = g.collectibleData;
            const bgStyle = `radial-gradient(circle, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
            
            el.style.background = bgStyle;
            el.innerHTML = `
                <span class="rarity-badge">${g.collectibleNumber}</span>
                <img src="${cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(g.name)}/png/${encodeURIComponent(cd.model.name)}.png`}">
            `;
            el.onclick = () => {
                craftingState.selectedIds.push(g.uniqueId);
                updateCraftUI();
                closeModal('craft-select-modal');
            };
            grid.appendChild(el);
        });
        
        document.getElementById('craft-select-modal').classList.add('active');
    }

    async function startCrafting() {
        // 1. Calculate Success (Same logic as UI)
        let chance = 0;
        const gifts = craftingState.selectedIds.map(id => state.inventory.find(g => g.uniqueId === id));
        
        gifts.forEach(g => {
            if(!g) return;
            let itemVal = 20; 
            const p = g.collectibleData.model.rarityPermille || 1000;
            if(p < 10) itemVal += 2;
            else if(p < 100) itemVal += 1;
            chance += itemVal;
        });
        
        // Roll for success
        const isSuccess = (Math.random() * 100) < chance;

        // 2. Animation Setup
        const animModal = document.getElementById('craft-anim-modal');
        const cube = document.getElementById('craft-cube');
        const statusText = document.getElementById('craft-anim-status');
        const faces = cube.querySelectorAll('.cube-face img');
        
        // Setup visuals for the cube
        for(let i=0; i<4; i++) {
            const g = gifts[i % gifts.length];
            if(g) {
                const cd = g.collectibleData;
                faces[i].src = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(g.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
            }
        }

        animModal.classList.add('active');
        cube.classList.remove('spinning', 'burning'); 
        void cube.offsetWidth; 
        cube.classList.add('spinning');
        
        haptic('medium');
        statusText.innerText = "Heating up the anvil...";
        
        setTimeout(() => { 
            statusText.innerText = "Fusing atoms..."; 
            haptic('light'); 
        }, 1000);

        // 3. Resolution
        setTimeout(async () => {
            // Keep copy of consumed gifts for the failure screen before deleting
            const consumedGifts = [...gifts];

            // Remove items from inventory
            state.inventory = state.inventory.filter(g => !craftingState.selectedIds.includes(g.uniqueId));
            
            if (isSuccess) {
                statusText.innerText = "Constructing form...";
                haptic('medium');
                
                const parts = await fetchGiftParts(craftingState.baseName);
                
                // --- A. EXCLUSIVE POOL SELECTION ---
                let craftedModels = parts.models.filter(m => m.crafted === true);
                if (craftedModels.length === 0) craftedModels = parts.models.filter(m => (m.rarityPermille || 0) < 10);
                const newModel = craftedModels[Math.floor(Math.random() * craftedModels.length)];
                
                // --- B. BACKDROP VOTING LOGIC & MIXING ---
                let winningBackdrop;
                const isMixChecked = document.getElementById('cb-mix-backdrop')?.checked;

                if (isMixChecked) {
                    // Extract and sort unique backdrops by rarity (lowest permille = best)
                    const distinctBGs =[];
                    const seenNames = new Set();
                    
                    const sortedGifts = [...consumedGifts].sort((a, b) => 
                        (a.collectibleData.backdrop.rarityPermille || 1000) - (b.collectibleData.backdrop.rarityPermille || 1000)
                    );

                    for (const g of sortedGifts) {
                        const bg = g.collectibleData.backdrop;
                        if (!seenNames.has(bg.name)) {
                            seenNames.add(bg.name);
                            distinctBGs.push(bg);
                        }
                    }
                    
                    // Take the 2 best unique backdrops
                    const bg1 = distinctBGs[0];
                    const bg2 = distinctBGs[1];

                    // Create the mixed backdrop
                    winningBackdrop = {
                        name: `${bg1.name} + ${bg2.name}`, // Sets the text to "Name1 + Name2"
                        hex: {
                            centerColor: bg1.hex.centerColor, // Center from the best backdrop
                            edgeColor: bg2.hex.edgeColor,     // Edge from the second best
                            patternColor: bg1.hex.patternColor
                        },
                        rarityPermille: Math.min(bg1.rarityPermille || 1000, bg2.rarityPermille || 1000)
                    };
                } else {
                    // Standard voting logic
                    const slotRoll = Math.floor(Math.random() * 4); 
                    if (slotRoll < gifts.length) {
                        winningBackdrop = gifts[slotRoll].collectibleData.backdrop;
                    } else {
                        winningBackdrop = parts.backdrops[Math.floor(Math.random() * parts.backdrops.length)];
                    }
                }

                // --- C. Pattern Logic (Random) ---
                const newPattern = parts.patterns[Math.floor(Math.random() * parts.patterns.length)];

                const newGift = {
                    uniqueId: Date.now(),
                    originalId: consumedGifts[0].originalId,
                    name: craftingState.baseName,
                    isCollectible: true,
                    timestamp: Date.now(),
                    pinned: false,
                    worn: false,
                    collectibleNumber: craftingState.targetNumber,
                    collectibleData: {
                        model: newModel,
                        backdrop: winningBackdrop,
                        pattern: newPattern
                    }
                };
                
                state.inventory.unshift(newGift);
                saveState();
                renderInventory();
                
                animModal.classList.remove('active');
                closeModal('craft-modal');
                setTimeout(() => openCollectibleModal(newGift, false), 300);
                confetti({ particleCount: 200, spread: 100, zIndex: 3000 });
                hapticNotify('success');

            } else {
                // --- FAILURE LOGIC ---
                statusText.innerText = "Instability detected...";
                cube.classList.remove('spinning');
                cube.classList.add('burning');
                hapticNotify('error');
                
                saveState();
                renderInventory();
                
                setTimeout(() => {
                    animModal.classList.remove('active');
                    closeModal('craft-modal');
                    // Show custom Failure Screen
                    showFailureScreen(consumedGifts);
                }, 1600);
            }
        }, 2500);
    }

    function showFailureScreen(lostGifts) {
        const modal = document.getElementById('failure-modal');
        const grid = document.getElementById('failed-items-grid');
        const countText = document.getElementById('fail-count-text');
        
        countText.innerText = lostGifts.length;
        grid.innerHTML = '';
        
        lostGifts.forEach(g => {
            const cd = g.collectibleData;
            const el = document.createElement('div');
            // Mini gift card style
            el.style.cssText = `
                width: 70px; height: 70px; 
                background: radial-gradient(circle, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor});
                border-radius: 12px; position: relative; overflow: hidden;
                display: flex; align-items: center; justify-content: center;
            `;
            
            // Image
            const img = document.createElement('img');
            img.src = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(g.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
            img.style.cssText = "width: 80%; height: 80%; object-fit: contain; filter: grayscale(100%) brightness(0.7);";
            
            // "Number" Tag (Red/Burnt look)
            const tag = document.createElement('div');
            tag.innerText = `#${g.collectibleNumber}`;
            tag.style.cssText = `
                position: absolute; top: 0px; right: 0px; 
                background: #ff595a; color: white; 
                font-size: 0.6em; padding: 2px 6px; 
                border-bottom-left-radius: 6px; font-weight: bold;
            `;
            
            // Burnt overlay/icon
            const burntIcon = document.createElement('div');
            burntIcon.innerText = "✕";
            burntIcon.style.cssText = "position: absolute; color: rgba(255,255,255,0.5); font-size: 24px;";

            el.appendChild(img);
            el.appendChild(tag);
            // el.appendChild(burntIcon); // Optional: add X over item
            grid.appendChild(el);
        });
        
        modal.classList.add('active');
    }

    function retryCrafting() {
        closeModal('failure-modal');
        // We assume the user stays on the same gift type context.
        // We can't automatically re-select items because they were burned.
        // So we just reopen the empty craft modal for the same gift type if possible.
        
        // Find a gift of the same type in inventory to restart the process
        const sameTypeGift = state.inventory.find(g => 
            g.name === craftingState.baseName && 
            g.isCollectible && 
            !g.collectibleData.model.crafted
        );
        
        if(sameTypeGift) {
            openCraftModal(sameTypeGift);
        } else {
            // No more gifts of this type
            tg.showAlert("No more gifts of this type available to craft!");
        }
    }

    // --- Animation Helpers ---
    function initSlotMachine(elementId, options, finalValue) {
        const wrapper = document.getElementById(elementId);
        wrapper.innerHTML = '';
        const scroll = document.createElement('div');
        scroll.className = 'slot-scroll';
        scroll.id = `${elementId}-scroll`;
        
        // Populate random items
        let html = '';
        for(let i=0; i<30; i++) {
            html += `<div class="slot-item">${options[Math.floor(Math.random()*options.length)]}</div>`;
        }
        // Append final value
        html += `<div class="slot-item" id="${elementId}-final">${finalValue}</div>`;
        scroll.innerHTML = html;
        wrapper.appendChild(scroll);

        // Start scrolling
        scroll.animate([
            { transform: 'translateY(0)' },
            { transform: 'translateY(-90%)' } // Scroll most of the way
        ], { duration: 6000, iterations: 1 });
    }

    function stopSlotMachine(elementId, finalValue) {
        const scroll = document.getElementById(`${elementId}-scroll`);
        if(scroll) {
            scroll.getAnimations().forEach(anim => anim.cancel());
            // Snap to final
            scroll.style.transform = 'none';
            scroll.innerHTML = `<div class="slot-item">${finalValue}</div>`;
        }
    }

    function skipAnimation() {
        if (!appRuntime.animationState) return;
        appRuntime.animationState.intervals.forEach(clearInterval);
        appRuntime.animationState.timeouts.forEach(clearTimeout);
        finishAnimation();
    }

    function finishAnimation() {
        if (!appRuntime.animationState) return;
        const subHeader = document.getElementById('collectible-model-name');
        subHeader.style.filter = 'blur(0px)';
        const st = appRuntime.animationState;
        const cd = st.finalData;
        const giftName = st.giftName;

        // Stop Text Slots
        stopSlotMachine('slot-model', cd.model.name);
        stopSlotMachine('slot-symbol', cd.pattern.name);
        stopSlotMachine('slot-backdrop', cd.backdrop.name);

        // Finalize Visuals
        const header = document.getElementById('collectible-header');
        header.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
        document.getElementById('collectible-pattern-container').innerHTML = '';
        generatePattern('collectible-pattern-container', cd.pattern, giftName, false, cd.backdrop.hex.patternColor);

        // Swap Roulette for Final Image
        document.getElementById('roulette-strip').style.display = 'none';
        
        const lottieEl = document.getElementById('collectible-lottie');
        const imgEl = document.getElementById('collectible-image');
        const lottiePath = cd.model.isCustom ? cd.model.lottieUrl : `${CDN_BASE}models/${encodeURIComponent(giftName)}/lottie/${encodeURIComponent(cd.model.name)}.json`;
        const imgPath = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(giftName)}/png/${encodeURIComponent(cd.model.name)}.png`;

        if (state.settings.animations) {
            lottieEl.style.display = 'block'; imgEl.style.display = 'none';
            playLottie('collectible-lottie', lottiePath);
        } else {
            lottieEl.style.display = 'none'; imgEl.style.display = 'block';
            imgEl.src = imgPath;
        }

        // Confetti - zIndex fixed
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 2001 });
        hapticNotify('success');

        // Reset Button
        const btn = document.getElementById('btn-collectible-action');
        btn.innerText = "OK";
        btn.onclick = () => closeModal('collectible-modal');

        appRuntime.animationState = null;
    }


    // --- Generic UI (Updated) ---
    async function openDetailModal(gift) {
        appRuntime.activeGiftId = gift.uniqueId;
        document.getElementById('detail-title').innerText = gift.name;
        const imgEl = document.getElementById('detail-image');
        imgEl.style.display = 'block';
        document.getElementById('detail-lottie').style.display = 'none';
        
        const parts = await fetchGiftParts(gift.name);
        if (parts.models.length > 0) {
            // Corrected: Start from a random index
            let partIndex = Math.floor(Math.random() * parts.models.length);
            
            const setModel = (idx) => {
                const model = parts.models[idx];
                imgEl.src = model.isCustom ? model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(model.name)}.png`;
            };
    
            setModel(partIndex);
            
            if(parts.models.length > 1) {
                // Corrected: Interval changed to 2000ms
                appRuntime.detailInterval = setInterval(() => {
                    partIndex = (partIndex + 1) % parts.models.length;
                    setModel(partIndex);
                }, 2000);
            }
        } else {
            imgEl.src = `${CDN_BASE}originals/${gift.originalId}/Original.png`;
        }
        document.getElementById('detail-modal').classList.add('active');
        tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('detail-modal'));
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
        tg.BackButton.hide();
        if(id==='detail-modal') {
            document.getElementById('detail-lottie').innerHTML='';
            if(appRuntime.detailInterval) { clearInterval(appRuntime.detailInterval); appRuntime.detailInterval = null; }
        }
        if(id==='collectible-modal') { document.getElementById('collectible-lottie').innerHTML=''; document.getElementById('roulette-strip').innerHTML=''; if(appRuntime.animationState) skipAnimation(); }
        if (document.getElementById('shop-page').classList.contains('active')) { tg.BackButton.show(); tg.BackButton.onClick(() => switchTab('inventory')); }
    }
    
    // ... (Rest of existing functions like switchTab, playLottie, generatePattern, settings, etc. remain unchanged) ...
    function switchTab(tab) {
        haptic('light'); document.getElementById('profile-page').classList.remove('active'); document.getElementById('shop-page').classList.remove('active'); document.querySelectorAll('.profile-tabs button').forEach(b => b.classList.remove('active'));
        if (tab === 'inventory') { document.getElementById('profile-page').classList.add('active'); document.querySelectorAll('.profile-tabs button')[0].classList.add('active'); tg.BackButton.hide(); } 
        else { document.getElementById('shop-page').classList.add('active'); document.querySelectorAll('.profile-tabs button')[1].classList.add('active'); tg.BackButton.show(); tg.BackButton.onClick(() => switchTab('inventory')); }
    }
    function playLottie(id, path) { const container = document.getElementById(id); container.innerHTML = ''; lottie.loadAnimation({ container, renderer:'svg', loop:true, autoplay:true, path }); }
    function generatePattern(containerId, patternObj, giftName, isSmall, colorHex, isHeader=false) {
        const container = document.getElementById(containerId); if (!container) return; const url = `${CDN_BASE}patterns/${encodeURIComponent(giftName)}/png/${encodeURIComponent(patternObj.name)}.png`;
        let configs = isHeader ? [{ count: 12, radius: 100, size: 40 }, { count: 16, radius: 150, size: 36 }] : [{ count: 10, radius: isSmall ? 38 : 100, size: isSmall ? 12 : 36 }, { count: 12, radius: isSmall ? 62 : 150, size: isSmall ? 10 : 30 }];
        configs.forEach(conf => { for(let i=0; i<conf.count; i++) { const angle = (i/conf.count)*2*Math.PI; const x = conf.radius*Math.cos(angle); const y = conf.radius*Math.sin(angle); const el = document.createElement('div'); if(isHeader) el.className = 'profile-pattern-item'; else el.className = 'card-pattern-symbol'; el.style.webkitMaskImage = `url('${url}')`; el.style.maskImage = `url('${url}')`; if (colorHex) el.style.backgroundColor = colorHex; el.style.width = `${conf.size}px`; el.style.height = `${conf.size}px`; el.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`; container.appendChild(el); } });
    }
    function openSettingsModal() { document.getElementById('settings-modal').classList.add('active'); document.getElementById('setting-animations').checked = state.settings.animations; document.getElementById('setting-hidden').checked = state.settings.showHidden; tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('settings-modal')); }
    function toggleSetting(key, value) { state.settings[key] = value; haptic('light'); saveState(); renderInventory(); }
    function saveState() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function loadState() { const saved = localStorage.getItem(LS_KEY); if (saved) { const parsed = JSON.parse(saved); state.inventory = parsed.inventory || []; state.lastCollectibleNumber = parsed.lastCollectibleNumber || 100; state.userBio = parsed.userBio || "Hello world"; state.userPhone = parsed.userPhone || ""; if(parsed.settings) state.settings = parsed.settings; } }
    function resetAppData() { tg.showConfirm("Reset App?", (confirmed) => { if(confirmed) { localStorage.removeItem(LS_KEY); location.reload(); }}); }
    
    // --- Context Menu & Queue Logic ---
    function openMenu(e, gift) { appRuntime.activeGiftId = gift.uniqueId; const menu = document.getElementById('long-press-menu'); document.getElementById('menu-pin').style.display = gift.isCollectible?'block':'none'; document.getElementById('menu-pin').innerText = gift.pinned?"Unpin":"Pin"; document.getElementById('menu-wear').style.display = gift.isCollectible?'block':'none'; document.getElementById('menu-wear').innerText = gift.worn?"Take Off":"Wear"; document.getElementById('menu-reorder').style.display = (gift.isCollectible&&gift.pinned&&state.inventory.filter(g=>g.pinned).length>1)?'block':'none'; document.getElementById('menu-hide').innerText = gift.hidden?"Unhide":"Hide"; let x = e.clientX, y = e.clientY; if(x+180>window.innerWidth) x=window.innerWidth-190; if(y+160>window.innerHeight) y=window.innerHeight-170; menu.style.left=x+'px'; menu.style.top=y+'px'; menu.classList.remove('hidden'); }
    function togglePin() { const g = state.inventory.find(x=>x.uniqueId===appRuntime.activeGiftId); if(g.pinned) {g.pinned=false;g.pinOrder=null;} else {if(state.inventory.filter(x=>x.pinned).length>=6) return alert("Max 6"); g.pinned=true;g.pinOrder=999;} document.getElementById('long-press-menu').classList.add('hidden'); haptic('light'); saveState(); renderInventory(); }
    function toggleWear() { const g = state.inventory.find(x=>x.uniqueId===appRuntime.activeGiftId); if(g.worn) g.worn=false; else {state.inventory.forEach(x=>x.worn=false); g.worn=true;} document.getElementById('long-press-menu').classList.add('hidden'); hapticNotify('success'); saveState(); renderInventory(); applyWornGiftVisuals(); }
    function applyWornGiftVisuals() { const worn = state.inventory.find(g => g.worn); const bg = document.getElementById('profile-bg'); document.getElementById('profile-pattern-overlay').innerHTML = ''; if (worn) { const cd = worn.collectibleData; bg.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`; bg.classList.add('has-worn-gift'); generatePattern('profile-pattern-overlay', cd.pattern, worn.name, false, cd.backdrop.hex.patternColor, true); } else { bg.style.background = 'var(--app-profile-gradient-fallback)'; bg.classList.remove('has-worn-gift'); } }
    function toggleHide() { const g = state.inventory.find(x=>x.uniqueId===appRuntime.activeGiftId); g.hidden=!g.hidden; if(g.hidden){g.pinned=false;g.worn=false;} document.getElementById('long-press-menu').classList.add('hidden'); haptic('light'); saveState(); renderInventory(); applyWornGiftVisuals(); }
    function deleteGift() { tg.showConfirm("Delete?",(y)=>{if(y){state.inventory=state.inventory.filter(x=>x.uniqueId!==appRuntime.activeGiftId); haptic('heavy'); saveState(); renderInventory(); applyWornGiftVisuals();}}); document.getElementById('long-press-menu').classList.add('hidden'); }
    function startReorderMode() { document.getElementById('long-press-menu').classList.add('hidden'); appRuntime.reordering = true; document.getElementById('reorder-controls').classList.remove('hidden'); document.getElementById('inventory-grid').classList.add('reordering'); haptic('medium'); appRuntime.sortable = new Sortable(document.getElementById('inventory-grid'), { animation: 150, filter: ':not([data-pinned="true"])', draggable: '[data-pinned="true"]', onMove: (evt) => evt.related.hasAttribute('data-pinned') }); }
    function stopReorderMode() { appRuntime.reordering = false; document.getElementById('reorder-controls').classList.add('hidden'); document.getElementById('inventory-grid').classList.remove('reordering'); if (appRuntime.sortable) { appRuntime.sortable.toArray().forEach((id, index) => { const g = state.inventory.find(x => x.uniqueId == id); if(g && g.pinned) g.pinOrder = index; }); appRuntime.sortable.destroy(); haptic('light'); saveState(); renderInventory(); } }
    function startSelectionMode(mode) { appRuntime.selectionMode = mode; appRuntime.selectedIds = new Set(); closeModal('settings-modal'); renderInventory(); }
    function cancelSelectionMode() { appRuntime.selectionMode = null; appRuntime.selectedIds = new Set(); renderInventory(); }
    function toggleSelection(id) { if(appRuntime.selectedIds.has(id)) appRuntime.selectedIds.delete(id); else appRuntime.selectedIds.add(id); haptic('light'); renderInventory(); }
    function confirmHideSelected() { const ids = Array.from(appRuntime.selectedIds); if(ids.length>0) { state.inventory.forEach(g => { if(ids.includes(g.uniqueId)) { g.hidden = true; g.pinned = false; g.worn = false; } }); hapticNotify('success'); saveState(); } cancelSelectionMode(); applyWornGiftVisuals(); }
    function initCustomizationQueue() { customizationQueue = []; editingIndex = -1; addGiftToQueue(); }
    function addGiftToQueue() { document.querySelectorAll('.filter-option.selected').forEach(el => el.classList.remove('selected')); customizationQueue.push({ id:null, name:null, parts: { model:null, backdrop:null, pattern:null } }); selectQueueItem(customizationQueue.length - 1); document.getElementById('cust-base-grid').classList.remove('hidden'); document.getElementById('cust-parts-container').classList.add('hidden'); }
    function selectQueueItem(index) { editingIndex = index; renderQueueBar(); const curr = customizationQueue[editingIndex]; if(curr.id) loadBaseConfig(curr.id, curr.name, false); else { const baseGrid = document.getElementById('cust-base-grid'); Array.from(baseGrid.children).forEach(c => c.classList.remove('selected')); document.getElementById('cust-parts-container').classList.add('hidden'); updateCreateButton(); } }
    function renderQueueBar() { const bar = document.getElementById('cust-queue-bar'); bar.innerHTML = ''; customizationQueue.forEach((q, idx) => { const el = document.createElement('div'); el.className = `queue-chip ${idx === editingIndex ? 'active' : ''}`; el.innerHTML = `<span>${q.name || `Gift ${idx+1}`}</span> ${customizationQueue.length > 1 ? `<span class="close-x">×</span>` : ''}`; el.onclick = (e) => { if (e.target.classList.contains('close-x')) { e.stopPropagation(); customizationQueue.splice(idx, 1); if(editingIndex >= customizationQueue.length) editingIndex = customizationQueue.length - 1; if(customizationQueue.length === 0) addGiftToQueue(); else selectQueueItem(editingIndex); } else selectQueueItem(idx); }; bar.appendChild(el); }); const addBtn = document.createElement('div'); addBtn.className = 'queue-chip add-gift-chip'; addBtn.innerHTML = '<span>+ Add Gift</span>'; addBtn.onclick = addGiftToQueue; bar.appendChild(addBtn); }
    async function openCustomizeModal() { document.getElementById('customize-modal').classList.add('active'); tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('customize-modal')); initCustomizationQueue(); const grid = document.getElementById('cust-base-grid'); grid.innerHTML = ''; Object.entries(state.giftDefinitions).forEach(([id, name]) => { if (['custom_skebob', 'custom_baggin_cat'].includes(id)) return; const el = document.createElement('div'); el.className = 'filter-option'; el.innerHTML = `<img src="${CDN_BASE}originals/${id}/Original.png"><div class="label">${name}</div>`; el.onclick = () => loadBaseConfig(id, name, true); grid.appendChild(el); }); }
    async function loadBaseConfig(id, name, resetParts) { haptic('light'); const curr = customizationQueue[editingIndex]; if(curr.id !== id || resetParts) { curr.id = id; curr.name = name; curr.parts = { model:null, backdrop:null, pattern:null }; } renderQueueBar(); const baseGrid = document.getElementById('cust-base-grid'); Array.from(baseGrid.children).forEach(c => { c.classList.remove('selected'); if(c.innerText === name) c.classList.add('selected'); }); if(!cachedParts[id]) cachedParts[id] = await fetchGiftParts(name); const parts = cachedParts[id]; renderPartGrid('cust-model-grid', parts.models, 'model', name); renderPartGrid('cust-backdrop-grid', parts.backdrops, 'backdrop', name); renderPartGrid('cust-pattern-grid', parts.patterns, 'pattern', name); document.getElementById('cust-parts-container').classList.remove('hidden'); updateCreateButton(); }
    function renderPartGrid(elemId, items, type, giftName) { const grid = document.getElementById(elemId); grid.innerHTML = ''; const curr = customizationQueue[editingIndex]; items.forEach(item => { const el = document.createElement('div'); el.className = 'filter-option'; let content = ''; if (type === 'model') content = `<img src="${item.isCustom?item.imageUrl:`${CDN_BASE}models/${encodeURIComponent(giftName)}/png/${encodeURIComponent(item.name)}.png`}">`; else if (type === 'backdrop') content = `<div class="gradient-square" style="background: radial-gradient(circle, ${item.hex.centerColor}, ${item.hex.edgeColor})"></div>`; else content = `<img src="${CDN_BASE}patterns/${encodeURIComponent(giftName)}/png/${encodeURIComponent(item.name)}.png">`; el.innerHTML = `${content}<div class="label">${item.name}</div>`; if (curr.parts[type] && curr.parts[type].name === item.name) el.classList.add('selected'); el.onclick = () => { haptic('light'); Array.from(grid.children).forEach(c => c.classList.remove('selected')); el.classList.add('selected'); curr.parts[type] = item; updateCreateButton(); }; grid.appendChild(el); }); }
    function updateCreateButton() { 
        const btn = document.getElementById('btn-create-custom'); 
        
        // Check if all items in queue are valid
        const allReady = customizationQueue.every(q => {
            // If ID is missing, not ready
            if (!q.id) return false;

            // Check Model: Ready if specific selected OR random checked
            const rndModel = document.getElementById('cb-rnd-model').checked && customizationQueue.length === 1;
            const hasModel = q.parts.model || rndModel;

            // Check Backdrop
            const rndBackdrop = document.getElementById('cb-rnd-backdrop').checked && customizationQueue.length === 1;
            const hasBackdrop = q.parts.backdrop || rndBackdrop;

            // Check Pattern
            const rndPattern = document.getElementById('cb-rnd-pattern').checked && customizationQueue.length === 1;
            const hasPattern = q.parts.pattern || rndPattern;

            return hasModel && hasBackdrop && hasPattern;
        });

        const qty = parseInt(document.getElementById('cust-qty').value) || 1;
        const isBulk = customizationQueue.length === 1 && qty > 1;

        btn.disabled = !allReady; 
        
        if (isBulk) {
            btn.innerText = `Create (${qty})`;
        } else {
            btn.innerText = customizationQueue.length > 1 ? `Create All (${customizationQueue.length})` : 'Create'; 
        }
    }
    async function handleCreateQueue() { 
        const btn = document.getElementById('btn-create-custom');
        btn.disabled = true;
        btn.innerText = "Creating...";

        // Get Bulk Settings
        const qtyInput = parseInt(document.getElementById('cust-qty').value) || 1;
        const isRandomModel = document.getElementById('cb-rnd-model').checked;
        const isRandomBackdrop = document.getElementById('cb-rnd-backdrop').checked;
        const isRandomPattern = document.getElementById('cb-rnd-pattern').checked;

        // If queue has multiple items, we ignore bulk settings (qty=1)
        // If queue has 1 item, we use the bulk settings
        const loopCount = customizationQueue.length === 1 ? qtyInput : 1;

        // Iterate through the queue items (usually just 1 if doing bulk)
        for (const q of customizationQueue) {
            if(!q.id) continue;

            const partsPool = cachedParts[q.id]; // Should be cached by now
            
            // Loop for Quantity
            for (let i = 0; i < loopCount; i++) {
                
                // 1. Determine Model
                let finalModel = q.parts.model;
                if (isRandomModel && customizationQueue.length === 1) {
                    // Filter out crafted items for random generation (optional, keeps it "fair")
                    const validModels = partsPool.models.filter(m => !m.crafted);
                    const pool = validModels.length > 0 ? validModels : partsPool.models;
                    finalModel = pool[Math.floor(Math.random() * pool.length)];
                }

                // 2. Determine Backdrop
                let finalBackdrop = q.parts.backdrop;
                if (isRandomBackdrop && customizationQueue.length === 1) {
                    finalBackdrop = partsPool.backdrops[Math.floor(Math.random() * partsPool.backdrops.length)];
                }

                // 3. Determine Pattern
                let finalPattern = q.parts.pattern;
                // If specific pattern not set, or random checked, pick random
                if ((!finalPattern || isRandomPattern) && customizationQueue.length === 1) {
                    finalPattern = partsPool.patterns[Math.floor(Math.random() * partsPool.patterns.length)];
                }

                // Safety check
                if(!finalModel || !finalBackdrop || !finalPattern) continue;

                state.lastCollectibleNumber++; 
                state.inventory.unshift({ 
                    uniqueId: Date.now() + Math.random(), 
                    originalId: q.id, 
                    name: q.name, 
                    isCollectible: true, 
                    timestamp: Date.now(), 
                    pinned: false, 
                    collectibleNumber: state.lastCollectibleNumber, 
                    collectibleData: { 
                        model: finalModel, 
                        backdrop: finalBackdrop, 
                        pattern: finalPattern 
                    } 
                }); 
            }
        }

        hapticNotify('success'); 
        saveState(); 
        renderInventory(); 
        closeModal('customize-modal'); 
        switchTab('inventory'); 
    }
</script>
</body>
</html>
