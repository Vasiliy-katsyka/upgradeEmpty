<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gift Upgrade</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --app-accent-blue: #5288c1;
            
            --app-modal-backdrop-color: rgba(0,0,0,0.8);
            --app-rarity-chip-bg: rgba(62, 188, 249, 0.15);
            --app-rarity-text: #62bcf9;
            --app-profile-gradient-fallback: var(--tg-theme-secondary-bg-color);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            font-size: 16px;
            overflow-x: hidden;
            user-select: none;
        }

        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; }
        .page { display: none; flex-direction: column; flex-grow: 1; background-color: var(--tg-theme-bg-color); }
        .page.active { display: flex; }

        .page-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 15px; background-color: var(--tg-theme-secondary-bg-color);
            min-height: 56px; position: sticky; top: 0; z-index: 10;
        }
        .page-header h2 { font-size: 1.15em; font-weight: 500; margin: 0; }
        
        .profile-top-section {
            padding-top: 30px; padding-bottom: 20px;
            background: var(--app-profile-gradient-fallback);
            display: flex; justify-content: center; position: relative;
            transition: background 0.5s ease;
        }

        .profile-top-section.has-worn-gift .profile-name-status h1,
        .profile-top-section.has-worn-gift .profile-name-status p {
            color: #ffffff !important;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        #profile-pattern-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden; pointer-events: none; opacity: 0.15;
        }
        
        .profile-pattern-item {
            position: absolute; width: 30px; height: 30px;
            left: 50%; top: 50%;
            background-color: currentColor; 
            -webkit-mask-size: contain; mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;
        }

        .profile-main-info { display: flex; flex-direction: column; align-items: center; z-index: 2; position: relative; }
        .profile-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            background-color: var(--tg-theme-hint-color); margin-bottom: 12px;
            object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .profile-name-status h1 { font-size: 1.4em; font-weight: 700; text-align: center; margin: 0 0 4px 0; text-transform: uppercase; letter-spacing: 0.5px; }
        .profile-name-status p { font-size: 0.9em; opacity: 0.7; text-align: center; margin: 0; color: var(--tg-theme-text-color); }

        .profile-info-block { padding: 20px 20px; background-color: var(--tg-theme-bg-color); }
        .profile-info-header { color: var(--tg-theme-link-color); font-weight: 500; font-size: 0.95em; margin-bottom: 15px; }
        .info-item { margin-bottom: 18px; cursor: default; }
        .info-item .value { color: var(--tg-theme-text-color); font-size: 1.1em; display: block; margin-bottom: 2px; line-height: 1.2;}
        .info-item .label { color: var(--tg-theme-hint-color); font-size: 0.85em; }
        .info-item .clickable { cursor: pointer; }

        .profile-tabs { display: flex; justify-content: space-around; background-color: var(--tg-theme-bg-color); border-bottom: 1px solid #000; }
        .profile-tabs button {
            background: none; border: none; color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 0.95em; cursor: pointer; flex-grow: 1;
            font-weight: 500; border-bottom: 2px solid transparent; text-transform: uppercase;
        }
        .profile-tabs button.active { color: var(--tg-theme-link-color); border-bottom-color: var(--tg-theme-link-color); }

        .gifts-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 12px;
            flex-grow: 1; overflow-y: auto; align-content: start; 
            background: var(--tg-theme-bg-color);
        }
        
        .gift-card, .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 12px; padding: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; overflow: hidden;
            transition: transform 0.1s ease-out; border: none; 
        }
        .gift-card { aspect-ratio: 1 / 1; }
        .buy-gift-item { aspect-ratio: 1 / 1.35; padding: 8px; }
        
        .gift-card.selected { box-shadow: inset 0 0 0 3px var(--tg-theme-link-color); background-color: rgba(98, 188, 249, 0.15); }
        .gift-card:active, .buy-gift-item:active { transform: scale(0.97); }
        
        .status-icon {
            position: absolute; top: 6px; left: 6px; z-index: 5;
            width: 14px; height: 14px; display: flex; align-items: center; justify-content: center;
        }
        .status-icon svg { fill: #fff; width: 100%; height: 100%; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.8)); }

        .gift-card.is-hidden { opacity: 0.4; filter: grayscale(1); }

        .image-container {
            width: 75%; height: 75%; display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 2; margin-bottom: 0px; 
        }
        .buy-gift-item .image-container { height: 55%; margin-bottom: 4px; margin-top: 8px; }
        .image-container img, .image-container .lottie-wrapper { max-width: 100%; max-height: 100%; object-fit: contain; }
        .lottie-wrapper { width: 100%; height: 100%; }
        
        .gift-name { font-size: 0.85em; font-weight: 500; text-align: center; margin-top: 4px; z-index: 2; width: 100%; line-height: 1.2; padding: 0 2px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .gift-price { font-size: 0.8em; color: var(--tg-theme-hint-color); margin: 4px 0 8px; font-weight: bold; z-index: 2;}
        .gift-card-bg-pattern { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }
        .dynamic-pattern-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1; overflow: hidden; pointer-events: none; }
        .card-pattern-symbol { 
            position: absolute; width: 30px; height: 30px; left: 50%; top: 50%;
            background-color: currentColor; 
            -webkit-mask-size: contain; mask-size: contain; -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat; opacity: 0.15;
        }
        .top-right-label {
            position: absolute; top: 12px; right: -32px; transform: rotate(45deg);
            background: rgba(0,0,0,0.6); color: white; font-size: 0.6em; padding: 2px 35px; z-index: 4; font-weight: 600; letter-spacing: 0.5px;
        }

        .action-button {
            background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
            border: none; padding: 6px 14px; border-radius: 16px; font-size: 0.9em; cursor: pointer; font-weight: 500;
        }
        #action-toolbar {
            padding: 10px 15px; display: flex; justify-content: flex-end; gap: 10px; background-color: var(--tg-theme-bg-color);
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: 0.2s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            border-top-left-radius: 14px; border-top-right-radius: 14px;
            width: 100%; max-width: 600px; display: flex; flex-direction: column; overflow: hidden;
            max-height: 90vh;
            /* To make click outside work better */
            pointer-events: auto; 
        }
        #customize-modal .modal-content { height: 90vh; }

        .modal-header-bar { padding: 16px; text-align: center; font-weight: 600; font-size: 1.1em; background: var(--tg-theme-secondary-bg-color); position: relative; z-index: 10; }
        .modal-scrollable-content { overflow-y: auto; padding: 0; flex-grow: 1; }
        
        .modal-buttons-footer { padding: 15px; display: flex; gap: 10px; background: var(--tg-theme-secondary-bg-color); }
        .modal-button {
            flex: 1; padding: 12px; border-radius: 30px; border: none; font-size: 1em; font-weight: 600; cursor: pointer;
            background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
        }
        .modal-button.secondary { background-color: var(--tg-theme-bg-color); color: var(--tg-theme-link-color); }
        
        /* New Collectible Modal Styles */
        .collectible-header {
            position: relative; padding: 40px 0 30px; text-align: center; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #ffffff;
        }
        .collectible-header h3 { margin-top: 15px; position: relative; z-index: 2; font-size: 1.5em; margin-bottom: 6px; font-weight: 700; }
        .collectible-header .sub-header { position: relative; z-index: 2; font-size: 1em; opacity: 0.9; }

        .stats-table {
            background-color: var(--tg-theme-secondary-bg-color); border-radius: 12px; overflow: hidden; margin-top: 0; margin-bottom: 24px;
        }
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-weight: 500; color: var(--tg-theme-text-color); font-size: 0.95em; }
        .stat-value { display: flex; align-items: center; gap: 8px; font-size: 0.95em; color: var(--tg-theme-text-color); }
        
        .owner-chip { display: flex; align-items: center; gap: 6px; }
        .owner-chip img { width: 20px; height: 20px; border-radius: 50%; }
        .owner-chip span { color: var(--tg-theme-link-color); }
        
        .percentage-pill { background-color: var(--app-rarity-chip-bg); color: var(--app-rarity-text); padding: 2px 6px; border-radius: 6px; font-size: 0.8em; font-weight: 600; }
        .learn-more { font-size: 0.8em; color: var(--tg-theme-link-color); margin-left: 4px; opacity: 0.8; }
        
        .big-rounded-btn {
            width: 100%; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
            border: none; padding: 14px; border-radius: 30px; font-size: 1.1em; font-weight: 600; cursor: pointer;
        }

        /* Roulette Animations */
        /* Updated: Full Width */
        .roulette-image-wrapper {
            width: 100%; height: 160px; position: relative; overflow: hidden; display: flex;
            align-items: center; justify-content: center;
        }
        .roulette-strip {
            display: flex; height: 100%; position: absolute; left: 0; top: 0;
            /* Will be animated via JS/Keyframes */
        }
        .roulette-strip img {
            width: 160px; height: 160px; object-fit: contain; flex-shrink: 0;
        }
        
        /* Vertical Text Slot */
        .slot-mask {
            height: 1.2em; overflow: hidden; position: relative; display: inline-block; vertical-align: bottom;
            width: 120px; text-align: right;
        }
        .slot-scroll {
            display: flex; flex-direction: column; position: absolute; top: 0; right: 0; width: 100%;
            transition: transform 0.1s linear;
        }
        .slot-item {
            height: 1.2em; display: flex; align-items: center; justify-content: flex-end; width: 100%;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* Menu */
        #long-press-menu {
            position: fixed; background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 2000; min-width: 200px; padding: 6px 0; overflow: hidden;
        }
        #long-press-menu li { padding: 14px 20px; list-style: none; cursor: pointer; color: var(--tg-theme-text-color); font-size: 1em; font-weight: 500; display:flex; align-items:center; gap: 10px; }
        #long-press-menu li:hover { background: rgba(255,255,255,0.05); }
        #long-press-menu li.danger { color: #ff595a; }

        /* Queue Bar */
        .queue-bar { display: flex; overflow-x: auto; padding: 12px 15px; gap: 8px; background: var(--tg-theme-bg-color); white-space: nowrap; scrollbar-width: none; }
        .queue-bar::-webkit-scrollbar { display: none; }
        .queue-chip { 
            padding: 8px 14px; background: var(--tg-theme-secondary-bg-color); border-radius: 20px; font-size: 0.9em; cursor: pointer; border: 1px solid transparent; 
            display: flex; align-items: center; gap: 8px; font-weight: 500;
        }
        .queue-chip.active { border-color: var(--tg-theme-link-color); background: rgba(98, 188, 249, 0.1); color: var(--tg-theme-link-color); }
        .queue-chip .close-x { opacity: 0.6; font-size: 1.2em; font-weight: 300; }
        .add-gift-chip { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }

        .filter-section { padding: 0 15px; margin-bottom: 20px; }
        .filter-section h4 { margin: 15px 0 8px; color: var(--tg-theme-hint-color); font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; padding-left: 4px; }
        
        .filter-options-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; 
            overflow-y: auto; padding: 4px; max-height: 220px; border-radius: 8px;
        }
        .filter-option {
            background: var(--tg-theme-secondary-bg-color); border-radius: 12px; padding: 10px;
            cursor: pointer; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100px;
        }
        .filter-option.selected { border-color: var(--tg-theme-link-color); background: rgba(98, 188, 249, 0.05); }
        .filter-option img { width: 55px; height: 55px; object-fit: contain; margin-bottom: 5px; }
        .filter-option .label { font-size: 0.75em; text-align: center; overflow: hidden; white-space: nowrap; width: 100%; text-overflow: ellipsis;}
        .gradient-square { width: 55px; height: 55px; border-radius: 50%; margin-bottom: 5px; }

        .switch-row { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.1); font-weight: 500; }
        .switch { position: relative; display: inline-block; width: 50px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--tg-theme-hint-color); transition: .4s; border-radius: 34px; opacity: 0.3; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--tg-theme-button-color); opacity: 1; }
        input:checked + .slider:before { transform: translateX(20px); }

        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--tg-theme-link-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .reordering .gift-card { opacity: 0.5; }
        .reordering .gift-card[data-pinned="true"] { opacity: 1; cursor: grab; box-shadow: 0 0 0 2px var(--tg-theme-link-color); }
        
        #qty-modal input { background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); border: none; padding: 12px; border-radius: 12px; width: 100%; font-size: 1.4em; text-align: center; margin-bottom: 15px; outline: none; font-weight: bold; }

        /* Loading */
        .glass-panel { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; animation: glassFloat 4s ease-in-out infinite; }
        .liquid-blob { position: absolute; border-radius: 50%; filter: blur(50px); opacity: 0.5; z-index: 1; animation: blobFloat 10s infinite alternate; }
        .blob-1 { width: 200px; height: 200px; background: #007AFF; top: 20%; left: 15%; }
        .blob-2 { width: 250px; height: 250px; background: #5ac8fa; bottom: 20%; right: 10%; animation-delay: -2s; }
        @keyframes blobFloat { 0% { transform: translate(0, 0) scale(1); } 50% { transform: translate(20px, -20px) scale(1.1); } 100% { transform: translate(-20px, 20px) scale(0.9); } }
        @keyframes glassFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* --- CRAFTING STYLES --- */
        #craft-modal .modal-content { background: linear-gradient(180deg, #1a2736 0%, #0e1621 100%); min-height: 80vh; }

        .craft-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 30px 20px; flex-grow: 1; position: relative;
        }

        /* Central Anvil & Progress */
        .craft-center-piece {
            position: relative; width: 140px; height: 140px; margin: 20px 0;
            display: flex; align-items: center; justify-content: center;
        }
        .craft-progress-svg {
            transform: rotate(-90deg); width: 100%; height: 100%;
            position: absolute; top: 0; left: 0;
        }
        .craft-progress-circle {
            fill: none; stroke: var(--tg-theme-button-color);
            stroke-width: 8; stroke-linecap: round;
            stroke-dasharray: 377; /* 2 * PI * r(60) */
            stroke-dashoffset: 377;
            transition: stroke-dashoffset 0.5s ease;
        }
        .craft-progress-bg {
            fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 8;
        }
        .craft-main-icon {
            width: 60px; height: 60px; z-index: 2; fill: #fff;
            filter: drop-shadow(0 0 10px rgba(62, 188, 249, 0.5));
            transition: transform 0.2s;
        }
        .craft-percent-text {
            position: absolute; bottom: -30px; width: 100%; text-align: center;
            font-weight: 700; font-size: 1.2em; color: #fff;
        }

        /* 4 Slots Layout */
        .craft-slots-area {
            display: grid; grid-template-columns: 1fr 1fr; gap: 120px 40px;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; max-width: 340px; pointer-events: none;
        }
        .craft-slot {
            width: 70px; height: 70px; background: rgba(255,255,255,0.05);
            border-radius: 14px; border: 2px dashed rgba(255,255,255,0.2);
            pointer-events: auto; cursor: pointer; position: relative;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .craft-slot.filled { border-style: solid; border-color: var(--tg-theme-button-color); background: var(--tg-theme-secondary-bg-color); }
        .craft-slot.add-btn::after { content: '+'; font-size: 2em; color: var(--tg-theme-hint-color); }
        .craft-slot img { width: 100%; height: 100%; object-fit: contain; padding: 5px; border-radius: 12px; }
        .craft-slot .remove-x {
            position: absolute; top: -6px; right: -6px; background: #ff595a;
            color: white; border-radius: 50%; width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center; font-size: 12px;
        }
        /* Probability Pills under slots */
        .slot-chance {
            position: absolute; bottom: -22px; left: 50%; transform: translateX(-50%);
            font-size: 0.7em; background: rgba(0,0,0,0.6); padding: 2px 6px;
            border-radius: 4px; white-space: nowrap; color: #fff;
        }

        /* Attributes Probability Bar */
        .craft-probabilities {
            display: flex; gap: 10px; margin-top: auto; padding-top: 20px; width: 100%; justify-content: center;
        }
        .prob-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .prob-ring { width: 40px; height: 40px; border-radius: 50%; position: relative; border: 3px solid transparent; display: flex; align-items: center; justify-content: center;}
        .prob-val { font-size: 0.75em; font-weight: bold; }

        /* Animation Classes */
        .crafting-active .craft-main-icon { animation: pound 0.5s infinite alternate; }
        .crafting-active .craft-progress-circle { stroke: #ffbd2e; }
        @keyframes pound { 0% { transform: scale(1) rotate(0deg); } 100% { transform: scale(0.9) rotate(-10deg); } }

        /* Selection Grid */
        .picker-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .picker-item { opacity: 0.5; position: relative; border: 2px solid transparent; }
        .picker-item.selectable { opacity: 1; cursor: pointer; }
        .picker-item.selected { border-color: var(--tg-theme-link-color); background: rgba(62, 188, 249, 0.1); opacity: 1; }
        .picker-item.disabled { opacity: 0.2; pointer-events: none; }

        .craft-icon-mask {
            width: 28px;
            height: 28px;
            /* Use white because the Collectible Header has a dark gradient background */
            background-color: rgba(255, 255, 255, 0.9);
            -webkit-mask: url('https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/8e8c2524c119384132502547e562a1d128661cd9/telelakel_tgb_AgADOZMAAsCtWEs.svg') no-repeat center / contain;
            mask: url('https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/8e8c2524c119384132502547e562a1d128661cd9/telelakel_tgb_AgADOZMAAsCtWEs.svg') no-repeat center / contain;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 20px;
            z-index: 10;
            transition: transform 0.2s, opacity 0.2s;
        }

        .craft-icon-mask:active {
            opacity: 0.7;
            transform: scale(0.9);
        }
    </style>
</head>
<body>

<div id="loading-overlay" class="modal-overlay active" style="align-items: center; justify-content: center; background: var(--tg-theme-bg-color); z-index: 9999;">
    <div class="liquid-blob blob-1"></div>
    <div class="liquid-blob blob-2"></div>
    <div class="glass-panel">
        <div id="loading-anim" style="width: 100px; height: 100px;"></div>
        <h2 style="font-weight:700; margin-top:15px; color:var(--tg-theme-text-color);">Gift Simulator</h2>
    </div>
</div>

<div class="app-container">
    <!-- Profile Page -->
    <div id="profile-page" class="page">
        <div class="page-header">
            <h2>Profile</h2>
            <div><button class="action-button" onclick="openSettingsModal()">Settings</button></div>
        </div>
        <div class="profile-top-section" id="profile-bg">
            <div id="profile-pattern-overlay"></div>
            <div class="profile-main-info">
                <img src="" class="profile-avatar" id="user-avatar">
                <div class="profile-name-status">
                    <h1 id="user-name">Loading...</h1>
                    <p id="gift-count-display">0 gifts</p>
                </div>
            </div>
        </div>
        
        <div class="profile-info-block">
            <div class="profile-info-header">Info</div>
            <div class="info-item">
                <span class="value" id="profile-phone">+888 0000 0000</span>
                <span class="label">Mobile</span>
            </div>
            <div class="info-item clickable" onclick="editBio()">
                <span class="value" id="profile-bio">Hello world</span>
                <span class="label">Bio</span>
            </div>
            <div class="info-item">
                <span class="value" id="profile-username">@username</span>
                <span class="label">Username</span>
            </div>
        </div>

        <div class="profile-tabs">
            <button class="active" onclick="switchTab('inventory')">Inventory</button>
            <button onclick="switchTab('shop')">Gift Shop</button>
        </div>
        
        <div id="action-toolbar" class="hidden"></div>
        <div class="gifts-grid" id="inventory-grid"></div>
    </div>

    <!-- Shop Page -->
    <div id="shop-page" class="page">
        <div class="page-header">
            <h2>Gift Shop</h2>
            <button class="action-button" onclick="openCustomizeModal()">Customize</button>
        </div>
        <div class="gifts-grid" id="shop-grid">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<!-- Modals -->

<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar">Settings</div>
        <div class="modal-scrollable-content">
            <div class="switch-row">
                <span>Animations (Lottie)</span>
                <label class="switch">
                    <input type="checkbox" id="setting-animations" onchange="toggleSetting('animations', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-row">
                <span>Show Hidden Gifts</span>
                <label class="switch">
                    <input type="checkbox" id="setting-hidden" onchange="toggleSetting('showHidden', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div style="padding: 20px; display: flex; flex-direction: column; gap: 10px;">
                <button class="modal-button" style="width:100%; background: var(--app-accent-blue);" onclick="startSelectionMode('hide')">Select & Hide Multiple</button>
                <button class="modal-button secondary" style="width:100%; color: #ff595a;" onclick="resetAppData()">Reset All Data</button>
            </div>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" onclick="closeModal('settings-modal')">Close</button>
        </div>
    </div>
</div>

<div id="qty-modal" class="modal-overlay">
    <div class="modal-content" style="max-height: auto;">
        <div class="modal-header-bar">Buy Multiple</div>
        <div class="modal-scrollable-content" style="padding: 20px;">
            <p style="margin-bottom: 10px; color: var(--tg-theme-hint-color);">Enter quantity:</p>
            <input type="number" id="qty-input" value="1" min="1" max="1000">
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" onclick="handleBuyMultiple()">Buy</button>
            <!-- Removed Cancel Button -->
        </div>
    </div>
</div>

<div id="detail-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar"><span id="detail-title">Gift</span></div>
        <div class="modal-scrollable-content" style="padding: 20px; text-align: center;">
            <div class="image-container" style="width: 160px; height: 160px; margin: 0 auto;">
                <img id="detail-image" src="" style="display:none; width: 100%; height: 100%; object-fit: contain;">
                <div id="detail-lottie" class="lottie-wrapper"></div>
            </div>
            <p style="color: var(--tg-theme-hint-color); margin-top: 15px; line-height: 1.5;" id="detail-desc">
                This is a regular gift. Upgrade it to make it a unique collectible!
            </p>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" id="btn-upgrade" onclick="handleUpgrade()">✨ Upgrade (Free)</button>
            <!-- Removed Close Button -->
        </div>
    </div>
</div>

<!-- COLLECTIBLE / ROULETTE MODAL -->
<div id="collectible-modal" class="modal-overlay">
    <div class="modal-content" style="background-color: var(--tg-theme-bg-color);">
        <!-- Top Gradient Section -->
        <div id="collectible-header" class="collectible-header">
            <div id="collectible-pattern-container" class="dynamic-pattern-container"></div>
            <div style="position: relative; z-index: 2; width: 100%; display: flex; flex-direction: column; align-items: center;">
                <div class="roulette-image-wrapper">
                    <div id="roulette-strip" class="roulette-strip" style="display:none;"></div>
                    <img id="collectible-image" src="" style="width:160px; height:160px; object-fit:contain; display:none;">
                    <div id="collectible-lottie" class="lottie-wrapper" style="width:160px; height:160px; display:none;"></div>
                </div>
                <h3 id="collectible-title">Gift Name #000</h3>
                <div class="sub-header" id="collectible-model-name">Model Name</div>
            </div>
        </div>

        <!-- Scrollable Content with Table -->
        <div class="modal-scrollable-content" style="padding: 16px;">
            <div class="stats-table">
                <!-- Owner -->
                <div class="stat-row">
                    <div class="stat-label">Owner</div>
                    <div class="stat-value owner-chip">
                        <img id="col-owner-img" src="">
                        <span id="col-owner-name">User</span>
                    </div>
                </div>
                <!-- Model -->
                <div class="stat-row">
                    <div class="stat-label">Model</div>
                    <div class="stat-value">
                        <div class="slot-mask" id="slot-model"><div class="slot-scroll"></div></div>
                        <span class="percentage-pill" id="col-model-pct">0%</span>
                    </div>
                </div>
                <!-- Symbol -->
                <div class="stat-row">
                    <div class="stat-label">Symbol</div>
                    <div class="stat-value">
                        <div class="slot-mask" id="slot-symbol"><div class="slot-scroll"></div></div>
                        <span class="percentage-pill" id="col-symbol-pct">0%</span>
                    </div>
                </div>
                <!-- Backdrop -->
                <div class="stat-row">
                    <div class="stat-label">Backdrop</div>
                    <div class="stat-value">
                        <div class="slot-mask" id="slot-backdrop"><div class="slot-scroll"></div></div>
                        <span class="percentage-pill" id="col-backdrop-pct">0%</span>
                    </div>
                </div>
                <!-- Quantity -->
                <div class="stat-row">
                    <div class="stat-label">Quantity</div>
                    <div class="stat-value" id="col-quantity">100/1000 issued</div>
                </div>
                <!-- Value -->
                <div class="stat-row">
                    <div class="stat-label">Value</div>
                    <div class="stat-value" style="color: var(--tg-theme-link-color);">
                        <span id="col-value">~10 TON</span> 
                        <span class="learn-more">learn more</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="modal-buttons-footer" style="padding-top: 0; background: var(--tg-theme-bg-color);">
            <button id="btn-collectible-action" class="big-rounded-btn" onclick="closeModal('collectible-modal')">OK</button>
        </div>
    </div>
</div>

<div id="customize-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar">Customize</div>
        <div class="queue-bar" id="cust-queue-bar"></div>
        <div class="modal-scrollable-content" style="padding: 0; background: var(--tg-theme-secondary-bg-color);">
            <div class="filter-section">
                <h4>Select Base Gift</h4>
                <div class="filter-options-grid" id="cust-base-grid"></div>
            </div>
            <div id="cust-parts-container" class="hidden">
                <div class="filter-section"><h4>Select Model</h4><div class="filter-options-grid" id="cust-model-grid"></div></div>
                <div class="filter-section"><h4>Select Backdrop</h4><div class="filter-options-grid" id="cust-backdrop-grid"></div></div>
                <div class="filter-section"><h4>Select Symbol (Optional)</h4><div class="filter-options-grid" id="cust-pattern-grid"></div></div>
            </div>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" id="btn-create-custom" disabled onclick="handleCreateQueue()">Create All</button>
            <!-- Removed Cancel Button -->
        </div>
    </div>
</div>

<!-- CRAFTING MODAL -->
<div id="craft-modal" class="modal-overlay">
    <div class="modal-content" style="height: 90vh;">
        <div class="modal-header-bar">
            Craft Gift
            <div style="position: absolute; right: 15px; top: 15px; opacity: 0.6;" onclick="closeModal('craft-modal')">✕</div>
        </div>
        
        <div class="craft-container">
            <!-- 4 Slots surrounding the center -->
            <div class="craft-slots-area">
                <div class="craft-slot add-btn" onclick="openIngredientPicker()"></div>
                <div class="craft-slot add-btn" onclick="openIngredientPicker()"></div>
                <div class="craft-slot add-btn" onclick="openIngredientPicker()"></div>
                <div class="craft-slot add-btn" onclick="openIngredientPicker()"></div>
            </div>

            <!-- Center Circle -->
            <div class="craft-center-piece">
                <svg class="craft-progress-svg" viewBox="0 0 140 140">
                    <circle class="craft-progress-bg" cx="70" cy="70" r="60"></circle>
                    <circle id="craft-progress-bar" class="craft-progress-circle" cx="70" cy="70" r="60"></circle>
                </svg>
                <!-- Anvil Icon -->
                <svg class="craft-main-icon" viewBox="0 0 512 512">
                    <path d="M48.5,235.8c-2.3,13-3.5,26.2-3.5,39.6c0,119.5,90.4,217.9,205.9,233.1v-62c-80.8-14.5-141.9-85-141.9-169.5
                    c0-6.1,0.3-12.1,1-18.1L48.5,235.8z M484.7,192H150.4l-40.4,66.7h373.1c11.9,0,21.6-9.7,21.6-21.6v-23.5
                    C504.7,201.7,496.6,192,484.7,192z M353.9,4.2c-15.6,0-30.6,3-44.4,8.5l29.4,32.4l0.1,0.1c4.8-1.7,9.9-2.6,15.2-2.6
                    c24.7,0,44.7,20,44.7,44.7s-20,44.7-44.7,44.7H179.6l-20.9-34.6l-67.9,112h413.9v-54.3C504.7,70.9,437,4.2,353.9,4.2z"/>
                </svg>
                <div id="craft-pct-text" class="craft-percent-text">0%</div>
            </div>

            <div style="margin-top: 140px; text-align: center; color: var(--tg-theme-hint-color); font-size: 0.9em; padding: 0 20px;">
                If crafting fails, all selected gifts will be consumed (deleted).
            </div>

            <!-- Backdrops Probability Display -->
            <div class="craft-probabilities" id="craft-stats-row"></div>
        </div>

        <div class="modal-buttons-footer">
            <button id="btn-do-craft" class="big-rounded-btn" disabled onclick="executeCraft()">
                Craft Gift
            </button>
        </div>
    </div>
</div>

<!-- INGREDIENT PICKER MODAL -->
<div id="craft-picker-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar">Select Gifts</div>
        <div class="modal-scrollable-content">
            <div class="picker-grid" id="picker-grid"></div>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" onclick="closeModal('craft-picker-modal')">Done</button>
        </div>
    </div>
</div>

<!-- Menus -->
<div id="long-press-menu" class="hidden">
    <ul>
        <li id="menu-pin" onclick="togglePin()">Pin to Profile</li>
        <li id="menu-wear" onclick="toggleWear()">Wear Gift</li>
        <li id="menu-reorder" class="hidden" onclick="startReorderMode()">Reorder Pins</li>
        <li id="menu-hide" onclick="toggleHide()">Hide Gift</li>
        <li class="danger" onclick="deleteGift()">Delete</li>
    </ul>
</div>
<div id="reorder-controls" class="page-header hidden" style="position:fixed; top:0; left:0; right:0; background:var(--tg-theme-bg-color); z-index:100; justify-content:center;">
    <button class="action-button" onclick="stopReorderMode()">Done Reordering</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand(); tg.enableClosingConfirmation();

    const CDN_BASE = "https://cdn.changes.tg/gifts/";
    const LS_KEY = "telegram_gift_simulator_data_v2"; 
    
    let craftingState = { ingredients: [], baseGiftName: null };
    // The provided Anvil SVG Icon path data
    const ANVIL_SVG_PATH = "M48.5,235.8c-2.3,13-3.5,26.2-3.5,39.6c0,119.5,90.4,217.9,205.9,233.1v-62c-80.8-14.5-141.9-85-141.9-169.5c0-6.1,0.3-12.1,1-18.1L48.5,235.8z M484.7,192H150.4l-40.4,66.7h373.1c11.9,0,21.6-9.7,21.6-21.6v-23.5C504.7,201.7,496.6,192,484.7,192z M353.9,4.2c-15.6,0-30.6,3-44.4,8.5l29.4,32.4l0.1,0.1c4.8-1.7,9.9-2.6,15.2-2.6c24.7,0,44.7,20,44.7,44.7s-20,44.7-44.7,44.7H179.6l-20.9-34.6l-67.9,112h413.9v-54.3C504.7,70.9,437,4.2,353.9,4.2z";

    // CUSTOM CONFIGS (Shortened for brevity)
    const MY_CUSTOM_ADDITIONS = {
        "Heart Locket": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADoJIAAkOhuEs.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADoJIAAkOhuEs.json"}],
        "Jolly Chimp": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADNpwAArR-oUs.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADNpwAArR-oUs.json"}],
        "Khabib's Papakha": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgAD1IoAAlWf8Us.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgAD1IoAAlWf8Us.json"}],
        "Desk Calendar": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADM6AAAm0yIUs.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADM6AAAm0yIUs.json"}],
        "Winter Wreath": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADdpQAAvk6GEk.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADdpQAAvk6GEk.json"}],
        "Loot Bag": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADdpYAAohNiEs.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADdpYAAohNiEs.json"}, {name: "MID Club", rarityPermille: 15, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADX58AAp0RiUs.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADX58AAp0RiUs.json"}],
        "Victory Medal": [{name: "Midnight Club", rarityPermille: 10, isCustom: true, imageUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADg5UAAtjYyEs.png", lottieUrl: "https://raw.githubusercontent.com/Vasiliy-katsyka/upgradeEmpty/main/MidnightClubEmoji_AgADg5UAAtjYyEs.json"}]
    };
    
    const PIN_ICON = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" /></svg>`;
    const WEAR_ICON = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>`;

    let state = { inventory: [], giftDefinitions: {}, lastCollectibleNumber: 100, userBio: "Hello world", userPhone: "", settings: { animations: true, showHidden: false } };
    let customizationQueue = []; let editingIndex = 0; let cachedParts = {};
    let appRuntime = { longPressTimer: null, activeGiftId: null, shopGiftData: null, reordering: false, sortable: null, selectionMode: null, selectedIds: new Set(), animationState: null, detailInterval: null };

    // --- Init ---
    window.addEventListener('DOMContentLoaded', async () => {
        const loadingScreen = document.getElementById('loading-overlay');
        lottie.loadAnimation({ container: document.getElementById('loading-anim'), renderer: 'svg', loop: true, autoplay: true, path: 'https://cdn.changes.tg/gifts/models/Artisan%20Brick/lottie/Ice%20Mammoth.json' });
        setTimeout(() => { loadingScreen.style.opacity = '0'; document.getElementById('profile-page').classList.add('active'); setTimeout(() => { loadingScreen.classList.remove('active'); }, 200); }, Math.random() * 3000 + 2000);

        applyTelegramTheme(); tg.onEvent('themeChanged', applyTelegramTheme);
        loadState();
        if (!state.userPhone) state.userPhone = `+888 ${Math.floor(Math.random()*9000+1000)} ${Math.floor(Math.random()*9000+1000)}`;
        updateUserProfile(); applyWornGiftVisuals(); await fetchGiftDefinitions(); renderShop(); renderInventory();
        document.addEventListener('click', (e) => {
            // If the user clicks exactly on the modal-overlay (the dark background)
            if (e.target.classList.contains('modal-overlay')) {
                closeModal(e.target.id);
            }
        });
        document.addEventListener('click', (e) => { 
            const menu = document.getElementById('long-press-menu'); 
            if (!menu.classList.contains('hidden') && !menu.contains(e.target)) menu.classList.add('hidden');
            
            // Close modals on outside click
            const modals = document.querySelectorAll('.modal-overlay.active');
            modals.forEach(m => {
                if(e.target === m) closeModal(m.id);
            });
        });
    });

    // --- Core Functions ---
    function updateUserProfile() {
        const user = tg.initDataUnsafe.user;
        const nameEl = document.getElementById('user-name'); const avatarEl = document.getElementById('user-avatar'); const usernameEl = document.getElementById('profile-username');
        if (user) { nameEl.innerText = [user.first_name, user.last_name].filter(Boolean).join(' '); avatarEl.src = user.photo_url || `https://i.pravatar.cc/150?u=${user.id}`; usernameEl.innerText = user.username ? `@${user.username}` : '@unknown'; } 
        else { nameEl.innerText = "Web User"; avatarEl.src = "https://i.pravatar.cc/150?u=test"; usernameEl.innerText = "@webuser"; }
        document.getElementById('profile-phone').innerText = state.userPhone; document.getElementById('profile-bio').innerText = state.userBio;
    }
    function applyTelegramTheme() {
        const p = tg.themeParams; const r = document.documentElement.style;
        if (p.bg_color) r.setProperty('--tg-theme-bg-color', p.bg_color); if (p.text_color) r.setProperty('--tg-theme-text-color', p.text_color); if (p.hint_color) r.setProperty('--tg-theme-hint-color', p.hint_color); if (p.link_color) r.setProperty('--tg-theme-link-color', p.link_color); if (p.button_color) r.setProperty('--tg-theme-button-color', p.button_color); if (p.button_text_color) r.setProperty('--tg-theme-button-text-color', p.button_text_color); if (p.secondary_bg_color) r.setProperty('--tg-theme-secondary-bg-color', p.secondary_bg_color);
    }
    function haptic(style) { if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred(style || 'light'); }
    function hapticNotify(type) { if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred(type); }

    async function fetchGiftDefinitions() { try { const res = await fetch(`${CDN_BASE}id-to-name.json`); if (!res.ok) throw new Error(); state.giftDefinitions = await res.json(); } catch (e) {} }
    async function fetchGiftParts(giftName) {
        if(cachedParts[giftName]) return cachedParts[giftName];
        try {
            const enc = encodeURIComponent(giftName);
            const [mRes, bRes, pRes] = await Promise.all([ fetch(`${CDN_BASE}models/${enc}/models.json`), fetch(`${CDN_BASE}backdrops/${enc}/backdrops.json`), fetch(`${CDN_BASE}patterns/${enc}/patterns.json`) ]);
            let models = mRes.ok ? await mRes.json() : []; let backdrops = bRes.ok ? await bRes.json() : []; let patterns = pRes.ok ? await pRes.json() : [];
            if (MY_CUSTOM_ADDITIONS[giftName]) models.push(...MY_CUSTOM_ADDITIONS[giftName]);
            models.sort((a, b) => (a.rarityPermille||0) - (b.rarityPermille||0));
            cachedParts[giftName] = { models, backdrops, patterns };
            return cachedParts[giftName];
        } catch { return { models: [], backdrops: [], patterns: [] }; }
    }

    // --- Renderers ---
    function renderShop() {
        const grid = document.getElementById('shop-grid'); grid.innerHTML = '';
        Object.entries(state.giftDefinitions).forEach(([id, name]) => {
            if (['custom_skebob', 'custom_baggin_cat'].includes(id)) return;
            const el = document.createElement('div'); el.className = 'buy-gift-item';
            el.innerHTML = `<div class="image-container"><img src="${CDN_BASE}originals/${id}/Original.png" loading="lazy" onerror="this.style.display='none'"></div><div class="gift-name">${name}</div><div class="gift-price">Free</div>`;
            el.onclick = () => buyGift(id, name);
            el.addEventListener('touchstart', (e) => startShopLongPress(e, id, name), {passive:false}); el.addEventListener('touchend', cancelLongPress);
            el.addEventListener('contextmenu', (e) => { e.preventDefault(); openQtyModal(id, name); });
            grid.appendChild(el);
        });
    }
    function renderInventory() {
        const grid = document.getElementById('inventory-grid');
        if (appRuntime.reordering) return;
        grid.innerHTML = '';
        let displayList = state.settings.showHidden ? state.inventory : state.inventory.filter(g => !g.hidden);
        document.getElementById('gift-count-display').innerText = `${state.inventory.length} gifts`;
        updateActionToolbar();
        if (displayList.length === 0) { grid.innerHTML = `<div style="grid-column:span 3; text-align:center; padding:40px 20px; color:var(--tg-theme-hint-color);">${state.inventory.length>0?"All hidden.":"Empty."}</div>`; return; }
        
        displayList.sort((a, b) => {
            if (a.pinned && !b.pinned) return -1; if (!a.pinned && b.pinned) return 1;
            if (a.pinned) return (a.pinOrder||0) - (b.pinOrder||0); return b.timestamp - a.timestamp;
        });

        displayList.forEach(gift => {
            const el = document.createElement('div'); el.className = 'gift-card'; el.dataset.id = gift.uniqueId;
            if (gift.pinned) el.dataset.pinned = "true"; if (gift.hidden) el.classList.add('is-hidden');
            if (appRuntime.selectionMode === 'hide' && appRuntime.selectedIds.has(gift.uniqueId)) el.classList.add('selected');
            
            if (appRuntime.selectionMode) el.onclick = () => toggleSelection(gift.uniqueId);
            else {
                el.addEventListener('touchstart', (e) => startInventoryLongPress(e, gift), {passive:false}); el.addEventListener('touchend', cancelLongPress); el.addEventListener('touchmove', cancelLongPress);
                el.addEventListener('contextmenu', (e) => { e.preventDefault(); openMenu(e, gift); });
            }

            let visualHtml = '', topIcon = '';
            if(gift.pinned && !appRuntime.selectionMode) topIcon = `<div class="status-icon">${PIN_ICON}</div>`;
            if(gift.worn && !appRuntime.selectionMode) topIcon = `<div class="status-icon">${WEAR_ICON}</div>`;

            if (gift.isCollectible) {
                const cd = gift.collectibleData;
                const bgStyle = `radial-gradient(circle, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
                const imgUrl = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
                if (state.settings.animations) { visualHtml = `<div class="lottie-wrapper" id="lot-${gift.uniqueId}"></div>`; setTimeout(() => playLottie(`lot-${gift.uniqueId}`, cd.model.isCustom ? cd.model.lottieUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/lottie/${encodeURIComponent(cd.model.name)}.json`), 0); } 
                else visualHtml = `<img src="${imgUrl}" loading="lazy">`;
                el.innerHTML = `${topIcon}<div class="top-right-label">#${gift.collectibleNumber}</div><div class="gift-card-bg-pattern" style="background:${bgStyle}"></div><div class="dynamic-pattern-container" id="pat-${gift.uniqueId}"></div><div class="image-container">${visualHtml}</div>`; 
                setTimeout(() => generatePattern(`pat-${gift.uniqueId}`, cd.pattern, gift.name, true, cd.backdrop.hex.patternColor), 0);
                if (!appRuntime.selectionMode) el.onclick = () => openCollectibleModal(gift, false);
            } else {
                const imgUrl = `${CDN_BASE}originals/${gift.originalId}/Original.png`;
                if (state.settings.animations) { visualHtml = `<div class="lottie-wrapper" id="lot-${gift.uniqueId}"></div>`; setTimeout(() => playLottie(`lot-${gift.uniqueId}`, `${CDN_BASE}originals/${gift.originalId}/Original.json`), 0); } 
                else visualHtml = `<img src="${imgUrl}" loading="lazy">`;
                el.innerHTML = `<div class="image-container">${visualHtml}</div>`;
                if (!appRuntime.selectionMode) el.onclick = () => openDetailModal(gift);
            }
            grid.appendChild(el);
        });
    }
    function updateActionToolbar() {
        const toolbar = document.getElementById('action-toolbar'); toolbar.innerHTML = ''; toolbar.className = 'hidden';
        if (appRuntime.selectionMode === 'hide') { toolbar.className = ''; toolbar.style.borderBottom = '1px solid rgba(255,255,255,0.05)'; toolbar.innerHTML = `<button class="action-button" onclick="cancelSelectionMode()" style="background:var(--tg-theme-button-color);">Cancel</button><button class="action-button" onclick="confirmHideSelected()" style="background:var(--app-accent-blue);">Hide (${appRuntime.selectedIds.size})</button>`; return; }
        if (state.inventory.some(g => !g.isCollectible)) { toolbar.className = ''; toolbar.style.borderBottom = 'none'; toolbar.innerHTML = `<button class="action-button" onclick="handleUpgradeAll()" style="background:var(--app-accent-blue);">✨ Upgrade All</button>`; }
    }

    // --- Actions ---
    function buyGift(id, name, qty = 1) { for(let i=0; i<qty; i++) state.inventory.unshift({ uniqueId: Date.now()+Math.random()+i, originalId: id, name: name, isCollectible: false, timestamp: Date.now()+i }); saveState(); renderInventory(); if(qty===1) switchTab('inventory'); hapticNotify('success'); }
    function startShopLongPress(e, id, name) { appRuntime.longPressTimer = setTimeout(() => { haptic('medium'); openQtyModal(id, name); }, 500); }
    function startInventoryLongPress(e, gift) { appRuntime.longPressTimer = setTimeout(() => { haptic('medium'); openMenu(e.touches[0], gift); }, 500); }
    function cancelLongPress() { clearTimeout(appRuntime.longPressTimer); }
    function openQtyModal(id, name) { appRuntime.shopGiftData = { id, name }; document.getElementById('qty-modal').classList.add('active'); document.getElementById('qty-input').value = 1; tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('qty-modal')); }
    function handleBuyMultiple() { const qty = parseInt(document.getElementById('qty-input').value); if(qty>0) buyGift(appRuntime.shopGiftData.id, appRuntime.shopGiftData.name, qty); closeModal('qty-modal'); }

    // --- UPGRADE SYSTEM ---
    async function handleUpgrade() {
        const btn = document.getElementById('btn-upgrade'); btn.innerText = "Preparing...";
        const gift = state.inventory.find(g => g.uniqueId === appRuntime.activeGiftId);
        
        // 1. Fetch parts
        const parts = await fetchGiftParts(gift.name);
        if (!parts.models.length) { alert("No parts!"); return; }

        // 2. Generate Result
        gift.isCollectible = true;
        state.lastCollectibleNumber++;
        gift.collectibleNumber = state.lastCollectibleNumber;
        gift.collectibleData = {
            model: parts.models[Math.floor(Math.random()*parts.models.length)],
            backdrop: parts.backdrops[Math.floor(Math.random()*parts.backdrops.length)],
            pattern: parts.patterns[Math.floor(Math.random()*parts.patterns.length)]
        };

        // 3. Save State
        saveState(); renderInventory(); closeModal('detail-modal');

        // 4. Start Roulette Animation
        openCollectibleModal(gift, true, parts);
        btn.innerText = "Upgrade";
    }

    async function handleUpgradeAll() {
        const toUpgrade = state.inventory.filter(g => !g.isCollectible);
        if(!toUpgrade.length) return;
        const btn = document.querySelector('#action-toolbar button'); btn.innerText = `Upgrading ${toUpgrade.length}...`; btn.disabled = true;
        for (let g of toUpgrade) {
            const parts = await fetchGiftParts(g.name);
            if(parts.models.length) {
                g.isCollectible = true; state.lastCollectibleNumber++; g.collectibleNumber = state.lastCollectibleNumber;
                g.collectibleData = { model: parts.models[Math.floor(Math.random()*parts.models.length)], backdrop: parts.backdrops[Math.floor(Math.random()*parts.backdrops.length)], pattern: parts.patterns[Math.floor(Math.random()*parts.patterns.length)] };
            }
        }
        hapticNotify('success'); saveState(); renderInventory();
    }

    // --- ROULETTE / COLLECTIBLE MODAL LOGIC ---
    function openCollectibleModal(gift, isUpgrading = false, partsPool = null) {
        haptic('light');
        const cd = gift.collectibleData;
        
        const modal = document.getElementById('collectible-modal');
        const header = document.getElementById('collectible-header');
        const imgEl = document.getElementById('collectible-image');
        const lottieEl = document.getElementById('collectible-lottie');
        const rouletteStrip = document.getElementById('roulette-strip');
        const btn = document.getElementById('btn-collectible-action');

        // 1. Reset Header Visuals
        header.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
        document.getElementById('collectible-pattern-container').innerHTML = '';
        generatePattern('collectible-pattern-container', cd.pattern, gift.name, false, cd.backdrop.hex.patternColor);

        // 2. Titles & Owner
        document.getElementById('collectible-title').innerText = `${gift.name} #${gift.collectibleNumber.toLocaleString()}`;
        document.getElementById('collectible-model-name').innerText = cd.model.name;
        const user = tg.initDataUnsafe.user;
        document.getElementById('col-owner-img').src = user?.photo_url || "https://i.pravatar.cc/150?u=user";
        document.getElementById('col-owner-name').innerText = user?.first_name || 'You';

        // 3. Setup Stats Display
        const setTextAndPct = (idSlot, idPct, val, permille) => {
            const slotEl = document.getElementById(idSlot);
            if(!isUpgrading && slotEl) slotEl.innerHTML = `<div class="slot-item">${val}</div>`;
            const pctEl = document.getElementById(idPct);
            if(pctEl) pctEl.innerText = `${(permille/10).toFixed(1)}%`;
        };
        setTextAndPct('slot-model', 'col-model-pct', cd.model.name, cd.model.rarityPermille);
        setTextAndPct('slot-symbol', 'col-symbol-pct', cd.pattern.name, cd.pattern.rarityPermille);
        setTextAndPct('slot-backdrop', 'col-backdrop-pct', cd.backdrop.name, cd.backdrop.rarityPermille);
        
        document.getElementById('col-quantity').innerText = `1 of 10k`;
        document.getElementById('col-value').innerText = `~${Math.floor(Math.random()*100)+5} TON`;

        // --- NEW: ADD CRAFT BUTTON LOGIC HERE ---
        // Remove existing button if present
        const existingCraftBtn = document.getElementById('col-craft-btn');
        if(existingCraftBtn) existingCraftBtn.remove();

        // Only show Craft Button if we are NOT in the middle of an upgrade animation
        if(!isUpgrading) {
            const craftBtn = document.createElement('div');
            craftBtn.id = 'col-craft-btn';
            craftBtn.className = 'craft-icon-mask';
            craftBtn.onclick = (e) => {
                e.stopPropagation();
                // Start crafting with this gift
                initCrafting(gift);
            };
            // Append to the header container
            header.appendChild(craftBtn);
        }
        // ----------------------------------------

        if (isUpgrading && partsPool) {
            // === ANIMATION MODE (Roulette) ===
            btn.innerText = "Skip";
            btn.onclick = skipAnimation;

            const subHeader = document.getElementById('collectible-model-name');
            subHeader.style.filter = 'blur(5px)';
            subHeader.style.transition = 'filter 0.5s ease';
            
            rouletteStrip.style.display = 'flex';
            imgEl.style.display = 'none'; lottieEl.style.display = 'none';
            rouletteStrip.innerHTML = '';
            
            // Fill Strip
            for(let i=0; i<30; i++) {
                const rndModel = partsPool.models[Math.floor(Math.random() * partsPool.models.length)];
                const img = document.createElement('img');
                img.src = rndModel.isCustom ? rndModel.imageUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(rndModel.name)}.png`;
                rouletteStrip.appendChild(img);
            }
            const finalImg = document.createElement('img');
            finalImg.src = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
            rouletteStrip.appendChild(finalImg);
            
            initSlotMachine('slot-model', partsPool.models.map(x=>x.name), cd.model.name);
            initSlotMachine('slot-symbol', partsPool.patterns.map(x=>x.name), cd.pattern.name);
            initSlotMachine('slot-backdrop', partsPool.backdrops.map(x=>x.name), cd.backdrop.name);

            appRuntime.animationState = { giftName: gift.name, finalData: cd, intervals: [], timeouts: [] };

            const translateX = -((30 * 160) + 80 - (window.innerWidth / 2));
            rouletteStrip.animate([{ transform: 'translateX(0)' }, { transform: `translateX(${translateX}px)` }], { duration: 6000, easing: 'cubic-bezier(0.25, 0.1, 0.25, 1)', fill: 'forwards' });

            const bgInterval = setInterval(() => {
                const rndBg = partsPool.backdrops[Math.floor(Math.random()*partsPool.backdrops.length)];
                header.style.background = `radial-gradient(circle at 50% 0%, ${rndBg.hex.centerColor}, ${rndBg.hex.edgeColor})`;
            }, 100);
            appRuntime.animationState.intervals.push(bgInterval);

            const patInterval = setInterval(() => {
                const rndPat = partsPool.patterns[Math.floor(Math.random()*partsPool.patterns.length)];
                document.getElementById('collectible-pattern-container').innerHTML = '';
                generatePattern('collectible-pattern-container', rndPat, gift.name, false, '#ffffff55');
            }, 100);
            appRuntime.animationState.intervals.push(patInterval);

            appRuntime.animationState.timeouts.push(setTimeout(() => { clearInterval(bgInterval); header.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`; stopSlotMachine('slot-backdrop', cd.backdrop.name); haptic('medium'); }, 4000));
            appRuntime.animationState.timeouts.push(setTimeout(() => { clearInterval(patInterval); document.getElementById('collectible-pattern-container').innerHTML = ''; generatePattern('collectible-pattern-container', cd.pattern, gift.name, false, cd.backdrop.hex.patternColor); stopSlotMachine('slot-symbol', cd.pattern.name); haptic('medium'); }, 6000));
            appRuntime.animationState.timeouts.push(setTimeout(() => finishAnimation(), 7500));

        } else {
            // === STATIC MODE (View Gift) ===
            btn.innerText = "OK";
            btn.onclick = () => closeModal('collectible-modal');
            rouletteStrip.style.display = 'none';
            
            const lottiePath = cd.model.isCustom ? cd.model.lottieUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/lottie/${encodeURIComponent(cd.model.name)}.json`;
            const imgPath = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
            
            if (state.settings.animations) {
                lottieEl.style.display = 'block'; imgEl.style.display = 'none';
                playLottie('collectible-lottie', lottiePath);
            } else {
                lottieEl.style.display = 'none'; imgEl.style.display = 'block';
                imgEl.src = imgPath;
            }

            document.getElementById('slot-model').innerHTML = `<div class="slot-item">${cd.model.name}</div>`;
            document.getElementById('slot-symbol').innerHTML = `<div class="slot-item">${cd.pattern.name}</div>`;
            document.getElementById('slot-backdrop').innerHTML = `<div class="slot-item">${cd.backdrop.name}</div>`;
        }

        modal.classList.add('active');
        tg.BackButton.show();
        tg.BackButton.onClick(() => closeModal('collectible-modal'));
    }

    // --- Animation Helpers ---
    function initSlotMachine(elementId, options, finalValue) {
        const wrapper = document.getElementById(elementId);
        wrapper.innerHTML = '';
        const scroll = document.createElement('div');
        scroll.className = 'slot-scroll';
        scroll.id = `${elementId}-scroll`;
        
        // Populate random items
        let html = '';
        for(let i=0; i<30; i++) {
            html += `<div class="slot-item">${options[Math.floor(Math.random()*options.length)]}</div>`;
        }
        // Append final value
        html += `<div class="slot-item" id="${elementId}-final">${finalValue}</div>`;
        scroll.innerHTML = html;
        wrapper.appendChild(scroll);

        // Start scrolling
        scroll.animate([
            { transform: 'translateY(0)' },
            { transform: 'translateY(-90%)' } // Scroll most of the way
        ], { duration: 6000, iterations: 1 });
    }

    function stopSlotMachine(elementId, finalValue) {
        const scroll = document.getElementById(`${elementId}-scroll`);
        if(scroll) {
            scroll.getAnimations().forEach(anim => anim.cancel());
            // Snap to final
            scroll.style.transform = 'none';
            scroll.innerHTML = `<div class="slot-item">${finalValue}</div>`;
        }
    }

    function skipAnimation() {
        if (!appRuntime.animationState) return;
        appRuntime.animationState.intervals.forEach(clearInterval);
        appRuntime.animationState.timeouts.forEach(clearTimeout);
        finishAnimation();
    }

    function finishAnimation() {
        if (!appRuntime.animationState) return;
        const subHeader = document.getElementById('collectible-model-name');
        subHeader.style.filter = 'blur(0px)';
        const st = appRuntime.animationState;
        const cd = st.finalData;
        const giftName = st.giftName;

        // Stop Text Slots
        stopSlotMachine('slot-model', cd.model.name);
        stopSlotMachine('slot-symbol', cd.pattern.name);
        stopSlotMachine('slot-backdrop', cd.backdrop.name);

        // Finalize Visuals
        const header = document.getElementById('collectible-header');
        header.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
        document.getElementById('collectible-pattern-container').innerHTML = '';
        generatePattern('collectible-pattern-container', cd.pattern, giftName, false, cd.backdrop.hex.patternColor);

        // Swap Roulette for Final Image
        document.getElementById('roulette-strip').style.display = 'none';
        
        const lottieEl = document.getElementById('collectible-lottie');
        const imgEl = document.getElementById('collectible-image');
        const lottiePath = cd.model.isCustom ? cd.model.lottieUrl : `${CDN_BASE}models/${encodeURIComponent(giftName)}/lottie/${encodeURIComponent(cd.model.name)}.json`;
        const imgPath = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(giftName)}/png/${encodeURIComponent(cd.model.name)}.png`;

        if (state.settings.animations) {
            lottieEl.style.display = 'block'; imgEl.style.display = 'none';
            playLottie('collectible-lottie', lottiePath);
        } else {
            lottieEl.style.display = 'none'; imgEl.style.display = 'block';
            imgEl.src = imgPath;
        }

        // Confetti - zIndex fixed
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 2001 });
        hapticNotify('success');

        // Reset Button
        const btn = document.getElementById('btn-collectible-action');
        btn.innerText = "OK";
        btn.onclick = () => closeModal('collectible-modal');

        appRuntime.animationState = null;
    }

    // --- CRAFTING SYSTEM ---

    function initCrafting(gift) {
        closeModal('detail-modal');
        craftingState = { ingredients: [], baseGiftName: gift.name, originalId: gift.originalId };
        
        // Initial add of the gift we came from
        craftingState.ingredients.push(gift);
        
        updateCraftUI();
        document.getElementById('craft-modal').classList.add('active');
        tg.BackButton.show();
        tg.BackButton.onClick(() => closeModal('craft-modal'));
    }

    function updateCraftUI() {
        // 1. Calculate Chance
        const count = craftingState.ingredients.length;
        // Base formula: 1=22%, 2=45%, 3=69%, 4=92-100% (depending on rarity)
        // Adding slight randomness or rarity logic here
        let chance = 0;
        if (count === 1) chance = 22;
        else if (count === 2) chance = 44;
        else if (count === 3) chance = 69;
        else if (count === 4) chance = 95;

        // Small bonus for using Collectibles (already upgraded gifts)
        const collectiblesCount = craftingState.ingredients.filter(g => g.isCollectible).length;
        chance += collectiblesCount * 1.5;
        if (chance > 100) chance = 100;
        
        // Update Circle
        const circle = document.getElementById('craft-progress-bar');
        const radius = circle.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        const offset = circumference - (chance / 100) * circumference;
        circle.style.strokeDashoffset = offset;
        
        // Update Text
        document.getElementById('craft-pct-text').innerText = Math.floor(chance) + "%";
        
        // Update Button
        const btn = document.getElementById('btn-do-craft');
        btn.innerHTML = `Craft Gift <span style="opacity:0.7; font-size:0.8em">(${Math.floor(chance)}% Success)</span>`;
        btn.disabled = false;
        btn.style.background = count === 4 ? '#29b358' : 'var(--tg-theme-button-color)';

        // 2. Render Slots
        const slots = document.querySelectorAll('.craft-slots-area .craft-slot');
        slots.forEach((slot, idx) => {
            slot.className = 'craft-slot';
            slot.innerHTML = '';
            slot.onclick = openIngredientPicker;
            
            if (idx < count) {
                const item = craftingState.ingredients[idx];
                slot.classList.add('filled');
                slot.onclick = () => removeIngredient(idx);
                
                // Image source
                let imgUrl = `${CDN_BASE}originals/${item.originalId}/Original.png`;
                if (item.isCollectible && item.collectibleData) {
                    const cd = item.collectibleData;
                    imgUrl = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(item.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
                    slot.style.background = `radial-gradient(circle, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
                }
                
                slot.innerHTML = `<img src="${imgUrl}"><div class="remove-x">✕</div><div class="slot-chance">+${Math.floor(chance/count)}%</div>`;
            } else {
                slot.classList.add('add-btn');
            }
        });

        // 3. Render Attribute Probability (Backdrops)
        const statsRow = document.getElementById('craft-stats-row');
        statsRow.innerHTML = '';
        
        if (count > 0) {
            // Collect backdrops
            const bgs = {};
            craftingState.ingredients.forEach(g => {
                let hex = '#333';
                // If it's a collectible, use its backdrop. If original, assume "Original" backdrop (grey)
                if(g.isCollectible) hex = g.collectibleData.backdrop.hex.centerColor;
                else hex = '#555'; // Generic color for non-upgraded
                
                if(!bgs[hex]) bgs[hex] = 0;
                bgs[hex]++;
            });
            
            // Render rings
            Object.entries(bgs).forEach(([hex, qty]) => {
                const pct = Math.round((qty / count) * 100);
                const div = document.createElement('div');
                div.className = 'prob-item';
                div.innerHTML = `<div class="prob-ring" style="background:${hex}; border-color:${hex}"><span style="color:#fff; font-size:10px; font-weight:bold; text-shadow:0 1px 2px #000;">${pct}%</span></div>`;
                statsRow.appendChild(div);
            });
        }
    }

    function removeIngredient(index) {
        craftingState.ingredients.splice(index, 1);
        updateCraftUI();
        if(craftingState.ingredients.length === 0) closeModal('craft-modal');
    }

    function openIngredientPicker() {
        if (craftingState.ingredients.length >= 4) return;
        const grid = document.getElementById('picker-grid');
        grid.innerHTML = '';
        
        // Filter compatible gifts: Same Name, Not Hidden, Not currently selected
        const selectedIds = craftingState.ingredients.map(g => g.uniqueId);
        const compatible = state.inventory.filter(g => 
            g.name === craftingState.ingredients[0].name && 
            !g.hidden && 
            !selectedIds.includes(g.uniqueId)
        );
        
        compatible.forEach(g => {
            const el = document.createElement('div');
            el.className = 'picker-item selectable';
            
            let imgUrl = `${CDN_BASE}originals/${g.originalId}/Original.png`;
            let bgStyle = '';
            if(g.isCollectible) {
                const cd = g.collectibleData;
                imgUrl = cd.model.isCustom ? cd.model.imageUrl : `${CDN_BASE}models/${encodeURIComponent(g.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
                bgStyle = `background: radial-gradient(circle, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
            }
            
            el.style.cssText = bgStyle;
            el.innerHTML = `<img src="${imgUrl}" style="width:100%; height:80px; object-fit:contain;">`;
            el.onclick = () => {
                craftingState.ingredients.push(g);
                updateCraftUI();
                closeModal('craft-picker-modal');
            };
            grid.appendChild(el);
        });
        
        document.getElementById('craft-picker-modal').classList.add('active');
    }

    async function executeCraft() {
        const btn = document.getElementById('btn-do-craft');
        const container = document.querySelector('.craft-container');
        const pctStr = document.getElementById('craft-pct-text').innerText;
        const successChance = parseInt(pctStr);
        
        btn.disabled = true;
        container.classList.add('crafting-active');
        
        // Fetch Parts needed for Result
        const parts = await fetchGiftParts(craftingState.baseGiftName);
        
        // Wait for Animation
        setTimeout(() => {
            container.classList.remove('crafting-active');
            
            // RNG Logic
            const roll = Math.random() * 100;
            const isSuccess = roll < successChance;
            
            // Identify IDs to delete
            const ingredientIds = craftingState.ingredients.map(g => g.uniqueId);
            
            // Remove ingredients from inventory
            state.inventory = state.inventory.filter(g => !ingredientIds.includes(g.uniqueId));
            
            if (isSuccess) {
                // SUCCESS!
                hapticNotify('success');
                
                // 1. Determine Model: Filter for Rare (<10 permille) or just take random if none
                let rareModels = parts.models.filter(m => (m.rarityPermille || 0) <= 10); // <= 1%
                if(rareModels.length === 0) rareModels = parts.models; // Fallback
                const resultModel = rareModels[Math.floor(Math.random() * rareModels.length)];
                
                // 2. Determine Backdrop: Weighted by ingredients
                const ingredientBackdrops = craftingState.ingredients.map(g => g.isCollectible ? g.collectibleData.backdrop : parts.backdrops[0]);
                const resultBackdrop = ingredientBackdrops[Math.floor(Math.random() * ingredientBackdrops.length)] || parts.backdrops[0];
                
                // 3. Pattern: Random
                const resultPattern = parts.patterns[Math.floor(Math.random() * parts.patterns.length)];
                
                // 4. Inherit Number from First Ingredient
                const mainIngredient = craftingState.ingredients[0];
                const resultNumber = mainIngredient.isCollectible ? mainIngredient.collectibleNumber : (state.lastCollectibleNumber + 1);
                if(!mainIngredient.isCollectible) state.lastCollectibleNumber++;

                // Create New Gift
                const newGift = {
                    uniqueId: Date.now(),
                    originalId: mainIngredient.originalId,
                    name: mainIngredient.name,
                    isCollectible: true,
                    collectibleNumber: resultNumber,
                    timestamp: Date.now(),
                    pinned: false,
                    collectibleData: {
                        model: resultModel,
                        backdrop: resultBackdrop,
                        pattern: resultPattern
                    }
                };
                
                state.inventory.unshift(newGift);
                
                // Show Success UI (Reuse Collectible Modal)
                closeModal('craft-modal');
                renderInventory();
                setTimeout(() => {
                    openCollectibleModal(newGift, false); // Open in static mode
                    confetti({ particleCount: 200, spread: 100, zIndex: 2002 });
                }, 300);
                
            } else {
                // FAILURE
                hapticNotify('error');
                closeModal('craft-modal');
                renderInventory();
                tg.showAlert(`Crafting Failed. The items broke in the process.`);
            }
            
            saveState();
            
        }, 2000); // 2 seconds animation
    }

    // --- Generic UI (Updated) ---
    function openDetailModal(gift) {
        const modal = document.getElementById('detail-modal');
        const content = document.getElementById('detail-content'); // Ensure your HTML has id="detail-content"
        const title = document.getElementById('detail-title');

        title.innerText = gift.name;
        content.innerHTML = '';

        // --- STANDARD GIFT (Render Lottie) ---
        const visualContainer = document.createElement('div');
        visualContainer.className = 'gift-visual-large';
        visualContainer.style.marginTop = '20px';
        visualContainer.style.marginBottom = '20px';

        const lottieContainer = document.createElement('div');
        lottieContainer.style.width = '180px';
        lottieContainer.style.height = '180px';
        lottieContainer.style.margin = '0 auto';
        visualContainer.appendChild(lottieContainer);

        lottie.loadAnimation({
            container: lottieContainer,
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: `${CDN_BASE}json/${gift.originalId}.json`
        });

        content.appendChild(visualContainer);

        // Info Table
        const table = document.createElement('div');
        table.className = 'detail-table';
        
        // Date Row
        const dateRow = document.createElement('div');
        dateRow.className = 'detail-row';
        dateRow.innerHTML = `<div class="detail-label">Date</div><div class="detail-value">${new Date(gift.timestamp).toLocaleDateString()}</div>`;
        table.appendChild(dateRow);

        // Send Row
        const sendRow = document.createElement('div');
        sendRow.className = 'detail-row';
        sendRow.innerHTML = `<div class="detail-label">Action</div><div class="detail-value" style="color:var(--tg-theme-link-color);">Send Gift</div>`;
        sendRow.onclick = () => tg.switchInlineQuery(gift.uniqueId.toString(), ['users']);
        table.appendChild(sendRow);

        content.appendChild(table);

        // Show Modal
        modal.classList.add('active');
        tg.BackButton.show();
        tg.BackButton.onClick(() => closeModal('detail-modal'));
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
        tg.BackButton.hide();
        if(id==='detail-modal') {
            document.getElementById('detail-lottie').innerHTML='';
            if(appRuntime.detailInterval) { clearInterval(appRuntime.detailInterval); appRuntime.detailInterval = null; }
        }
        if(id==='collectible-modal') { document.getElementById('collectible-lottie').innerHTML=''; document.getElementById('roulette-strip').innerHTML=''; if(appRuntime.animationState) skipAnimation(); }
        if (document.getElementById('shop-page').classList.contains('active')) { tg.BackButton.show(); tg.BackButton.onClick(() => switchTab('inventory')); }
    }
    
    // ... (Rest of existing functions like switchTab, playLottie, generatePattern, settings, etc. remain unchanged) ...
    function switchTab(tab) {
        haptic('light'); document.getElementById('profile-page').classList.remove('active'); document.getElementById('shop-page').classList.remove('active'); document.querySelectorAll('.profile-tabs button').forEach(b => b.classList.remove('active'));
        if (tab === 'inventory') { document.getElementById('profile-page').classList.add('active'); document.querySelectorAll('.profile-tabs button')[0].classList.add('active'); tg.BackButton.hide(); } 
        else { document.getElementById('shop-page').classList.add('active'); document.querySelectorAll('.profile-tabs button')[1].classList.add('active'); tg.BackButton.show(); tg.BackButton.onClick(() => switchTab('inventory')); }
    }
    function playLottie(id, path) { const container = document.getElementById(id); container.innerHTML = ''; lottie.loadAnimation({ container, renderer:'svg', loop:true, autoplay:true, path }); }
    function generatePattern(containerId, patternObj, giftName, isSmall, colorHex, isHeader=false) {
        const container = document.getElementById(containerId); if (!container) return; const url = `${CDN_BASE}patterns/${encodeURIComponent(giftName)}/png/${encodeURIComponent(patternObj.name)}.png`;
        let configs = isHeader ? [{ count: 12, radius: 100, size: 40 }, { count: 16, radius: 150, size: 36 }] : [{ count: 10, radius: isSmall ? 38 : 100, size: isSmall ? 12 : 36 }, { count: 12, radius: isSmall ? 62 : 150, size: isSmall ? 10 : 30 }];
        configs.forEach(conf => { for(let i=0; i<conf.count; i++) { const angle = (i/conf.count)*2*Math.PI; const x = conf.radius*Math.cos(angle); const y = conf.radius*Math.sin(angle); const el = document.createElement('div'); if(isHeader) el.className = 'profile-pattern-item'; else el.className = 'card-pattern-symbol'; el.style.webkitMaskImage = `url('${url}')`; el.style.maskImage = `url('${url}')`; if (colorHex) el.style.backgroundColor = colorHex; el.style.width = `${conf.size}px`; el.style.height = `${conf.size}px`; el.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`; container.appendChild(el); } });
    }
    function openSettingsModal() { document.getElementById('settings-modal').classList.add('active'); document.getElementById('setting-animations').checked = state.settings.animations; document.getElementById('setting-hidden').checked = state.settings.showHidden; tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('settings-modal')); }
    function toggleSetting(key, value) { state.settings[key] = value; haptic('light'); saveState(); renderInventory(); }
    function saveState() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function loadState() { const saved = localStorage.getItem(LS_KEY); if (saved) { const parsed = JSON.parse(saved); state.inventory = parsed.inventory || []; state.lastCollectibleNumber = parsed.lastCollectibleNumber || 100; state.userBio = parsed.userBio || "Hello world"; state.userPhone = parsed.userPhone || ""; if(parsed.settings) state.settings = parsed.settings; } }
    function resetAppData() { tg.showConfirm("Reset App?", (confirmed) => { if(confirmed) { localStorage.removeItem(LS_KEY); location.reload(); }}); }
    
    // --- Context Menu & Queue Logic ---
    function openMenu(e, gift) { appRuntime.activeGiftId = gift.uniqueId; const menu = document.getElementById('long-press-menu'); document.getElementById('menu-pin').style.display = gift.isCollectible?'block':'none'; document.getElementById('menu-pin').innerText = gift.pinned?"Unpin":"Pin"; document.getElementById('menu-wear').style.display = gift.isCollectible?'block':'none'; document.getElementById('menu-wear').innerText = gift.worn?"Take Off":"Wear"; document.getElementById('menu-reorder').style.display = (gift.isCollectible&&gift.pinned&&state.inventory.filter(g=>g.pinned).length>1)?'block':'none'; document.getElementById('menu-hide').innerText = gift.hidden?"Unhide":"Hide"; let x = e.clientX, y = e.clientY; if(x+180>window.innerWidth) x=window.innerWidth-190; if(y+160>window.innerHeight) y=window.innerHeight-170; menu.style.left=x+'px'; menu.style.top=y+'px'; menu.classList.remove('hidden'); }
    function togglePin() { const g = state.inventory.find(x=>x.uniqueId===appRuntime.activeGiftId); if(g.pinned) {g.pinned=false;g.pinOrder=null;} else {if(state.inventory.filter(x=>x.pinned).length>=6) return alert("Max 6"); g.pinned=true;g.pinOrder=999;} document.getElementById('long-press-menu').classList.add('hidden'); haptic('light'); saveState(); renderInventory(); }
    function toggleWear() { const g = state.inventory.find(x=>x.uniqueId===appRuntime.activeGiftId); if(g.worn) g.worn=false; else {state.inventory.forEach(x=>x.worn=false); g.worn=true;} document.getElementById('long-press-menu').classList.add('hidden'); hapticNotify('success'); saveState(); renderInventory(); applyWornGiftVisuals(); }
    function applyWornGiftVisuals() { const worn = state.inventory.find(g => g.worn); const bg = document.getElementById('profile-bg'); document.getElementById('profile-pattern-overlay').innerHTML = ''; if (worn) { const cd = worn.collectibleData; bg.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`; bg.classList.add('has-worn-gift'); generatePattern('profile-pattern-overlay', cd.pattern, worn.name, false, cd.backdrop.hex.patternColor, true); } else { bg.style.background = 'var(--app-profile-gradient-fallback)'; bg.classList.remove('has-worn-gift'); } }
    function toggleHide() { const g = state.inventory.find(x=>x.uniqueId===appRuntime.activeGiftId); g.hidden=!g.hidden; if(g.hidden){g.pinned=false;g.worn=false;} document.getElementById('long-press-menu').classList.add('hidden'); haptic('light'); saveState(); renderInventory(); applyWornGiftVisuals(); }
    function deleteGift() { tg.showConfirm("Delete?",(y)=>{if(y){state.inventory=state.inventory.filter(x=>x.uniqueId!==appRuntime.activeGiftId); haptic('heavy'); saveState(); renderInventory(); applyWornGiftVisuals();}}); document.getElementById('long-press-menu').classList.add('hidden'); }
    function startReorderMode() { document.getElementById('long-press-menu').classList.add('hidden'); appRuntime.reordering = true; document.getElementById('reorder-controls').classList.remove('hidden'); document.getElementById('inventory-grid').classList.add('reordering'); haptic('medium'); appRuntime.sortable = new Sortable(document.getElementById('inventory-grid'), { animation: 150, filter: ':not([data-pinned="true"])', draggable: '[data-pinned="true"]', onMove: (evt) => evt.related.hasAttribute('data-pinned') }); }
    function stopReorderMode() { appRuntime.reordering = false; document.getElementById('reorder-controls').classList.add('hidden'); document.getElementById('inventory-grid').classList.remove('reordering'); if (appRuntime.sortable) { appRuntime.sortable.toArray().forEach((id, index) => { const g = state.inventory.find(x => x.uniqueId == id); if(g && g.pinned) g.pinOrder = index; }); appRuntime.sortable.destroy(); haptic('light'); saveState(); renderInventory(); } }
    function startSelectionMode(mode) { appRuntime.selectionMode = mode; appRuntime.selectedIds = new Set(); closeModal('settings-modal'); renderInventory(); }
    function cancelSelectionMode() { appRuntime.selectionMode = null; appRuntime.selectedIds = new Set(); renderInventory(); }
    function toggleSelection(id) { if(appRuntime.selectedIds.has(id)) appRuntime.selectedIds.delete(id); else appRuntime.selectedIds.add(id); haptic('light'); renderInventory(); }
    function confirmHideSelected() { const ids = Array.from(appRuntime.selectedIds); if(ids.length>0) { state.inventory.forEach(g => { if(ids.includes(g.uniqueId)) { g.hidden = true; g.pinned = false; g.worn = false; } }); hapticNotify('success'); saveState(); } cancelSelectionMode(); applyWornGiftVisuals(); }
    function initCustomizationQueue() { customizationQueue = []; editingIndex = -1; addGiftToQueue(); }
    function addGiftToQueue() { document.querySelectorAll('.filter-option.selected').forEach(el => el.classList.remove('selected')); customizationQueue.push({ id:null, name:null, parts: { model:null, backdrop:null, pattern:null } }); selectQueueItem(customizationQueue.length - 1); document.getElementById('cust-base-grid').classList.remove('hidden'); document.getElementById('cust-parts-container').classList.add('hidden'); }
    function selectQueueItem(index) { editingIndex = index; renderQueueBar(); const curr = customizationQueue[editingIndex]; if(curr.id) loadBaseConfig(curr.id, curr.name, false); else { const baseGrid = document.getElementById('cust-base-grid'); Array.from(baseGrid.children).forEach(c => c.classList.remove('selected')); document.getElementById('cust-parts-container').classList.add('hidden'); updateCreateButton(); } }
    function renderQueueBar() { const bar = document.getElementById('cust-queue-bar'); bar.innerHTML = ''; customizationQueue.forEach((q, idx) => { const el = document.createElement('div'); el.className = `queue-chip ${idx === editingIndex ? 'active' : ''}`; el.innerHTML = `<span>${q.name || `Gift ${idx+1}`}</span> ${customizationQueue.length > 1 ? `<span class="close-x">×</span>` : ''}`; el.onclick = (e) => { if (e.target.classList.contains('close-x')) { e.stopPropagation(); customizationQueue.splice(idx, 1); if(editingIndex >= customizationQueue.length) editingIndex = customizationQueue.length - 1; if(customizationQueue.length === 0) addGiftToQueue(); else selectQueueItem(editingIndex); } else selectQueueItem(idx); }; bar.appendChild(el); }); const addBtn = document.createElement('div'); addBtn.className = 'queue-chip add-gift-chip'; addBtn.innerHTML = '<span>+ Add Gift</span>'; addBtn.onclick = addGiftToQueue; bar.appendChild(addBtn); }
    async function openCustomizeModal() { document.getElementById('customize-modal').classList.add('active'); tg.BackButton.show(); tg.BackButton.onClick(() => closeModal('customize-modal')); initCustomizationQueue(); const grid = document.getElementById('cust-base-grid'); grid.innerHTML = ''; Object.entries(state.giftDefinitions).forEach(([id, name]) => { if (['custom_skebob', 'custom_baggin_cat'].includes(id)) return; const el = document.createElement('div'); el.className = 'filter-option'; el.innerHTML = `<img src="${CDN_BASE}originals/${id}/Original.png"><div class="label">${name}</div>`; el.onclick = () => loadBaseConfig(id, name, true); grid.appendChild(el); }); }
    async function loadBaseConfig(id, name, resetParts) { haptic('light'); const curr = customizationQueue[editingIndex]; if(curr.id !== id || resetParts) { curr.id = id; curr.name = name; curr.parts = { model:null, backdrop:null, pattern:null }; } renderQueueBar(); const baseGrid = document.getElementById('cust-base-grid'); Array.from(baseGrid.children).forEach(c => { c.classList.remove('selected'); if(c.innerText === name) c.classList.add('selected'); }); if(!cachedParts[id]) cachedParts[id] = await fetchGiftParts(name); const parts = cachedParts[id]; renderPartGrid('cust-model-grid', parts.models, 'model', name); renderPartGrid('cust-backdrop-grid', parts.backdrops, 'backdrop', name); renderPartGrid('cust-pattern-grid', parts.patterns, 'pattern', name); document.getElementById('cust-parts-container').classList.remove('hidden'); updateCreateButton(); }
    function renderPartGrid(elemId, items, type, giftName) { const grid = document.getElementById(elemId); grid.innerHTML = ''; const curr = customizationQueue[editingIndex]; items.forEach(item => { const el = document.createElement('div'); el.className = 'filter-option'; let content = ''; if (type === 'model') content = `<img src="${item.isCustom?item.imageUrl:`${CDN_BASE}models/${encodeURIComponent(giftName)}/png/${encodeURIComponent(item.name)}.png`}">`; else if (type === 'backdrop') content = `<div class="gradient-square" style="background: radial-gradient(circle, ${item.hex.centerColor}, ${item.hex.edgeColor})"></div>`; else content = `<img src="${CDN_BASE}patterns/${encodeURIComponent(giftName)}/png/${encodeURIComponent(item.name)}.png">`; el.innerHTML = `${content}<div class="label">${item.name}</div>`; if (curr.parts[type] && curr.parts[type].name === item.name) el.classList.add('selected'); el.onclick = () => { haptic('light'); Array.from(grid.children).forEach(c => c.classList.remove('selected')); el.classList.add('selected'); curr.parts[type] = item; updateCreateButton(); }; grid.appendChild(el); }); }
    function updateCreateButton() { const btn = document.getElementById('btn-create-custom'); const allReady = customizationQueue.every(q => q.id && q.parts.model && q.parts.backdrop); btn.disabled = !allReady; btn.innerText = customizationQueue.length > 1 ? `Create All (${customizationQueue.length})` : 'Create'; }
    function handleCreateQueue() { customizationQueue.forEach(q => { if(!q.id) return; if(!q.parts.pattern) { const parts = cachedParts[q.id]; if(parts && parts.patterns.length) q.parts.pattern = parts.patterns[Math.floor(Math.random() * parts.patterns.length)]; } if(!q.parts.model || !q.parts.backdrop || !q.parts.pattern) return; state.lastCollectibleNumber++; state.inventory.unshift({ uniqueId: Date.now() + Math.random(), originalId: q.id, name: q.name, isCollectible: true, timestamp: Date.now(), pinned: false, collectibleNumber: state.lastCollectibleNumber, collectibleData: { model: q.parts.model, backdrop: q.parts.backdrop, pattern: q.parts.pattern } }); }); hapticNotify('success'); saveState(); renderInventory(); closeModal('customize-modal'); switchTab('inventory'); }
</script>
</body>
</html>
