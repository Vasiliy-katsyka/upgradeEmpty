<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Gift Simulator</title>
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Lottie Player -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <style>
        :root {
            /* Default fallback colors (will be overwritten by Telegram Theme) */
            --tg-theme-bg-color: #0e1621;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #62bcf9;
            --tg-theme-button-color: #3e97f0;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #17212b;
            --tg-theme-accent-text-color: #5288c1;

            --app-modal-backdrop-color: rgba(0,0,0,0.7);
            --app-rarity-chip-bg: rgba(0,0,0,0.2);
            --app-action-button-bg: var(--tg-theme-secondary-bg-color); 
            --app-profile-gradient-fallback: var(--tg-theme-secondary-bg-color);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            overscroll-behavior-y: none;
            font-size: 16px;
            overflow-x: hidden;
            user-select: none;
        }

        .app-container { max-width: 600px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; }
        .page { display: none; flex-direction: column; flex-grow: 1; background-color: var(--tg-theme-bg-color); }
        .page.active { display: flex; }

        /* Header */
        .page-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 15px; background-color: var(--tg-theme-secondary-bg-color);
            min-height: 56px; position: sticky; top: 0; z-index: 10;
        }
        .page-header h2 { font-size: 1.15em; font-weight: 500; }
        
        /* Profile Top */
        .profile-top-section {
            padding-top: 30px; padding-bottom: 20px;
            background: var(--app-profile-gradient-fallback);
            display: flex; justify-content: center; position: relative;
        }
        .profile-main-info { display: flex; flex-direction: column; align-items: center; z-index: 2; }
        .profile-avatar {
            width: 100px; height: 100px; border-radius: 50%;
            background-color: var(--tg-theme-hint-color); margin-bottom: 15px;
            object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .profile-name-status h1 { font-size: 1.4em; font-weight: 600; text-align: center; }
        .profile-name-status p { font-size: 0.95em; opacity: 0.7; text-align: center; margin-top: 3px; color: var(--tg-theme-link-color); }

        /* Tabs */
        .profile-tabs { display: flex; justify-content: space-around; background-color: var(--tg-theme-bg-color); border-bottom: 1px solid var(--tg-theme-secondary-bg-color); }
        .profile-tabs button {
            background: none; border: none; color: var(--tg-theme-hint-color);
            padding: 14px 10px; font-size: 1em; cursor: pointer; flex-grow: 1;
            font-weight: 500; border-bottom: 3px solid transparent;
        }
        .profile-tabs button.active { color: var(--tg-theme-link-color); border-bottom-color: var(--tg-theme-link-color); }

        /* Grid */
        .gifts-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px;
            flex-grow: 1; overflow-y: auto; align-content: start;
        }
        
        /* Gift Card (Inventory) - Remains Square */
        .gift-card {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 14px; padding: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            aspect-ratio: 1 / 1; 
            cursor: pointer; position: relative; overflow: hidden;
            transition: transform 0.1s ease-out;
        }

        /* Shop Card (Buy) - Taller */
        .buy-gift-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 14px; padding: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            aspect-ratio: 1 / 1.35; /* Increased height by roughly 35% relative to width */
            cursor: pointer; position: relative; overflow: hidden;
            transition: transform 0.1s ease-out;
        }

        .gift-card:active, .buy-gift-item:active { transform: scale(0.96); }
        
        /* Pin Indicator */
        .pin-indicator {
            position: absolute; top: 5px; left: 5px; z-index: 5;
            width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;
        }
        .pin-indicator svg { fill: var(--tg-theme-text-color); width: 100%; height: 100%; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); }

        .gift-card.is-hidden { opacity: 0.5; filter: grayscale(1); }

        .image-container {
            width: 70%; height: 70%; display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 2; margin-bottom: 5px;
        }
        .buy-gift-item .image-container {
            height: 60%; /* Adjust image container for taller card */
        }

        .image-container img, .image-container .lottie-wrapper { max-width: 100%; max-height: 100%; object-fit: contain; }
        .lottie-wrapper { width: 100%; height: 100%; }
        
        .gift-name { font-size: 0.75em; text-align: center; margin-top: 5px; z-index: 2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .gift-price { font-size: 0.8em; color: var(--tg-theme-hint-color); margin-top: 4px; font-weight: bold; z-index: 2;}

        /* Patterns */
        .gift-card-bg-pattern { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }
        .dynamic-pattern-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1; overflow: hidden; pointer-events: none; }
        
        .card-pattern-symbol { 
            position: absolute; 
            width: 30px; height: 30px;
            background-color: currentColor; 
            -webkit-mask-size: contain; -webkit-mask-repeat: no-repeat; -webkit-mask-position: center;
            mask-size: contain; mask-repeat: no-repeat; mask-position: center;
            opacity: 0.15; transform-origin: center center; 
        }
        
        .top-right-label {
            position: absolute; top: 12px; right: -34px; transform: rotate(45deg);
            background: rgba(0,0,0,0.5); color: white; font-size: 0.65em;
            padding: 2px 35px; z-index: 4; font-weight: 500;
        }

        /* Buttons */
        .action-button {
            background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
            border: none; padding: 6px 14px; border-radius: 16px; font-size: 0.85em; cursor: pointer;
        }
        
        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--app-modal-backdrop-color);
            display: flex; align-items: flex-end; justify-content: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: 0.2s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        
        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            border-top-left-radius: 12px; border-top-right-radius: 12px;
            width: 100%; max-width: 600px; max-height: 90vh;
            display: flex; flex-direction: column; overflow: hidden;
        }
        
        /* Specific height for Customize Modal */
        #customize-modal .modal-content {
            height: 85vh; /* Taller */
        }

        .modal-header-bar { padding: 15px; text-align: center; font-weight: 500; border-bottom: 1px solid rgba(0,0,0,0.1); background: var(--tg-theme-secondary-bg-color); position: relative; z-index: 10; }
        .modal-scrollable-content { overflow-y: auto; padding: 0; flex-grow: 1; }
        .modal-buttons-footer { padding: 15px; display: flex; gap: 10px; background: var(--tg-theme-secondary-bg-color); border-top: 1px solid rgba(0,0,0,0.1); }
        .modal-button {
            flex: 1; padding: 12px; border-radius: 8px; border: none;
            font-size: 1em; font-weight: 500; cursor: pointer;
            background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
        }
        .modal-button.secondary { background-color: var(--tg-theme-bg-color); color: var(--tg-theme-link-color); }
        
        .info-row { display: flex; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .info-label { color: var(--tg-theme-hint-color); }
        .rarity-chip { background: var(--app-rarity-chip-bg); padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-left: 5px; }

        /* Collectible Modal Specifics */
        .collectible-display-area {
            position: relative; padding: 40px 0; text-align: center; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .collectible-display-area h3 { margin-top: 15px; position: relative; z-index: 2; font-size: 1.5em; }
        .collectible-display-area p { color: rgba(255,255,255,0.7); position: relative; z-index: 2; margin-top: 5px; }

        /* Long Press Menu */
        #long-press-menu {
            position: fixed; background: var(--tg-theme-secondary-bg-color);
            border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 2000; min-width: 180px; padding: 5px 0;
        }
        #long-press-menu li {
            padding: 10px 15px; list-style: none; cursor: pointer;
            color: var(--tg-theme-text-color);
        }
        #long-press-menu li:hover { background: rgba(255,255,255,0.05); }
        #long-press-menu li.danger { color: #ff595a; }

        /* Filter Grid in Customization */
        .filter-section { padding: 0 15px; }
        .filter-section h4 { margin: 15px 0 10px; color: var(--tg-theme-hint-color); font-size: 0.9em; text-transform: uppercase; }
        
        /* 3 Items per row for customization */
        .filter-options-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
            overflow-y: auto; 
            padding-bottom: 5px; 
        }
        
        .filter-option {
            background: var(--tg-theme-bg-color); border-radius: 8px; padding: 10px;
            cursor: pointer; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 90px;
        }
        .filter-option.selected { border-color: var(--tg-theme-link-color); }
        .filter-option img { width: 50px; height: 50px; object-fit: contain; }
        .filter-option .label { font-size: 0.7em; margin-top: 6px; text-align: center; overflow: hidden; white-space: nowrap; width: 100%; text-overflow: ellipsis;}
        .gradient-square { width: 50px; height: 50px; border-radius: 50%; }

        /* Settings Toggle */
        .switch-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--tg-theme-hint-color); transition: .4s; border-radius: 34px; opacity: 0.3; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--tg-theme-button-color); opacity: 1; }
        input:checked + .slider:before { transform: translateX(22px); }

        .spinner { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--tg-theme-link-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .reordering .gift-card { opacity: 0.5; }
        .reordering .gift-card[data-pinned="true"] { opacity: 1; cursor: grab; box-shadow: 0 0 0 2px var(--tg-theme-link-color); }
    </style>
</head>
<body>

<div class="app-container">
    <!-- Profile Page -->
    <div id="profile-page" class="page active">
        <div class="page-header">
            <h2>Profile</h2>
            <div>
                <button class="action-button" onclick="openSettingsModal()">Settings</button>
            </div>
        </div>
        <div class="profile-top-section" id="profile-bg">
            <div class="profile-main-info">
                <img src="" class="profile-avatar" id="user-avatar">
                <div class="profile-name-status">
                    <h1 id="user-name">Loading...</h1>
                    <p id="gift-count-display">0 gifts</p>
                </div>
            </div>
        </div>
        <div class="profile-tabs">
            <button class="active" onclick="switchTab('inventory')">Inventory</button>
            <button onclick="switchTab('shop')">Gift Shop</button>
        </div>
        <div class="gifts-grid" id="inventory-grid">
            <!-- Inventory items go here -->
        </div>
    </div>

    <!-- Shop Page -->
    <div id="shop-page" class="page">
        <div class="page-header">
            <h2>Gift Shop</h2>
            <button class="action-button" onclick="openCustomizeModal()">Customize</button>
        </div>
        <div class="gifts-grid" id="shop-grid">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar">Settings</div>
        <div class="modal-scrollable-content">
            <div class="switch-row">
                <span>Animations (Lottie)</span>
                <label class="switch">
                    <input type="checkbox" id="setting-animations" onchange="toggleSetting('animations', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="switch-row">
                <span>Show Hidden Gifts</span>
                <label class="switch">
                    <input type="checkbox" id="setting-hidden" onchange="toggleSetting('showHidden', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
            <div style="padding: 20px;">
                <button class="modal-button secondary" style="width:100%; color: #ff595a;" onclick="resetAppData()">Reset All Data</button>
            </div>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" onclick="closeModal('settings-modal')">Close</button>
        </div>
    </div>
</div>

<!-- Gift Detail / Upgrade Modal -->
<div id="detail-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar"><span id="detail-title">Gift</span></div>
        <div class="modal-scrollable-content" style="padding: 20px; text-align: center;">
            <div class="image-container" style="width: 160px; height: 160px; margin: 0 auto;">
                <img id="detail-image" src="" style="display:none;">
                <div id="detail-lottie" class="lottie-wrapper"></div>
            </div>
            <p style="color: var(--tg-theme-hint-color); margin-top: 15px; line-height: 1.5;" id="detail-desc">
                This is a regular gift. Upgrade it to make it a unique collectible!
            </p>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button" id="btn-upgrade" onclick="handleUpgrade()">✨ Upgrade (Free)</button>
            <button class="modal-button secondary" onclick="closeModal('detail-modal')">Close</button>
        </div>
    </div>
</div>

<!-- Collectible Detail Modal -->
<div id="collectible-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-scrollable-content" style="padding: 0;">
            <div id="collectible-display-area" class="collectible-display-area">
                <div id="collectible-pattern-container" class="dynamic-pattern-container"></div>
                <div style="position: relative; z-index: 2; width: 100%; display: flex; flex-direction: column; align-items: center;">
                    <div style="width: 180px; height: 180px; display:flex; align-items:center; justify-content:center;">
                        <img id="collectible-image" src="" style="max-width: 100%; max-height: 100%; object-fit: contain; display:none;">
                        <div id="collectible-lottie" class="lottie-wrapper"></div>
                    </div>
                    <h3 id="collectible-name">Name</h3>
                    <p>Collectible #<span id="collectible-number"></span></p>
                </div>
            </div>
            <!-- Info Table -->
            <div style="background: var(--tg-theme-secondary-bg-color);">
                <div class="info-row"><span class="info-label">Model</span><span class="info-value" id="info-model"></span></div>
                <div class="info-row"><span class="info-label">Backdrop</span><span class="info-value" id="info-backdrop"></span></div>
                <div class="info-row"><span class="info-label">Symbol</span><span class="info-value" id="info-pattern"></span></div>
            </div>
        </div>
        <div class="modal-buttons-footer">
            <button class="modal-button secondary" onclick="closeModal('collectible-modal')">Close</button>
        </div>
    </div>
</div>

<!-- Customize Modal -->
<div id="customize-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header-bar">Customize Gift</div>
        <div class="modal-scrollable-content" style="padding: 0;">
            <div class="filter-section">
                <h4>Select Base Gift</h4>
                <div class="filter-options-grid" id="cust-base-grid"></div>
            </div>
            
            <div id="cust-parts-container" class="hidden">
                <div class="filter-section">
                    <h4>Select Model</h4>
                    <div class="filter-options-grid" id="cust-model-grid"></div>
                </div>
                <div class="filter-section">
                    <h4>Select Backdrop</h4>
                    <div class="filter-options-grid" id="cust-backdrop-grid"></div>
                </div>
                <div class="filter-section">
                    <h4>Select Symbol</h4>
                    <div class="filter-options-grid" id="cust-pattern-grid"></div>
                </div>
            </div>
        </div>
        <div class="modal-buttons-footer">
            <!-- Main Button is handled by TG API, fallback here just in case -->
            <button class="modal-button" id="btn-create-custom" disabled onclick="handleCreateCustom()">Create</button>
            <button class="modal-button secondary" onclick="closeModal('customize-modal')">Cancel</button>
        </div>
    </div>
</div>

<!-- Long Press Menu -->
<div id="long-press-menu" class="hidden">
    <ul>
        <li id="menu-pin" onclick="togglePin()">Pin to Profile</li>
        <li id="menu-reorder" class="hidden" onclick="startReorderMode()">Reorder Pins</li>
        <li id="menu-hide" onclick="toggleHide()">Hide Gift</li>
        <li class="danger" onclick="deleteGift()">Delete</li>
    </ul>
</div>

<div id="reorder-controls" class="page-header hidden" style="position:fixed; top:0; left:0; right:0; background:var(--tg-theme-bg-color); z-index:100; justify-content:center;">
    <button class="action-button" onclick="stopReorderMode()">Done Reordering</button>
</div>

<script>
    // --- Telegram API Init ---
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();

    // --- Constants & Config ---
    const CDN_BASE = "https://cdn.changes.tg/gifts/";
    const LS_KEY = "web_gift_app_v3";
    const PIN_ICON = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" /></svg>`;

    // --- State ---
    let state = {
        inventory: [], 
        giftDefinitions: {}, 
        lastCollectibleNumber: 100,
        settings: {
            animations: true,
            showHidden: false
        }
    };

    let customizationState = {
        selectedBaseId: null, selectedBaseName: null,
        selectedModel: null, selectedBackdrop: null, selectedPattern: null,
        cachedParts: {}
    };

    let appRuntime = {
        longPressTimer: null,
        activeGiftId: null, 
        reordering: false,
        sortable: null
    };

    // --- Initialization ---
    window.addEventListener('DOMContentLoaded', async () => {
        applyTelegramTheme();
        tg.onEvent('themeChanged', applyTelegramTheme);

        // Load user data
        const user = tg.initDataUnsafe.user;
        const nameEl = document.getElementById('user-name');
        const avatarEl = document.getElementById('user-avatar');
        
        if (user) {
            nameEl.innerText = [user.first_name, user.last_name].filter(Boolean).join(' ');
            if (user.photo_url) {
                avatarEl.src = user.photo_url;
            } else {
                avatarEl.src = `https://i.pravatar.cc/150?u=${user.id}`;
            }
        } else {
            nameEl.innerText = "Web User";
            avatarEl.src = "https://i.pravatar.cc/150?u=test";
        }

        loadState();
        initSettingsUI();
        await fetchGiftDefinitions();
        renderShop();
        renderInventory();
        
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('long-press-menu');
            if (!menu.classList.contains('hidden') && !menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });
    });

    function applyTelegramTheme() {
        const p = tg.themeParams;
        const r = document.documentElement.style;
        
        if (p.bg_color) r.setProperty('--tg-theme-bg-color', p.bg_color);
        if (p.text_color) r.setProperty('--tg-theme-text-color', p.text_color);
        if (p.hint_color) r.setProperty('--tg-theme-hint-color', p.hint_color);
        if (p.link_color) r.setProperty('--tg-theme-link-color', p.link_color);
        if (p.button_color) r.setProperty('--tg-theme-button-color', p.button_color);
        if (p.button_text_color) r.setProperty('--tg-theme-button-text-color', p.button_text_color);
        if (p.secondary_bg_color) r.setProperty('--tg-theme-secondary-bg-color', p.secondary_bg_color);
    }

    function haptic(style) {
        if (tg.HapticFeedback) {
            tg.HapticFeedback.impactOccurred(style || 'light');
        }
    }

    function hapticNotify(type) {
        if (tg.HapticFeedback) {
            tg.HapticFeedback.notificationOccurred(type);
        }
    }

    // --- Data Fetching ---
    async function fetchGiftDefinitions() {
        try {
            const res = await fetch(`${CDN_BASE}id-to-name.json`);
            if (!res.ok) throw new Error("Failed to load gifts");
            state.giftDefinitions = await res.json();
        } catch (e) {
            console.error(e);
        }
    }

    async function fetchGiftParts(giftName) {
        const encName = encodeURIComponent(giftName);
        try {
            const [mRes, bRes, pRes] = await Promise.all([
                fetch(`${CDN_BASE}models/${encName}/models.json`),
                fetch(`${CDN_BASE}backdrops/${encName}/backdrops.json`),
                fetch(`${CDN_BASE}patterns/${encName}/patterns.json`)
            ]);
            return {
                models: mRes.ok ? await mRes.json() : [],
                backdrops: bRes.ok ? await bRes.json() : [],
                patterns: pRes.ok ? await pRes.json() : []
            };
        } catch (e) {
            return { models: [], backdrops: [], patterns: [] };
        }
    }

    // --- Rendering ---
    function renderShop() {
        const grid = document.getElementById('shop-grid');
        grid.innerHTML = '';
        
        Object.entries(state.giftDefinitions).forEach(([id, name]) => {
            if (['custom_skebob', 'custom_baggin_cat'].includes(id)) return;

            const el = document.createElement('div');
            el.className = 'buy-gift-item';
            const imgUrl = `${CDN_BASE}originals/${id}/Original.png`;
            
            el.innerHTML = `
                <div class="image-container"><img src="${imgUrl}" loading="lazy" onerror="this.style.display='none'"></div>
                <div class="gift-name">${name}</div>
                <div class="gift-price">Free</div>
            `;
            el.onclick = () => buyGift(id, name);
            grid.appendChild(el);
        });
    }

    function renderInventory() {
        const grid = document.getElementById('inventory-grid');
        if (appRuntime.reordering) return; 

        grid.innerHTML = '';
        
        let displayList = state.settings.showHidden ? state.inventory : state.inventory.filter(g => !g.hidden);

        document.getElementById('gift-count-display').innerText = `${state.inventory.length} gifts`;

        if (displayList.length === 0) {
            grid.innerHTML = `<div style="grid-column: span 3; text-align:center; padding: 40px 20px; color: var(--tg-theme-hint-color);">
                ${state.inventory.length > 0 ? "All gifts are hidden." : "No gifts yet. Check the shop!"}
            </div>`;
            return;
        }

        // Sort: Pinned (by order), Collectibles, Recent
        displayList.sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            if (a.pinned && b.pinned) return (a.pinOrder || 0) - (b.pinOrder || 0);
            
            // New items logic: simple sort by timestamp descending
            return b.timestamp - a.timestamp;
        });

        displayList.forEach(gift => {
            const el = document.createElement('div');
            el.className = 'gift-card';
            el.dataset.id = gift.uniqueId;
            if (gift.pinned) el.dataset.pinned = "true";
            if (gift.hidden) el.classList.add('is-hidden');
            
            el.addEventListener('touchstart', (e) => startLongPress(e, gift), {passive: false});
            el.addEventListener('touchend', cancelLongPress);
            el.addEventListener('touchmove', cancelLongPress);
            el.addEventListener('contextmenu', (e) => { e.preventDefault(); openMenu(e, gift); });

            if (gift.isCollectible) {
                const cd = gift.collectibleData;
                const bgStyle = `radial-gradient(circle, ${cd.backdrop.hex.centerColor}, ${cd.backdrop.hex.edgeColor})`;
                const imgUrl = `${CDN_BASE}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
                const lottieUrl = `${CDN_BASE}models/${encodeURIComponent(gift.name)}/lottie/${encodeURIComponent(cd.model.name)}.json`;
                
                let visualHtml = '';
                if (state.settings.animations) {
                    visualHtml = `<div class="lottie-wrapper" id="lottie-card-${gift.uniqueId}"></div>`;
                    setTimeout(() => playLottie(`lottie-card-${gift.uniqueId}`, lottieUrl), 0);
                } else {
                    visualHtml = `<img src="${imgUrl}" loading="lazy">`;
                }

                el.innerHTML = `
                    ${gift.pinned ? `<div class="pin-indicator">${PIN_ICON}</div>` : ''}
                    <div class="top-right-label">#${gift.collectibleNumber}</div>
                    <div class="gift-card-bg-pattern" style="background: ${bgStyle}"></div>
                    <div class="dynamic-pattern-container" id="pat-${gift.uniqueId}"></div>
                    <div class="image-container">${visualHtml}</div>
                    <div class="gift-name">${cd.model.name}</div>
                `;
                setTimeout(() => generatePattern(`pat-${gift.uniqueId}`, cd.pattern, gift.name, true, cd.backdrop.hex.patternColor), 0);
                el.onclick = () => openCollectibleModal(gift);
            } else {
                const imgUrl = `${CDN_BASE}originals/${gift.originalId}/Original.png`;
                const lottieUrl = `${CDN_BASE}originals/${gift.originalId}/Original.json`;
                
                let visualHtml = '';
                if (state.settings.animations) {
                    visualHtml = `<div class="lottie-wrapper" id="lottie-card-${gift.uniqueId}"></div>`;
                    setTimeout(() => playLottie(`lottie-card-${gift.uniqueId}`, lottieUrl), 0);
                } else {
                    visualHtml = `<img src="${imgUrl}" loading="lazy">`;
                }

                el.innerHTML = `
                    <div class="image-container">${visualHtml}</div>
                    <div class="gift-name">${gift.name}</div>
                `;
                el.onclick = () => openDetailModal(gift);
            }
            grid.appendChild(el);
        });
    }

    // --- Actions ---
    function buyGift(id, name) {
        const newGift = {
            uniqueId: Date.now() + Math.random(),
            originalId: id,
            name: name,
            isCollectible: false,
            timestamp: Date.now(),
            pinned: false,
            hidden: false
        };
        // Add to beginning of array (top of list)
        state.inventory.unshift(newGift);
        saveState();
        renderInventory();
        switchTab('inventory');
        hapticNotify('success');
    }

    // --- Upgrading ---
    async function handleUpgrade() {
        const btn = document.getElementById('btn-upgrade');
        btn.innerText = "Upgrading...";
        btn.disabled = true;

        const gift = state.inventory.find(g => g.uniqueId === appRuntime.activeGiftId);
        if (!gift) return;

        const parts = await fetchGiftParts(gift.name);
        if (parts.models.length === 0) {
            tg.showAlert("No upgrade parts found for this gift!");
            btn.innerText = "✨ Upgrade (Free)";
            btn.disabled = false;
            return;
        }

        const rModel = parts.models[Math.floor(Math.random() * parts.models.length)];
        const rBackdrop = parts.backdrops[Math.floor(Math.random() * parts.backdrops.length)];
        const rPattern = parts.patterns[Math.floor(Math.random() * parts.patterns.length)];

        gift.isCollectible = true;
        state.lastCollectibleNumber++;
        gift.collectibleNumber = state.lastCollectibleNumber;
        gift.collectibleData = { model: rModel, backdrop: rBackdrop, pattern: rPattern };

        hapticNotify('success');
        saveState();
        renderInventory();
        closeModal('detail-modal');
        btn.innerText = "✨ Upgrade (Free)";
        btn.disabled = false;
        openCollectibleModal(gift);
    }

    // --- Menu Actions ---
    function startLongPress(e, gift) {
        appRuntime.longPressTimer = setTimeout(() => {
            haptic('medium');
            openMenu(e.touches[0], gift);
        }, 500);
    }
    function cancelLongPress() { clearTimeout(appRuntime.longPressTimer); }

    function openMenu(e, gift) {
        appRuntime.activeGiftId = gift.uniqueId;
        const menu = document.getElementById('long-press-menu');
        const pinBtn = document.getElementById('menu-pin');
        const reorderBtn = document.getElementById('menu-reorder');
        const hideBtn = document.getElementById('menu-hide');

        if (!gift.isCollectible) {
            pinBtn.style.display = 'none';
            reorderBtn.style.display = 'none';
        } else {
            pinBtn.style.display = 'block';
            pinBtn.innerText = gift.pinned ? "Unpin from Profile" : "Pin to Profile";
            const pinnedCount = state.inventory.filter(g => g.pinned).length;
            reorderBtn.style.display = (gift.pinned && pinnedCount > 1) ? 'block' : 'none';
        }

        hideBtn.innerText = gift.hidden ? "Unhide Gift" : "Hide Gift";

        let x = e.clientX;
        let y = e.clientY;
        if (x + 180 > window.innerWidth) x = window.innerWidth - 190;
        if (y + 160 > window.innerHeight) y = window.innerHeight - 170;

        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        menu.classList.remove('hidden');
    }

    function togglePin() {
        const gift = state.inventory.find(g => g.uniqueId === appRuntime.activeGiftId);
        if (!gift) return;
        
        if (gift.pinned) {
            gift.pinned = false;
            gift.pinOrder = null;
        } else {
            const pinnedCount = state.inventory.filter(g => g.pinned).length;
            if (pinnedCount >= 6) { tg.showAlert("Max 6 pinned gifts allowed."); return; }
            gift.pinned = true;
            gift.pinOrder = pinnedCount;
        }
        document.getElementById('long-press-menu').classList.add('hidden');
        haptic('light');
        saveState();
        renderInventory();
    }

    function toggleHide() {
        const gift = state.inventory.find(g => g.uniqueId === appRuntime.activeGiftId);
        if (gift) {
            gift.hidden = !gift.hidden;
            if (gift.hidden) gift.pinned = false;
            saveState();
            renderInventory();
            haptic('light');
        }
        document.getElementById('long-press-menu').classList.add('hidden');
    }

    function deleteGift() {
        tg.showConfirm("Permanently delete this gift?", (confirmed) => {
            if(confirmed) {
                state.inventory = state.inventory.filter(g => g.uniqueId !== appRuntime.activeGiftId);
                saveState();
                renderInventory();
                haptic('heavy');
            }
        });
        document.getElementById('long-press-menu').classList.add('hidden');
    }

    // --- Reordering Logic ---
    function startReorderMode() {
        document.getElementById('long-press-menu').classList.add('hidden');
        appRuntime.reordering = true;
        document.getElementById('reorder-controls').classList.remove('hidden');
        document.getElementById('inventory-grid').classList.add('reordering');
        haptic('medium');
        
        const grid = document.getElementById('inventory-grid');
        appRuntime.sortable = new Sortable(grid, {
            animation: 150,
            filter: ':not([data-pinned="true"])', 
            draggable: '[data-pinned="true"]',
            onMove: (evt) => evt.related.hasAttribute('data-pinned')
        });
    }

    function stopReorderMode() {
        appRuntime.reordering = false;
        document.getElementById('reorder-controls').classList.add('hidden');
        document.getElementById('inventory-grid').classList.remove('reordering');
        
        if (appRuntime.sortable) {
            const newOrderIds = appRuntime.sortable.toArray();
            newOrderIds.forEach((id, index) => {
                const gift = state.inventory.find(g => g.uniqueId == id);
                if (gift && gift.pinned) gift.pinOrder = index;
            });
            appRuntime.sortable.destroy();
            saveState();
            renderInventory();
            haptic('light');
        }
    }

    // --- Customization Logic ---
    async function openCustomizeModal() {
        document.getElementById('customize-modal').classList.add('active');
        document.getElementById('cust-parts-container').classList.add('hidden');
        // Hide standard HTML button, setup Main Button
        document.getElementById('btn-create-custom').style.display = 'none';
        tg.MainButton.setText("Create");
        tg.MainButton.disable();
        tg.MainButton.show();
        tg.MainButton.onClick(handleCreateCustom);
        tg.BackButton.show();
        tg.BackButton.onClick(() => closeModal('customize-modal'));
        
        const grid = document.getElementById('cust-base-grid');
        grid.innerHTML = '';
        
        Object.entries(state.giftDefinitions).forEach(([id, name]) => {
            if (['custom_skebob', 'custom_baggin_cat'].includes(id)) return;
            const el = document.createElement('div');
            el.className = 'filter-option';
            el.innerHTML = `<img src="${CDN_BASE}originals/${id}/Original.png"><div class="label">${name}</div>`;
            el.onclick = () => selectBaseForCustom(id, name, el);
            grid.appendChild(el);
        });
    }

    async function selectBaseForCustom(id, name, el) {
        haptic('light');
        document.querySelectorAll('#cust-base-grid .filter-option').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected');

        customizationState.selectedBaseId = id;
        customizationState.selectedBaseName = name;
        customizationState.selectedModel = null; customizationState.selectedBackdrop = null; customizationState.selectedPattern = null;

        if (!customizationState.cachedParts[id]) {
            customizationState.cachedParts[id] = await fetchGiftParts(name);
        }
        const parts = customizationState.cachedParts[id];

        renderPartGrid('cust-model-grid', parts.models, 'model', name);
        renderPartGrid('cust-backdrop-grid', parts.backdrops, 'backdrop', name);
        renderPartGrid('cust-pattern-grid', parts.patterns, 'pattern', name);

        document.getElementById('cust-parts-container').classList.remove('hidden');
        checkCustomReady();
    }

    function renderPartGrid(elementId, items, type, giftName) {
        const grid = document.getElementById(elementId);
        grid.innerHTML = '';
        items.forEach(item => {
            const el = document.createElement('div');
            el.className = 'filter-option';
            let content = '';
            if (type === 'model') {
                const url = `${CDN_BASE}models/${encodeURIComponent(giftName)}/png/${encodeURIComponent(item.name)}.png`;
                content = `<img src="${url}">`;
            } else if (type === 'backdrop') {
                content = `<div class="gradient-square" style="background: radial-gradient(circle, ${item.hex.centerColor}, ${item.hex.edgeColor})"></div>`;
            } else if (type === 'pattern') {
                const url = `${CDN_BASE}patterns/${encodeURIComponent(giftName)}/png/${encodeURIComponent(item.name)}.png`;
                content = `<img src="${url}">`;
            }
            el.innerHTML = `${content}<div class="label">${item.name}</div>`;
            el.onclick = () => {
                haptic('light');
                Array.from(grid.children).forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
                if (type === 'model') customizationState.selectedModel = item;
                if (type === 'backdrop') customizationState.selectedBackdrop = item;
                if (type === 'pattern') customizationState.selectedPattern = item;
                checkCustomReady();
            };
            grid.appendChild(el);
        });
    }

    function checkCustomReady() {
        const { selectedModel, selectedBackdrop, selectedPattern } = customizationState;
        if (selectedModel && selectedBackdrop && selectedPattern) {
            tg.MainButton.enable();
        } else {
            tg.MainButton.disable();
        }
    }

    function handleCreateCustom() {
        const { selectedBaseId, selectedBaseName, selectedModel, selectedBackdrop, selectedPattern } = customizationState;
        state.lastCollectibleNumber++;
        const newGift = {
            uniqueId: Date.now() + Math.random(),
            originalId: selectedBaseId,
            name: selectedBaseName,
            isCollectible: true,
            timestamp: Date.now(),
            pinned: false,
            collectibleNumber: state.lastCollectibleNumber,
            collectibleData: { model: selectedModel, backdrop: selectedBackdrop, pattern: selectedPattern }
        };
        state.inventory.unshift(newGift);
        saveState();
        renderInventory();
        closeModal('customize-modal');
        switchTab('inventory');
        hapticNotify('success');
        setTimeout(() => openCollectibleModal(newGift), 300);
    }

    // --- Modal Logic ---
    function openDetailModal(gift) {
        haptic('light');
        appRuntime.activeGiftId = gift.uniqueId;
        document.getElementById('detail-title').innerText = gift.name;
        document.getElementById('detail-image').src = `${CDN_BASE}originals/${gift.originalId}/Original.png`;
        const lottieContainer = document.getElementById('detail-lottie');
        
        if (state.settings.animations) {
            document.getElementById('detail-image').style.display = 'none';
            lottieContainer.style.display = 'block';
            playLottie('detail-lottie', `${CDN_BASE}originals/${gift.originalId}/Original.json`);
        } else {
            document.getElementById('detail-image').style.display = 'block';
            lottieContainer.style.display = 'none';
        }
        
        document.getElementById('detail-modal').classList.add('active');
        tg.BackButton.show();
        tg.BackButton.onClick(() => closeModal('detail-modal'));
    }

    function openCollectibleModal(gift) {
        haptic('light');
        const cd = gift.collectibleData;
        const modal = document.getElementById('collectible-modal');
        
        document.getElementById('collectible-name').innerText = cd.model.name;
        document.getElementById('collectible-number').innerText = gift.collectibleNumber.toLocaleString();
        
        const displayArea = document.getElementById('collectible-display-area');
        displayArea.style.background = `radial-gradient(circle at 50% 0%, ${cd.backdrop.hex.centerColor} 0%, ${cd.backdrop.hex.edgeColor} 100%)`;
        
        const imgEl = document.getElementById('collectible-image');
        const lotEl = document.getElementById('collectible-lottie');
        
        if (state.settings.animations) {
            imgEl.style.display = 'none';
            lotEl.style.display = 'block';
            playLottie('collectible-lottie', `${CDN_BASE}models/${encodeURIComponent(gift.name)}/lottie/${encodeURIComponent(cd.model.name)}.json`);
        } else {
            lotEl.style.display = 'none';
            imgEl.style.display = 'block';
            imgEl.src = `${CDN_BASE}models/${encodeURIComponent(gift.name)}/png/${encodeURIComponent(cd.model.name)}.png`;
        }
        
        const rarity = (val) => `<span class="rarity-chip">${(val/10).toFixed(1)}%</span>`;
        document.getElementById('info-model').innerHTML = `${cd.model.name} ${rarity(cd.model.rarityPermille)}`;
        document.getElementById('info-backdrop').innerHTML = `${cd.backdrop.name} ${rarity(cd.backdrop.rarityPermille)}`;
        document.getElementById('info-pattern').innerHTML = `${cd.pattern.name} ${rarity(cd.pattern.rarityPermille)}`;

        const container = document.getElementById('collectible-pattern-container');
        container.innerHTML = '';
        generatePattern('collectible-pattern-container', cd.pattern, gift.name, false, cd.backdrop.hex.patternColor);

        modal.classList.add('active');
        tg.BackButton.show();
        tg.BackButton.onClick(() => closeModal('collectible-modal'));
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
        if(id === 'detail-modal') document.getElementById('detail-lottie').innerHTML = '';
        if(id === 'collectible-modal') document.getElementById('collectible-lottie').innerHTML = '';
        
        // Reset TG buttons
        tg.MainButton.hide();
        tg.BackButton.hide();
    }

    function playLottie(containerId, path) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        lottie.loadAnimation({
            container: container,
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: path
        });
    }

    // --- Utils ---
    function switchTab(tab) {
        document.getElementById('profile-page').classList.remove('active');
        document.getElementById('shop-page').classList.remove('active');
        document.querySelectorAll('.profile-tabs button').forEach(b => b.classList.remove('active'));

        if (tab === 'inventory') {
            document.getElementById('profile-page').classList.add('active');
            document.querySelectorAll('.profile-tabs button')[0].classList.add('active');
            tg.BackButton.hide();
        } else {
            document.getElementById('shop-page').classList.add('active');
            document.querySelectorAll('.profile-tabs button')[1].classList.add('active');
            tg.BackButton.show();
            tg.BackButton.onClick(() => switchTab('inventory'));
        }
        haptic('light');
    }

    function generatePattern(containerId, patternObj, giftName, isSmallCard, patternColorHex) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const url = `${CDN_BASE}patterns/${encodeURIComponent(giftName)}/png/${encodeURIComponent(patternObj.name)}.png`;
        const width = container.offsetWidth;
        const height = container.offsetHeight;
        const centerX = width / 2;
        const centerY = isSmallCard ? height / 2 : height * 0.4;

        const configs = [
            { count: 10, radius: isSmallCard ? 38 : 100, size: isSmallCard ? 12 : 36 },
            { count: 12, radius: isSmallCard ? 62 : 150, size: isSmallCard ? 10 : 30 }
        ];

        configs.forEach(conf => {
            for(let i=0; i<conf.count; i++) {
                const angle = (i / conf.count) * 2 * Math.PI;
                const x = centerX + conf.radius * Math.cos(angle);
                const y = centerY + conf.radius * Math.sin(angle);
                
                const el = document.createElement('div');
                el.className = 'card-pattern-symbol';
                el.style.webkitMaskImage = `url('${url}')`;
                el.style.maskImage = `url('${url}')`;
                if (patternColorHex) el.style.backgroundColor = patternColorHex;
                
                el.style.width = `${conf.size}px`;
                el.style.height = `${conf.size}px`;
                el.style.left = `${x - conf.size/2}px`;
                el.style.top = `${y - conf.size/2}px`;
                
                container.appendChild(el);
            }
        });
    }

    // --- Settings & Persistence ---
    function openSettingsModal() {
        document.getElementById('settings-modal').classList.add('active');
        document.getElementById('setting-animations').checked = state.settings.animations;
        document.getElementById('setting-hidden').checked = state.settings.showHidden;
        tg.BackButton.show();
        tg.BackButton.onClick(() => closeModal('settings-modal'));
    }

    function initSettingsUI() { }

    function toggleSetting(key, value) {
        state.settings[key] = value;
        haptic('light');
        saveState();
        renderInventory();
    }

    function saveState() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function loadState() {
        const saved = localStorage.getItem(LS_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            state.inventory = parsed.inventory || [];
            state.lastCollectibleNumber = parsed.lastCollectibleNumber || 100;
            if(parsed.settings) state.settings = parsed.settings;
        }
    }
    function resetAppData() {
        tg.showConfirm("Delete all gifts and reset app?", (confirmed) => {
            if(confirmed) {
                localStorage.removeItem(LS_KEY);
                location.reload();
            }
        });
    }
</script>
</body>
</html>
